<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Bhagavad Gita Bot</title>
      <meta name="description" content="Explore Bhagavad Gita shlokas in Telugu with SGS and Sringeri styles, featuring audio recitations and meanings.">
      <meta name="keywords" content="Bhagavad Gita, SGS, Sringeri, Telugu shlokas, audio recitation, spiritual app">
      <meta name="author" content="Dr. P. Udayabhaskar">
      <meta name="robots" content="index, follow">
      <link rel="canonical" href="https://pubsaroja.github.io/bhagavad-gita-bot/">
      <link href="https://fonts.googleapis.com/css2?family=Ramabhadra&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu&display=swap" rel="stylesheet">
      <style>
         /* Global box-sizing for consistent sizing */
         *, *::before, *::after {
         box-sizing: border-box;
         }
         body {
         font-family: Outfit, sans-serif;    /* Page font */
         text-align: center;                 /* Center page text */
         padding: 20px;                     /* Outer space around content */
         margin: 0;                         /* Remove default margin */
         background-color: #f0f0f0;         /* Light grey background */
         }
         h1 {
         color: #2c3e50;
         font-size: 1.5em;
         }
         h2 {
         color: #34495e;
         font-size: 1em;
         margin-top: 10px;
         }
         /* === TOP BUTTONS CONTAINER === */
         .top-buttons {
         display: flex;
         justify-content: center;
         gap: 10px;
         }
         /* === COMMON BUTTON STYLE === */
         .top-buttons button {
         width: 150px;
         height: 150px;
         border-radius: 25%;
         border: none;
         background-color: #357EC7;
         color: white;
         font-size: 20px;
         cursor: pointer;
         transition: background 0.3s ease;
         background-repeat: no-repeat;
         background-position: center;
         background-size: cover;
         }
         /* === SGS Button Hover/Active === */
         .top-buttons button.sgs-button:hover,
         .top-buttons button.sgs-button:active {
         background-image: url('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/main/sankhu.png');
         background-color: transparent !important;
         color: transparent !important;
         }
         /* === Sringeri Button Hover/Active === */
         .top-buttons button.sringeri-button:hover,
         .top-buttons button.sringeri-button:active {
         background-image: url('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/main/chakra.png');
         background-color: transparent !important;
         color: transparent !important;
         }
         /* === Reset State (after audio ends) === */
         .top-buttons button.reset,
         .top-buttons button.reset:hover,
         .top-buttons button.reset:active,
         .top-buttons button.reset:focus {
         background: #357EC7 !important;   /* solid blue */
         color: white !important;          /* visible text */
         background-image: none !important;/* force remove picture */
         }
         /* == BUTTON GROUPS CONTAINER == */
         .button-groups {
         display: flex;
         justify-content: center;
         gap: 10px;
         max-width: 600px;
         margin: 0 auto;
         width: 100%;
         box-sizing: border-box;
         }
         .button-group {
         display: flex;
         flex-direction: column;
         gap: 10px;
         width: 50%;                       /* Two equal columns */
         }
         /* == OTHER BUTTONS == */
         .button-groups button {
         background-color: #357EC7;
         color: white;
         padding: 10px 18px;
         border: none;
         border-radius: 5px;               /* Different shape for these buttons */
         cursor: pointer;
         font-family: 'Outfit', sans-serif;
         font-size: 1.6em;
         width: 100%;
         max-width: 150px;
         transition: background-color 0.3s ease;
         }
         .button-groups button:hover {
         background-color: #ffffff;
         color: transparent;
         }
         select {
         padding: 10px;
         margin: 5px;
         font-size: 1em;
         border-radius: 5px;
         width: 100%;
         max-width: 150px;
         }
         /* == DROPDOWN CONTAINER == */
         .dropdown-container {
         display: flex;
         flex-direction: column;  /* Stack items vertically */
         gap: 20px;               /* Space between dropdown items */
         max-width: 600px;
         margin: 0 auto;
         border: 2px solid #d1d1d1;/*#357EC7;*/
         border-radius: 5px;
         padding: 10px;
         box-sizing: border-box;
         }
         .dropdown-item {
         display: flex;
         flex-direction: column;  /* Label on top, dropdown below */
         }
         .dropdown-label {
         margin-bottom: 6px;
         font-weight: bold;
         font-size: 1em;
         color: #2c3e50;
         }
         select {
         width: 100%;
         padding: 8px;
         font-size: 1em;
         border-radius: 5px;
         border: 1px solid #ccc;
         }
         /* == SHLOKA TEXT == */
         .shloka-text {
         margin-top: 10px;
         font-size: 1.5em;
         color: #333;
         white-space: pre-wrap;
         max-width: 600px;
         margin-left: auto;
         margin-right: auto;
         line-height: 1.5;
         min-height: 3em;
         overflow-y: auto;
         padding: 10px;
         border: 2px solid #d1d1d1;/*#357EC7;*/
         border-radius: 5px;
         display: none;
         justify-content: center;
         align-items: center;
         text-align: center;
         font-family: 'Noto Sans Telugu', sans-serif;
         }
         .shloka-text.active {
         display: flex;
         }
         .shloka-text.active.multiline {
         display: block;
         text-align: left;
         }
         #audioPlayer {
         margin: 10px auto;
         display: block;
         flex-shrink: 0;
         }
         .radio-group {
         margin: 10px 0;
         display: flex;
         justify-content: center;
         align-items: center;
         gap: 10px;
         }
         .radio-group label {
         margin: 0 10px;
         }
         .textbox-container {
         display: flex;
         flex-direction: column;
         align-items: center;
         gap: 10px;
         }
         .textbox-container > div {
         width: 100%;
         max-width: 600px;
         }
         .textbox-label {
         font-weight: bold;
         margin-bottom: 5px;
         display: none;
         }
         .textbox-label.active {
         display: block;
         }
         /* == MODAL == */
         .modal {
         display: none;
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background-color: rgba(0, 0, 0, 0.5);
         justify-content: center;
         align-items: center;
         z-index: 1000;
         }
         .modal-content {
         background-color: #fff;
         padding: 20px;
         border-radius: 5px;
         max-width: 80%;
         max-height: 80%;
         overflow-y: auto;
         border: 2px solid #357EC7;
         }
         .chapter-select {
         margin-bottom: 10px;
         padding: 10px;
         font-size: 1em;
         border-radius: 5px;
         width: 100%;
         max-width: 200px;
         }
         /* == VERSE GRID == */
         .verse-grid {
         display: grid;
         grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
         gap: 10px;
         padding: 10px;
         }
         .verse-button {
         background-color: #f9f9f9;
         border: 1px solid #357EC7;
         border-radius: 5px;
         padding: 10px;
         text-align: center;
         cursor: pointer;
         font-size: 0.9em;
         }
         .verse-button:hover {
         background-color: #e0e0e0;
         }
         .close-button {
         background-color: #ff4444;
         color: white;
         padding: 5px 10px;
         border: none;
         border-radius: 5px;
         cursor: pointer;
         float: right;
         }
         .close-button:hover {
         background-color: #cc0000;
         }
         .credits {
         font-size: 0.9em;
         color: #000;
         margin-top: 10px;
         }
         /* == RESPONSIVE MOBILE STYLES (≤600px) == */
         @media (max-width: 600px) {
         /* Containers respect body padding with internal padding */
         .top-buttons,
         .button-groups,
         .dropdown-container {
         width: 100%;
         max-width: 600px;
         margin: 0 auto;
         padding-left: 10px;       /* Padding inside to avoid edge contact */
         padding-right: 10px;
         box-sizing: border-box;
         flex-wrap: wrap;          /* Allow wrapping if needed */
         }
         .top-buttons {
         gap: 5px;
         flex-direction: row;
         }
         .button-groups {
         gap: 5px;
         flex-direction: row;
         }
         .button-group {
         width: 50%;
         gap: 5px;
         }
         .top-buttons button {
         width: 140px;
         height: 140px;
         }
         .button-groups button {
         padding: 6px 12px;
         font-size: 1.2em;
         max-width: 150px;
         }
         }
         /* == PLAYER CONTAINER == */
         .player-container {
         display: grid;
         grid-template-columns: repeat(3, max-content); /* 3 columns sized to button content */
         grid-template-rows: repeat(2, auto);           /* 2 rows */
         gap: 10px 5px;                                 /* row-gap and column-gap */
         justify-content: center;                       /* center entire grid horizontally */
         justify-items: center;                         /* center buttons horizontally inside cells */
         align-items: center;                           /* vertical center alignment */
         max-width: 600px;
         margin: 20px auto 0;
         width: 100%;
         box-sizing: border-box;
         border: 2px solid #ffffff/*#357EC7;*/
         border-radius: 5px;
         padding: 10px;
         }
         .player-container button {
         width: 100px;               /* restore fixed button width */
         height: 40px;               /* fixed height */
         border: none;
         border-radius: 25px;        /* pill shape */
         background-color: #357EC7;
         color: white;
         font-family: 'Outfit', sans-serif;
         font-size: 16px;
         cursor: pointer;
         padding: 0 15px;            /* add horizontal padding */
         transition: background 0.3s ease;
         justify-self: center;       /* center button horizontally inside grid cell */
         align-self: center;         /* center vertically */
         }
         .player-container button:hover {
         background-color: #1e40af;
         }
      </style>
   </head>
   <body>
      <h1>Srimad Bhagavad Gita</h1>
      <p>Listen, understand and memorize Bhagavad Gita shlokas</p>
      <div class="top-buttons">
         <button class="sgs-button" onclick="sendCommand('SGSFirstPaada')">SGS<br>(1st Paada)</button>
         <button class="sringeri-button" onclick="sendCommand('SringeriPaada')">Sringeri<br>(1st or 3rd Paada)</button>
      </div>
      <audio id="audioPlayer" controls></audio>
      <div class="radio-group">
         <label>Style:</label>
         <input type="radio" name="style" value="sgs" id="sgs" onchange="updateTextboxVisibility()">
         <label for="sgs">SGS</label>
         <input type="radio" name="style" value="sringeri" id="sringeri" checked onchange="updateTextboxVisibility()">
         <label for="sringeri">Sringeri</label>
      </div>
      <div class="player-container">
         <button onclick="sendCommand('PreviousShloka')">Previous</button>
         <button onclick="sendCommand('FullShloka')">Full</button>
         <button onclick="sendCommand('NextFullShloka')">Next</button>
      </div>
      <div class="textbox-container">
         <div>
            <div id="sgsLabel" class="textbox-label">SGS Style Shloka</div>
            <div id="sgsText" class="shloka-text">Your Shloka will appear here.</div>
         </div>
         <div>
            <div id="sringeriLabel" class="textbox-label active">Sringeri Style Shloka</div>
            <div id="sringeriText" class="shloka-text active">Your Shloka will appear here.</div>
         </div>
      </div>
      <div class="player-container">
         <button id="meaningsButton" onclick="handleMeanings()">Meanings</button>
         <button onclick="showVerseTable()">Selector</button>
         <button id="instructionsButton" onclick="toggleInstructions()">Instructions</button>

      </div>
      <br>
      <div class="dropdown-container">
         <div>
            <label for="chapterSelect" 
               style="display:block; font-family:Outfit, sans-serif; font-size:1.1em;">
            Random Shloka Chapterwise:
            </label>
            <select id="chapterSelect" onchange="handleChapterSelect(this)">
               <option value="" selected disabled>Select Chapter</option>
               <option value="1">1. అర్జునవిషాదయోగః</option>
               <option value="2">2. సాఙ్ఖ్యయోగః</option>
               <option value="3">3. కర్మయోగః</option>
               <option value="4">4. జ్ఞానయోగః</option>
               <option value="5">5. కర్మసన్న్యాసయోగః</option>
               <option value="6">6. ఆత్మసంయమయోగః</option>
               <option value="7">7. జ్ఞానవిజ్ఞానయోగః</option>
               <option value="8">8. అక్షరపరబ్రహ్మయోగః</option>
               <option value="9">9. రాజవిద్యారాజగుహ్యయోగః</option>
               <option value="10">10. విభూతియోగః</option>
               <option value="11">11. విశ్వరూపసన్దర్శనయోగః</option>
               <option value="12">12. భక్తియోగః</option>
               <option value="13">13. క్షేత్రక్షేత్రజ్ఞవిభాగయోగః</option>
               <option value="14">14. గుణత్రయవిభాగయోగః</option>
               <option value="15">15. పురుషోత్తమప్రాప్తియోగః</option>
               <option value="16">16. దైవాసురసమ్పద్విభాగయోగః</option>
               <option value="17">17. శ్రద్ధాత్రయవిభాగయోగః</option>
               <option value="18">18. మోక్షసన్న్యాసయోగః</option>
            </select>
         </div>
         <div>
            <label for="chapterSelect" style="display:block; font-family:Outfit, sans-serif; font-size:1.1em;">Continuous Play:</label>
            <select id="continuousPlaySelect" onchange="handleContinuousPlay(this)">
               <option value="" selected disabled>Select Chapter</option>
               <option value="1">1. అర్జునవిషాదయోగః</option>
               <option value="2">2. సాఙ్ఖ్యయోగః</option>
               <option value="3">3. కర్మయోగః</option>
               <option value="4">4. జ్ఞానయోగః</option>
               <option value="5">5. కర్మసన్న్యాసయోగః</option>
               <option value="6">6. ఆత్మసంయమయోగః</option>
               <option value="7">7. జ్ఞానవిజ్ఞానయోగః</option>
               <option value="8">8. అక్షరపరబ్రహ్మయోగః</option>
               <option value="9">9. రాజవిద్యారాజగుహ్యయోగః</option>
               <option value="10">10. విభూతియోగః</option>
               <option value="11">11. విశ్వరూపసన్దర్శనయోగః</option>
               <option value="12">12. భక్తియోగః</option>
               <option value="13">13. క్షేత్రక్షేత్రజ్ఞవిభాగయోగః</option>
               <option value="14">14. గుణత్రయవిభాగయోగః</option>
               <option value="15">15. పురుషోత్తమప్రాప్తియోగః</option>
               <option value="16">16. దైవాసురసమ్పద్విభాగయోగః</option>
               <option value="17">17. శ్రద్ధాత్రయవిభాగయోగః</option>
               <option value="18">18. మోక్షసన్న్యాసయోగః</option>
            </select>
         </div>
      </div>
      </div>
          <div>
        <h3>Search for word (Telugu or English):</h3>
        <input type="text" id="search-input" placeholder="Enter word to search">
        <button id="search-button">Search</button>
    </div>
      <div class="credits">
         SGS Audio:<br>
         Pujya Sri Datta Vijayanand Teertha Swamiji<br>
         Sringeri Audio courtesy:<br>
         Smt Mathangi Kailasnath<br>
         Developed by<br>
         Dr. P. Udayabhaskar
      </div>
      <div id="verseTableModal" class="modal">
      <div class="modal-content">
         <button class="close-button" onclick="closeVerseTable()">Close</button>
         <select id="chapterTableSelect" class="chapter-select" onchange="updateVerseGrid()">
            <option value="" selected disabled>-- Select Chapter --</option>
            <option value="1">Chapter 1 (47 verses)</option>
            <option value="2">Chapter 2 (72 verses)</option>
            <option value="3">Chapter 3 (43 verses)</option>
            <option value="4">Chapter 4 (42 verses)</option>
            <option value="5">Chapter 5 (29 verses)</option>
            <option value="6">Chapter 6 (47 verses)</option>
            <option value="7">Chapter 7 (30 verses)</option>
            <option value="8">Chapter 8 (28 verses)</option>
            <option value="9">Chapter 9 (34 verses)</option>
            <option value="10">Chapter 10 (42 verses)</option>
            <option value="11">Chapter 11 (55 verses)</option>
            <option value="12">Chapter 12 (20 verses)</option>
            <option value="13">Chapter 13 (34 verses)</option>
            <option value="14">Chapter 14 (27 verses)</option>
            <option value="15">Chapter 15 (20 verses)</option>
            <option value="16">Chapter 16 (24 verses)</option>
            <option value="17">Chapter 17 (28 verses)</option>
            <option value="18">Chapter 18 (78 verses)</option>
         </select>
         <div id="verseTableContent" class="verse-grid"></div>
      </div>
      <script>


// Global variables holding text file contents
let sringeriContent = '';
let sgsContent = '';
let englishContent = '';
let selectedStyle = 'sringeri'; // Default to Sringeri Style

// Load text files asynchronously from GitHub raw URLs
async function loadFiles() {
    try {
        const sringeriResponse = await fetch('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_Sringeri.txt');
        if (!sringeriResponse.ok) throw new Error('Failed to load BG_Sringeri.txt');
        sringeriContent = await sringeriResponse.text();
        console.log('Sringeri file loaded, first 5 lines:', sringeriContent.split('\n').slice(0, 5));

        const sgsResponse = await fetch('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG Telugu with Uvacha2.txt');
        if (!sgsResponse.ok) throw new Error('Failed to load BG Telugu with Uvacha.txt');
        sgsContent = await sgsResponse.text();
        console.log('SGS file loaded, first 5 lines:', sgsContent.split('\n').slice(0, 5));
        // Check for lipyate in sgsContent
        console.log('SGS file contains లిప్యతే:', sgsContent.includes('లిప్యతే'));

        const englishResponse = await fetch('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_English_single_line.txt');
        if (!englishResponse.ok) throw new Error('Failed to load BG_English_single_line.txt');
        englishContent = await englishResponse.text();
        console.log('English file loaded, first 5 lines:', englishContent.split('\n').slice(0, 5));

        console.log('Files loaded:', {
            sringeriLines: sringeriContent.split('\n').length,
            sgsLines: sgsContent.split('\n').length,
            englishLines: englishContent.split('\n').length
        });
    } catch (err) {
        alert(err.message);
        console.error(err);
    }
}

// Highlight matched words in output with red text
function highlightText(text, searchTerm, isShlokaNumberSearch = false) {
    if (!searchTerm) return text;
    if (isShlokaNumberSearch) {
        return text;
    }
    const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(`(${escapedTerm})`, 'gi');
    const highlighted = text.replace(regex, `<span style="color: red;">$1</span>`);
    console.log('Highlighted text:', highlighted);
    return highlighted;
}

// Apply CSS to ensure vertical stacking
function applyOutputStyles() {
    const sgsOutput = document.getElementById('sgsText');
    const sringeriOutput = document.getElementById('sringeriText');
    [sgsOutput, sringeriOutput].forEach(el => {
        if (el) {
            el.style.whiteSpace = 'pre-wrap';
            el.style.lineHeight = '1.5';
            console.log('Applied styles to', el.id, ':', {
                whiteSpace: el.style.whiteSpace,
                lineHeight: el.style.lineHeight,
                hasActiveClass: el.classList.contains('active'),
                hasMultilineClass: el.classList.contains('multiline')
            });
        }
    });
}

// Search function to handle Telugu, English, and shloka number searches
async function performSearch() {
    const searchInput = document.getElementById('search-input').value.trim();
    const sgsOutput = document.getElementById('sgsText');
    const sringeriOutput = document.getElementById('sringeriText');

    if (!sgsOutput || !sringeriOutput) {
        alert('Output display elements missing');
        return;
    }

    // Clear previous results and classes
    sgsOutput.innerHTML = '';
    sringeriOutput.innerHTML = '';
    sgsOutput.classList.remove('multiline');
    sringeriOutput.classList.remove('multiline');

    applyOutputStyles();

    if (!searchInput) {
        const errorMessage = 'Please enter a search term.';
        if (selectedStyle === 'sgs') {
            sgsOutput.innerHTML = errorMessage;
            sgsOutput.classList.add('multiline'); // For left-aligned error
            console.log('Output set to sgsText:', errorMessage);
        } else {
            sringeriOutput.innerHTML = errorMessage;
            sringeriOutput.classList.add('multiline');
            console.log('Output set to sringeriText:', errorMessage);
        }
        console.log('No search input provided');
        return;
    }

    if (!sringeriContent || !sgsContent || !englishContent) {
        const errorMessage = 'Text files not loaded. Please try again.';
        if (selectedStyle === 'sgs') {
            sgsOutput.innerHTML = errorMessage;
            sgsOutput.classList.add('multiline');
            console.log('Output set to sgsText:', errorMessage);
        } else {
            sringeriOutput.innerHTML = errorMessage;
            sringeriOutput.classList.add('multiline');
            console.log('Output set to sringeriText:', errorMessage);
        }
        console.log('Files not loaded:', {
            sringeriContent: !!sringeriContent,
            sgsContent: !!sgsContent,
            englishContent: !!englishContent
        });
        return;
    }

    console.log('Searching for:', searchInput, 'Style:', selectedStyle);

    const teluguContent = selectedStyle === 'sgs' ? sgsContent : sringeriContent;
    const teluguLines = teluguContent.replace(/\r\n/g, '\n').split('\n').map(line => line.trim());
    const englishLines = englishContent.replace(/\r\n/g, '\n').split('\n').map(line => line.trim());

    const shlokaNumberPattern = /^\d+\.\d+\s*$/;
    if (shlokaNumberPattern.test(searchInput)) {
        let found = false;
        let fullShloka = [];

        for (let i = 0; i < teluguLines.length; i++) {
            const line = teluguLines[i];
            const normalizedLineStart = line.split(/[\s\t]+/)[0];
            if (normalizedLineStart === searchInput) {
                fullShloka.push(line);
                found = true;
                for (let j = i + 1; j < teluguLines.length; j++) {
                    const nextLine = teluguLines[j];
                    if (!nextLine || nextLine.match(shlokaNumberPattern)) {
                        break;
                    }
                    fullShloka.push(nextLine);
                }
                break;
            }
        }

        if (found) {
            const highlighted = fullShloka.map(line => highlightText(line, searchInput, true)).join('<br>');
            if (selectedStyle === 'sgs') {
                sgsOutput.innerHTML = highlighted;
                sgsOutput.classList.add('multiline');
                console.log('Output set to sgsText:', highlighted);
            } else {
                sringeriOutput.innerHTML = highlighted;
                sringeriOutput.classList.add('multiline');
                console.log('Output set to sringeriText:', highlighted);
            }
            console.log('Shloka found:', fullShloka);
        } else {
            const errorMessage = `Shloka ${searchInput} not found.`;
            if (selectedStyle === 'sgs') {
                sgsOutput.innerHTML = errorMessage;
                sgsOutput.classList.add('multiline');
                console.log('Output set to sgsText:', errorMessage);
            } else {
                sringeriOutput.innerHTML = errorMessage;
                sringeriOutput.classList.add('multiline');
                console.log('Output set to sringeriText:', errorMessage);
            }
            console.log('Shloka not found:', searchInput);
        }
    } else {
        const normalizedSearchInput = searchInput.replace(/\s+/g, ' ').trim().normalize('NFC');
        const teluguPattern = /[\u0C00-\u0C7F]/;
        if (teluguPattern.test(normalizedSearchInput)) {
            const results = [];
            let currentShloka = [];
            let currentShlokaNumber = null;

            const debugShlokas = ['1.1', '1.2', '1.4', '5.7', '5.10'];
            const debugContent = [];
            const detectedNumbers = [];

            for (let i = 0; i < teluguLines.length; i++) {
                const line = teluguLines[i];
                const normalizedLine = line.replace(/\s+/g, ' ').trim().normalize('NFC');
                const lineStart = line.split(/[\s\t]+/)[0];
                if (lineStart.match(shlokaNumberPattern)) {
                    detectedNumbers.push(lineStart);
                    if (currentShloka.length > 0) {
                        const shlokaText = currentShloka.join(' ').replace(/\s+/g, ' ').trim().normalize('NFC');
                        const regex = new RegExp(normalizedSearchInput.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                        if (regex.test(shlokaText)) {
                            results.push(currentShloka.map(line => highlightText(line, normalizedSearchInput)).join('<br>'));
                            console.log('Telugu match found for shloka:', currentShlokaNumber, currentShloka);
                        }
                        if (debugShlokas.includes(currentShlokaNumber)) {
                            debugContent.push({ number: currentShlokaNumber, text: currentShloka });
                        }
                    }
                    currentShloka = [line];
                    currentShlokaNumber = lineStart;
                } else if (currentShloka.length > 0 && line) {
                    currentShloka.push(line);
                } else if (currentShloka.length > 0) {
                    const shlokaText = currentShloka.join(' ').replace(/\s+/g, ' ').trim().normalize('NFC');
                    const regex = new RegExp(normalizedSearchInput.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    if (regex.test(shlokaText)) {
                        results.push(currentShloka.map(line => highlightText(line, normalizedSearchInput)).join('<br>'));
                        console.log('Telugu match found for shloka:', currentShlokaNumber, currentShloka);
                    }
                    if (debugShlokas.includes(currentShlokaNumber)) {
                        debugContent.push({ number: currentShlokaNumber, text: currentShloka });
                    }
                    currentShloka = [];
                    currentShlokaNumber = null;
                }
            }
            if (currentShloka.length > 0) {
                const shlokaText = currentShloka.join(' ').replace(/\s+/g, ' ').trim().normalize('NFC');
                const regex = new RegExp(normalizedSearchInput.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                if (regex.test(shlokaText)) {
                    results.push(currentShloka.map(line => highlightText(line, normalizedSearchInput)).join('<br>'));
                    console.log('Telugu match found for last shloka:', currentShlokaNumber, currentShloka);
                }
                if (debugShlokas.includes(currentShlokaNumber)) {
                    debugContent.push({ number: currentShlokaNumber, text: currentShloka });
                }
            }

            console.log('Detected shloka numbers in Telugu file:', detectedNumbers.slice(0, 10));
            console.log('Debug shlokas (1.1, 1.2, 1.4, 5.7, 5.10) in Telugu file:', debugContent);

            if (results.length > 0) {
                const resultText = results.join('<br><br>');
                if (selectedStyle === 'sgs') {
                    sgsOutput.innerHTML = resultText;
                    sgsOutput.classList.add('multiline');
                    console.log('Output set to sgsText:', resultText);
                } else {
                    sringeriOutput.innerHTML = resultText;
                    sringeriOutput.classList.add('multiline');
                    console.log('Output set to sringeriText:', resultText);
                }
                console.log('Telugu search results:', results);
                console.log('First few lines of Telugu file:', teluguLines.slice(0, 5));
            } else {
                const errorMessage = `No shlokas found containing "${searchInput}".`;
                if (selectedStyle === 'sgs') {
                    sgsOutput.innerHTML = errorMessage;
                    sgsOutput.classList.add('multiline');
                    console.log('Output set to sgsText:', errorMessage);
                } else {
                    sringeriOutput.innerHTML = errorMessage;
                    sringeriOutput.classList.add('multiline');
                    console.log('Output set to sringeriText:', errorMessage);
                }
                console.log('No Telugu results for:', searchInput);
                console.log('First few lines of Telugu file:', teluguLines.slice(0, 5));
            }
        } else {
            const matchingShlokaNumbers = [];
            const termMapping = {
                'lipyate': 'లిప్యతే',
                'tatra': 'తత్ర',
                'sanjaya': 'సంజయ'
            };
            const highlightTerm = termMapping[normalizedSearchInput.toLowerCase()] || normalizedSearchInput;

            for (let i = 0; i < englishLines.length; i++) {
                const line = englishLines[i];
                const normalizedLine = line.replace(/\s+/g, ' ').trim().normalize('NFC');
                const regex = new RegExp(normalizedSearchInput.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                if (regex.test(normalizedLine)) {
                    const shlokaNumber = line.split(/[\s\t]+/)[0];
                    if (shlokaNumber.match(shlokaNumberPattern)) {
                        matchingShlokaNumbers.push(shlokaNumber);
                    }
                }
            }
            console.log('English matching shloka numbers:', matchingShlokaNumbers);
            console.log('First few lines of BG_English_single_line.txt:', englishLines.slice(0, 5));

            const results = [];
            let currentShloka = [];
            let currentShlokaNumber = null;

            const debugShlokas = ['1.1', '1.2', '1.4', '5.7', '5.10'];
            const debugContent = [];
            const detectedNumbers = [];

            for (let i = 0; i < teluguLines.length; i++) {
                const line = teluguLines[i];
                const normalizedLineStart = line.split(/[\s\t]+/)[0];
                if (normalizedLineStart.match(shlokaNumberPattern)) {
                    detectedNumbers.push(normalizedLineStart);
                    if (currentShloka.length > 0 && matchingShlokaNumbers.includes(currentShlokaNumber)) {
                        results.push(currentShloka.map(line => highlightText(line, highlightTerm)).join('<br>'));
                        console.log('English match found for shloka:', currentShlokaNumber, currentShloka);
                    } else if (currentShloka.length > 0 && !matchingShlokaNumbers.includes(currentShlokaNumber)) {
                        console.log('No match in Telugu file for shloka number:', currentShlokaNumber);
                    }
                    if (debugShlokas.includes(normalizedLineStart)) {
                        debugContent.push({ number: normalizedLineStart, text: [line] });
                    }
                    currentShloka = [line];
                    currentShlokaNumber = normalizedLineStart;
                } else if (currentShloka.length > 0 && line) {
                    currentShloka.push(line);
                    if (debugShlokas.includes(currentShlokaNumber)) {
                        debugContent[debugContent.length - 1].text.push(line);
                    }
                } else if (currentShloka.length > 0) {
                    if (matchingShlokaNumbers.includes(currentShlokaNumber)) {
                        results.push(currentShloka.map(line => highlightText(line, highlightTerm)).join('<br>'));
                        console.log('English match found for shloka:', currentShlokaNumber, currentShloka);
                    } else if (!matchingShlokaNumbers.includes(currentShlokaNumber)) {
                        console.log('No match in Telugu file for shloka number:', currentShlokaNumber);
                    }
                    currentShloka = [];
                    currentShlokaNumber = null;
                }
            }
            if (currentShloka.length > 0 && matchingShlokaNumbers.includes(currentShlokaNumber)) {
                results.push(currentShloka.map(line => highlightText(line, highlightTerm)).join('<br>'));
                console.log('English match found for last shloka:', currentShlokaNumber, currentShloka);
            } else if (currentShloka.length > 0 && !matchingShlokaNumbers.includes(currentShlokaNumber)) {
                console.log('No match in Telugu file for last shloka number:', currentShlokaNumber);
            }

            console.log('Detected shloka numbers in Telugu file:', detectedNumbers.slice(0, 10));
            console.log('Debug shlokas (1.1, 1.2, 1.4, 5.7, 5.10) in Telugu file:', debugContent);

            if (results.length > 0) {
                results.sort((a, b) => {
                    const [aChapter, aVerse] = a.split(/[\s\t]+/)[0].trim().split('.').map(Number);
                    const [bChapter, bVerse] = b.split(/[\s\t]+/)[0].trim().split('.').map(Number);
                    return aChapter === bChapter ? aVerse - bVerse : aChapter - bChapter;
                });
                const resultText = results.join('<br><br>');
                if (selectedStyle === 'sgs') {
                    sgsOutput.innerHTML = resultText;
                    sgsOutput.classList.add('multiline');
                    console.log('Output set to sgsText:', resultText);
                } else {
                    sringeriOutput.innerHTML = resultText;
                    sringeriOutput.classList.add('multiline');
                    console.log('Output set to sringeriText:', resultText);
                }
                console.log('English search results:', results);
            } else {
                const errorMessage = `No shlokas found for "${searchInput}".`;
                if (selectedStyle === 'sgs') {
                    sgsOutput.innerHTML = errorMessage;
                    sgsOutput.classList.add('multiline');
                    console.log('Output set to sgsText:', errorMessage);
                } else {
                    sringeriOutput.innerHTML = errorMessage;
                    sringeriOutput.classList.add('multiline');
                    console.log('Output set to sringeriText:', errorMessage);
                }
                console.log('No English results for:', searchInput);
            }
        }
    }

    const activeOutput = selectedStyle === 'sgs' ? sgsOutput : sringeriOutput;
    activeOutput.style.height = 'auto';
    activeOutput.style.height = `${activeOutput.scrollHeight}px`;
}

// Add event listeners for style selection
function setupStyleListeners() {
    const sgsLabel = document.getElementById('sgsLabel');
    const sringeriLabel = document.getElementById('sringeriLabel');
    const sgsOutput = document.getElementById('sgsText');
    const sringeriOutput = document.getElementById('sringeriText');

    if (sgsLabel && sgsOutput) {
        sgsLabel.addEventListener('click', () => {
            selectedStyle = 'sgs';
            sgsLabel.classList.add('active');
            sgsOutput.classList.add('active');
            sringeriLabel.classList.remove('active');
            sringeriOutput.classList.remove('active');
            console.log('Style switched to SGS, sgsText active:', sgsOutput.classList.contains('active'));
            performSearch();
        });
    }
    if (sringeriLabel && sringeriOutput) {
        sringeriLabel.addEventListener('click', () => {
            selectedStyle = 'sringeri';
            sringeriLabel.classList.add('active');
            sringeriOutput.classList.add('active');
            sgsLabel.classList.remove('active');
            sgsOutput.classList.remove('active');
            console.log('Style switched to Sringeri, sringeriText active:', sringeriOutput.classList.contains('active'));
            performSearch();
        });
    }
}

// Add event listener to the search button
document.getElementById('search-button').addEventListener('click', performSearch);

// Add enter key support for search
document.getElementById('search-input').addEventListener('keypress', (event) => {
    if (event.key === 'Enter') {
        performSearch();
    }
});

// Apply styles and load files on page load
document.addEventListener('DOMContentLoaded', () => {
    loadFiles();
    applyOutputStyles();
    setupStyleListeners();
});




         
         
                  console.log('Script loaded at', new Date('2025-08-17T12:18:00+05:30').toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }));
                  
                  const baseUrl = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main';
                  const verseCounts = {
                      1: 47, 2: 72, 3: 43, 4: 42, 5: 29, 6: 47, 7: 30, 8: 28,
                      9: 34, 10: 42, 11: 55, 12: 20, 13: 34, 14: 27, 15: 20,
                      16: 24, 17: 28, 18: 78
                  };
                  
                  let isContinuousPlaying = false;
                  let continuousPlayInterval = null;
                  let isInstructionsVisible = false;
                  let previousText = '';
                  let isShowingMeanings = false;
                  let sessionId = 'session-' + Math.random().toString(36).substr(2, 9);
                  let currentContext = [];
                  
                  function initialize() {
                      try {
                          console.log('Initializing Bhagavad Gita Bot');
                          localStorage.removeItem('gitaSessionId');
                          localStorage.removeItem('gitaContext');
                          console.log('Cleared localStorage (gitaSessionId, gitaContext)');
                          localStorage.setItem('gitaSessionId', sessionId);
                          adjustTextboxHeight();
                          updateTextboxVisibility();
                      } catch (error) {
                          console.error('Initialization error:', error);
                      }
                  }
                  
                  function toggleInstructions() {
                      try {
                          console.log('toggleInstructions called');
                          isContinuousPlaying = false;
                          const instructionsButton = document.getElementById('instructionsButton');
                          const style = getSelectedStyle();
                          const activeTextbox = style === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                          
                          if (!isInstructionsVisible) {
                              previousText = activeTextbox.innerText;
                              fetch('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/instructions.txt')
                                  .then(response => {
                                      if (!response.ok) throw new Error('Failed to fetch instructions');
                                      return response.text();
                                  })
                                  .then(text => {
                                      activeTextbox.innerHTML = text.replace(/\n/g, '<br>');
                                      instructionsButton.textContent = 'Close Instructions';
                                      isInstructionsVisible = true;
                                      adjustTextboxHeight();
                                      updateTextboxVisibility();
                                  })
                                  .catch(error => {
                                      console.error('Error fetching instructions:', error);
                                      activeTextbox.innerText = `Error loading instructions: ${error.message}`;
                                      adjustTextboxHeight();
                                      updateTextboxVisibility();
                                  });
                          } else {
                              activeTextbox.innerText = previousText || 'Your Shloka will appear here.';
                              instructionsButton.textContent = 'Instructions';
                              isInstructionsVisible = false;
                              adjustTextboxHeight();
                              updateTextboxVisibility();
                          }
                      } catch (error) {
                          console.error('Error in toggleInstructions:', error);
                          const activeTextbox = getSelectedStyle() === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                          activeTextbox.innerText = `Error in instructions: ${error.message}`;
                          adjustTextboxHeight();
                      }
                  }
                  
                  function adjustTextboxHeight() {
                      try {
                          console.log('adjustTextboxHeight called');
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          [sgsText, sringeriText].forEach(textbox => {
                              textbox.style.height = 'auto';
                              const scrollHeight = textbox.scrollHeight;
                              textbox.style.height = `${scrollHeight}px`;
                              if (textbox.innerText.includes('\n') || textbox.innerHTML.includes('<br>')) {
                                  textbox.classList.add('multiline');
                              } else {
                                  textbox.classList.remove('multiline');
                              }
                              console.log(`adjustTextboxHeight: ${textbox.id}, scrollHeight: ${scrollHeight}px, multiline: ${textbox.classList.contains('multiline')}`);
                          });
                      } catch (error) {
                          console.error('Error in adjustTextboxHeight:', error);
                      }
                  }
                  
                  async function fetchAudioUrl(chapter, verse, quarter = null, isFullForQuarter = false) {
                      try {
                          console.log(`fetchAudioUrl called: chapter=${chapter}, verse=${verse}, quarter=${quarter}, isFullForQuarter=${isFullForQuarter}`);
                          const style = getSelectedStyle();
                          const key = `${chapter}.${verse}`;
                          let audioUrl;
                          let errorMessage = '';
                  
                          const tryUrl = async (url, type) => {
                              try {
                                  console.log(`fetchAudioUrl: Attempting ${type}: ${url}`);
                                  const response = await fetch(url, { method: 'HEAD', mode: 'cors' });
                                  if (!response.ok) {
                                      throw new Error(`${type} inaccessible: HTTP ${response.status}`);
                                  }
                                  console.log(`fetchAudioUrl: Successfully fetched ${type}: ${url}`);
                                  return url;
                              } catch (error) {
                                  console.log(`fetchAudioUrl: Error for ${type}: ${error.message}`);
                                  return null;
                              }
                          };
                  
                          if (isFullForQuarter) {
                              audioUrl = style === 'sringeri' 
                                  ? await tryUrl(`${baseUrl}/AudioFullSringeri/${key}.mp3`, `AudioFullSringeri/${key}.mp3`)
                                  : await tryUrl(`${baseUrl}/AudioFullSGS/${key}.mp3`, `AudioFullSGS/${key}.mp3`);
                              if (!audioUrl) {
                                  errorMessage = `Full audio not found in ${style === 'sringeri' ? 'AudioFullSringeri' : 'AudioFullSGS'} for ${key}`;
                              }
                          } else if (quarter === 'pada1') {
                              audioUrl = await tryUrl(`${baseUrl}/AQ4PaadasSGS/Chapter ${chapter}/${verse}.1.mp3`, `AQ4PaadasSGS/Chapter ${chapter}/${verse}.1.mp3`);
                              if (!audioUrl) {
                                  errorMessage = `Audio (Pada1) not found at AQ4PaadasSGS/Chapter ${chapter}/${verse}.1.mp3`;
                              }
                          } else if (quarter === 'pada1_or_pada3') {
                              const folder = style === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
                              const randomPada = Math.random() < 0.5 ? '1' : '3';
                              audioUrl = await tryUrl(`${baseUrl}/${folder}/Chapter ${chapter}/${verse}.${randomPada}.mp3`, `${folder}/Chapter ${chapter}/${verse}.${randomPada}.mp3`);
                              if (!audioUrl) {
                                  audioUrl = await tryUrl(`${baseUrl}/${folder}/Chapter ${chapter}/${verse}.${randomPada === '1' ? '3' : '1'}.mp3`, `${folder}/Chapter ${chapter}/${verse}.${randomPada === '1' ? '3' : '1'}.mp3`);
                              }
                              if (!audioUrl) {
                                  errorMessage = `Quarter audio (Pada1 or Pada3) not found in ${folder}/Chapter ${chapter} for ${key}`;
                              }
                          } else {
                              audioUrl = style === 'sringeri' 
                                  ? await tryUrl(`${baseUrl}/AudioFullSringeri/${key}.mp3`, `AudioFullSringeri/${key}.mp3`)
                                  : await tryUrl(`${baseUrl}/AudioFullSGS/${key}.mp3`, `AudioFullSGS/${key}.mp3`);
                              if (!audioUrl) {
                                  errorMessage = `Full audio not found in ${style === 'sringeri' ? 'AudioFullSringeri' : 'AudioFullSGS'} for ${key}`;
                              }
                          }
                  
                          if (!audioUrl) {
                              throw new Error(errorMessage || `No audio available for ${key}`);
                          }
                  
                          console.log(`fetchAudioUrl: Using audio for ${key}: ${audioUrl}`);
                          return audioUrl;
                      } catch (error) {
                          console.error(`fetchAudioUrl: Error for ${chapter}.${verse}: ${error.message}`);
                          return { error: `No audio available for ${chapter}.${verse}: ${error.message}` };
                      }
                  }
                  
                  async function fetchShlokaText(chapter, verse, style) {
                      try {
                          console.log(`fetchShlokaText called: chapter=${chapter}, verse=${verse}, style=${style}`);
                          const url = style === 'sgs'
                              ? 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG Telugu with Uvacha2.txt'
                              : 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_Sringeri.txt';
                          const response = await fetch(url);
                          if (!response.ok) {
                              throw new Error(`HTTP error: ${response.status}`);
                          }
                          const text = await response.text();
                          
                          const lines = text.split('\n');
                          const key1 = `${chapter}.${verse}`;
                          const key2 = `${chapter}-${verse}`;
                          
                          for (let i = 0; i < lines.length; i++) {
                              const line = lines[i].trim();
                              if (line.match(new RegExp(`^${key1}\\s+|^${key2}\\s+|^${key1}\\t|^${key2}\\t|^${key1}$|^${key2}$`))) {
                                  let shlokaLines = [line.substring(line.indexOf(' ') + 1 || line.indexOf('\t') + 1 || line.length).trim()];
                                  let j = i + 1;
                                  while (j < lines.length && !lines[j].match(/^\d+[.-]\d+/)) {
                                      if (lines[j].trim()) {
                                          shlokaLines.push(lines[j].trim());
                                      }
                                      j++;
                                  }
                                  let shlokaText = shlokaLines.join('\n').trim();
                                  if (!shlokaText) {
                                      console.warn(`Empty shloka text for ${chapter}.${verse}, style=${style}`);
                                      return `Shloka ${chapter}.${verse} not found or empty`;
                                  }
                                  return `${chapter}.${verse} ${shlokaText}`;
                              }
                          }
                  
                          console.warn(`Shloka ${chapter}.${verse} not found in ${url}`);
                          return `Shloka ${chapter}.${verse} not found`;
                      } catch (error) {
                          console.error(`Error loading shloka ${chapter}.${verse}: ${error.message}`);
                          return `Error loading shloka ${chapter}.${verse}: ${error.message}`;
                      }
                  }
                  
                  async function fetchShlokaMeaning(chapter, verse) {
                      try {
                          console.log(`fetchShlokaMeaning called: chapter=${chapter}, verse=${verse}`);
                          const url = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/meanings.txt';
                          const response = await fetch(url);
                          if (!response.ok) {
                              throw new Error(`HTTP error: ${response.status}`);
                          }
                          const data = await response.json();
                          const key = `${chapter}.${verse}`;
                          if (data[key]) {
                              let meaningText = `${chapter}.${verse} Meaning:\n\nప్రతిపదార్థం (Word-to-Word Meaning):\n`;
                              const wordToWord = data[key]["ప్రతిపదార్థం"];
                              if (wordToWord) {
                                  for (const [word, meaning] of Object.entries(wordToWord)) {
                                      meaningText += `${word}: ${meaning}\n`;
                                  }
                              } else {
                                  meaningText += 'Word-to-word meaning not available\n';
                              }
                              meaningText += `\nఅర్థము (Overall Meaning):\n${data[key].అర్థము || 'Overall meaning not available'}`;
                              return meaningText;
                          } else {
                              return `Meaning for ${chapter}.${verse} not found`;
                          }
                      } catch (error) {
                          console.error(`Error loading meaning for ${chapter}.${verse}: ${error.message}`);
                          return `Error loading meaning for ${chapter}.${verse}: ${error.message}`;
                      }
                  }
                  
                  async function handleContinuousPlay(selectElement) {
                      try {
                          console.log('handleContinuousPlay called');
                          const chapter = parseInt(selectElement.value);
                          if (!chapter) {
                              console.log('No chapter selected');
                              return;
                          }
                  
                          isInstructionsVisible = false;
                          document.getElementById('instructionsButton').textContent = 'Instructions';
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          const audioPlayer = document.getElementById('audioPlayer');
                          isContinuousPlaying = true;
                  
                          if (continuousPlayInterval) {
                              clearInterval(continuousPlayInterval);
                          }
                  
                          let verse = 1;
                          const playNextVerse = async () => {
                              if (!isContinuousPlaying || verse > verseCounts[chapter]) {
                                  isContinuousPlaying = false;
                                  selectElement.selectedIndex = 0;
                                  audioPlayer.src = '';
                                  console.log('Continuous play stopped');
                                  return;
                              }
                  
                              currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                              currentContext.push({
                                  name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                                  lifespanCount: 5,
                                  parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: getSelectedStyle(), showingMeaning: false }
                              });
                              localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                              console.log(`handleContinuousPlay: Updated context for ${chapter}.${verse}`);
                  
                              const [sgsShloka, sringeriShloka] = await Promise.all([
                                  fetchShlokaText(chapter, verse, 'sgs'),
                                  fetchShlokaText(chapter, verse, 'sringeri')
                              ]);
                              sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                              sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                              adjustTextboxHeight();
                              updateTextboxVisibility();
                  
                              const audioUrl = getSelectedStyle() === 'sringeri' 
                                  ? `${baseUrl}/AudioFullSringeri/${chapter}.${verse}.mp3`
                                  : `${baseUrl}/AudioFullSGS/${chapter}.${verse}.mp3`;
                              audioPlayer.src = audioUrl;
                              try {
                                  audioPlayer.load();
                                  await audioPlayer.play();
                              } catch (error) {
                                  const errorText = `${sgsText.innerText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                                  sgsText.innerText = errorText;
                                  sringeriText.innerText = errorText;
                                  adjustTextboxHeight();
                                  console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                              }
                  
                              audioPlayer.onended = () => {
                                  verse++;
                                  playNextVerse();
                              };
                          };
                  
                          await playNextVerse();
                          selectElement.selectedIndex = 0;
                      } catch (error) {
                          console.error('Error in handleContinuousPlay:', error);
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          sgsText.innerText = `Error in continuous play: ${error.message}`;
                          sringeriText.innerText = `Error in continuous play: ${error.message}`;
                          adjustTextboxHeight();
                      }
                  }
                  
                  function showVerseTable() {
                      try {
                          console.log('showVerseTable called');
                          isInstructionsVisible = false;
                          document.getElementById('instructionsButton').textContent = 'Instructions';
                          const modal = document.getElementById('verseTableModal');
                          const chapterSelect = document.getElementById('chapterTableSelect');
                          chapterSelect.value = '';
                          updateVerseGrid();
                          modal.style.display = 'flex';
                      } catch (error) {
                          console.error('Error in showVerseTable:', error);
                      }
                  }
                  
                  function updateVerseGrid() {
                      try {
                          console.log('updateVerseGrid called');
                          const chapter = parseInt(document.getElementById('chapterTableSelect').value);
                          const content = document.getElementById('verseTableContent');
                          content.innerHTML = '';
                  
                          if (chapter) {
                              const verseGrid = document.createElement('div');
                              verseGrid.className = 'verse-grid';
                              for (let verse = 1; verse <= verseCounts[chapter]; verse++) {
                                  const verseButton = document.createElement('div');
                                  verseButton.className = 'verse-button';
                                  verseButton.textContent = `${chapter}.${verse}`;
                                  verseButton.onclick = () => selectVerse(chapter, verse);
                                  verseGrid.appendChild(verseButton);
                              }
                              content.appendChild(verseGrid);
                          }
                      } catch (error) {
                          console.error('Error in updateVerseGrid:', error);
                      }
                  }
                  
                  function closeVerseTable() {
                      try {
                          console.log('closeVerseTable called');
                          document.getElementById('verseTableModal').style.display = 'none';
                      } catch (error) {
                          console.error('Error in closeVerseTable:', error);
                      }
                  }
                  
                  async function selectVerse(chapter, verse) {
                      try {
                          console.log(`selectVerse called: chapter=${chapter}, verse=${verse}`);
                          isContinuousPlaying = false;
                          isInstructionsVisible = false;
                          document.getElementById('instructionsButton').textContent = 'Instructions';
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                          currentContext.push({
                              name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                              lifespanCount: 5,
                              parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: getSelectedStyle(), showingMeaning: false }
                          });
                          localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                          console.log('selectVerse: Updated context:', JSON.stringify(currentContext));
                          
                          const [sgsShloka, sringeriShloka] = await Promise.all([
                              fetchShlokaText(chapter, verse, 'sgs'),
                              fetchShlokaText(chapter, verse, 'sringeri')
                          ]);
                          sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                          sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                          adjustTextboxHeight();
                          
                          const audioUrl = await fetchAudioUrl(chapter, verse);
                          const audioPlayer = document.getElementById('audioPlayer');
                          audioPlayer.src = audioUrl;
                          try {
                              audioPlayer.load();
                              await audioPlayer.play();
                          } catch (error) {
                              const errorText = `${sgsText.innerText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                              sgsText.innerText = errorText;
                              sringeriText.innerText = errorText;
                              adjustTextboxHeight();
                              console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                          }
                          
                          updateTextboxVisibility();
                          closeVerseTable();
                      } catch (error) {
                          console.error('Error in selectVerse:', error);
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          sgsText.innerText = `Error selecting verse: ${error.message}`;
                          sringeriText.innerText = `Error selecting verse: ${error.message}`;
                          adjustTextboxHeight();
                      }
                  }
                  
                  async function handlePreviousShloka() {
                      try {
                          console.log('handlePreviousShloka called');
                          isContinuousPlaying = false;
                          isInstructionsVisible = false;
                          document.getElementById('instructionsButton').textContent = 'Instructions';
                          const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          if (context && context.parameters && Number.isInteger(context.parameters.chapter) && Number.isInteger(context.parameters.verse)) {
                              let chapter = Math.floor(context.parameters.chapter);
                              let verse = Math.floor(context.parameters.verse) - 1;
                              if (verse < 1) {
                                  chapter -= 1;
                                  if (chapter < 1) {
                                      chapter = 1;
                                      verse = 1;
                                  } else {
                                      verse = verseCounts[chapter];
                                  }
                              }
                              currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                              currentContext.push({
                                  name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                                  lifespanCount: 5,
                                  parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: getSelectedStyle(), showingMeaning: false }
                              });
                              localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                              console.log('handlePreviousShloka: Updated context:', JSON.stringify(currentContext));
                              
                              const [sgsShloka, sringeriShloka] = await Promise.all([
                                  fetchShlokaText(chapter, verse, 'sgs'),
                                  fetchShlokaText(chapter, verse, 'sringeri')
                              ]);
                              sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                              sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                              adjustTextboxHeight();
                              
                              const audioUrl = getSelectedStyle() === 'sringeri' 
                                  ? `${baseUrl}/AudioFullSringeri/${chapter}.${verse}.mp3`
                                  : `${baseUrl}/AudioFullSGS/${chapter}.${verse}.mp3`;
                              const audioPlayer = document.getElementById('audioPlayer');
                              audioPlayer.src = audioUrl;
                              audioPlayer.load(); // No autoplay
                              
                              updateTextboxVisibility();
                          } else {
                              sgsText.innerText = 'Please select a Shloka first';
                              sringeriText.innerText = 'Please select a Shloka first';
                              adjustTextboxHeight();
                              updateTextboxVisibility();
                          }
                      } catch (error) {
                          console.error('Error in handlePreviousShloka:', error);
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          sgsText.innerText = `Error in previous shloka: ${error.message}`;
                          sringeriText.innerText = `Error in previous shloka: ${error.message}`;
                          adjustTextboxHeight();
                      }
                  }
                  
                  async function handleMeanings() {
                      try {
                          console.log('handleMeanings called');
                          isContinuousPlaying = false;
                          isInstructionsVisible = false;
                          const meaningsButton = document.getElementById('meaningsButton');
                          const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          if (context && context.parameters && Number.isInteger(context.parameters.chapter) && Number.isInteger(context.parameters.verse)) {
                              const chapter = Math.floor(context.parameters.chapter);
                              const verse = Math.floor(context.parameters.verse);
                              
                              if (!isShowingMeanings) {
                                  previousText = sgsText.innerText;
                                  const meaningText = await fetchShlokaMeaning(chapter, verse);
                                  sgsText.innerText = meaningText || `Meaning for ${chapter}.${verse} not found`;
                                  sringeriText.innerText = meaningText || `Meaning for ${chapter}.${verse} not found`;
                                  meaningsButton.textContent = 'Close Meanings';
                                  isShowingMeanings = true;
                              } else {
                                  sgsText.innerText = previousText || 'Your Shloka will appear here.';
                                  sringeriText.innerText = previousText || 'Your Shloka will appear here.';
                                  meaningsButton.textContent = 'Meanings';
                                  isShowingMeanings = false;
                              }
                              adjustTextboxHeight();
                              updateTextboxVisibility();
                          } else {
                              sgsText.innerText = 'Please select a Shloka first';
                              sringeriText.innerText = 'Please select a Shloka first';
                              adjustTextboxHeight();
                              updateTextboxVisibility();
                          }
                      } catch (error) {
                          console.error('Error in handleMeanings:', error);
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          sgsText.innerText = `Error fetching meanings: ${error.message}`;
                          sringeriText.innerText = `Error fetching meanings: ${error.message}`;
                          adjustTextboxHeight();
                      }
                  }
                  
                  async function handleChapterSelect(selectElement) {
                      try {
                          console.log('handleChapterSelect called');
                          isContinuousPlaying = false;
                          isInstructionsVisible = false;
                          document.getElementById('instructionsButton').textContent = 'Instructions';
                          const chapter = parseInt(selectElement.value);
                          if (!chapter) {
                              console.log('No chapter selected');
                              return;
                          }
                  
                          const verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                          currentContext.push({
                              name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                              lifespanCount: 5,
                              parameters: { chapter: chapter, verse: verse, style: getSelectedStyle(), showingMeaning: false }
                          });
                          localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                          console.log('handleChapterSelect: Updated context:', JSON.stringify(currentContext));
                  
                          const [sgsShloka, sringeriShloka] = await Promise.all([
                              fetchShlokaText(chapter, verse, 'sgs'),
                              fetchShlokaText(chapter, verse, 'sringeri')
                          ]);
                          sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                          sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                          adjustTextboxHeight();
                  
                          const folder = getSelectedStyle() === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
                          const randomPada = Math.random() < 0.5 ? '1' : '3';
                          const audioUrl = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.${randomPada}.mp3`;
                          const audioPlayer = document.getElementById('audioPlayer');
                          audioPlayer.src = audioUrl;
                          try {
                              audioPlayer.load();
                              await audioPlayer.play();
                          } catch (error) {
                              const errorText = `${sgsText.innerText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                              sgsText.innerText = errorText;
                              sringeriText.innerText = errorText;
                              adjustTextboxHeight();
                              console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                          }
                  
                          updateTextboxVisibility();
                          selectElement.selectedIndex = 0;
                      } catch (error) {
                          console.error('Error in handleChapterSelect:', error);
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          sgsText.innerText = `Error selecting random shloka: ${error.message}`;
                          sringeriText.innerText = `Error selecting random shloka: ${error.message}`;
                          adjustTextboxHeight();
                          updateTextboxVisibility();
                      }
                  }
                  
                  function getSelectedStyle() {
                      try {
                          const style = document.querySelector('input[name="style"]:checked').value;
                          console.log(`getSelectedStyle: ${style}`);
                          return style;
                      } catch (error) {
                          console.error('Error in getSelectedStyle:', error);
                          return 'sringeri'; // Default to Sringeri style if error occurs
                      }
                  }
                  
                  function setSelectedStyle(style) {
                      try {
                          if (style === 'sgs') {
                              document.getElementById('sgs').checked = true;
                          } else {
                              document.getElementById('sringeri').checked = true;
                          }
                          updateTextboxVisibility();
                          console.log(`setSelectedStyle: Set style to ${style}`);
                      } catch (error) {
                          console.error('Error in setSelectedStyle:', error);
                      }
                  }
                  
                  async function updateTextboxVisibility() {
                      try {
                          console.log('updateTextboxVisibility called');
                          const style = getSelectedStyle();
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          const sgsLabel = document.getElementById('sgsLabel');
                          const sringeriLabel = document.getElementById('sringeriLabel');
                  
                          if (style === 'sgs') {
                              sgsText.classList.add('active');
                              sgsLabel.classList.add('active');
                              sringeriText.classList.remove('active');
                              sringeriLabel.classList.remove('active');
                          } else {
                              sgsText.classList.remove('active');
                              sgsLabel.classList.remove('active');
                              sringeriText.classList.add('active');
                              sringeriLabel.classList.add('active');
                          }
                          adjustTextboxHeight();
                      } catch (error) {
                          console.error('Error in updateTextboxVisibility:', error);
                      }
                  }
                  
                  async function sendCommand(intent) {
                      try {
                          console.log(`sendCommand called: intent=${intent}`);
                          isContinuousPlaying = false;
                          isInstructionsVisible = false;
                          isShowingMeanings = false;
                          document.getElementById('instructionsButton').textContent = 'Instructions';
                          document.getElementById('meaningsButton').textContent = 'Meanings';
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          const audioPlayer = document.getElementById('audioPlayer');
                          let chapter, verse, quarter, isFullForQuarter = false, autoplay = true;
                  
                          if (intent === 'SGSFirstPaada') {
                              setSelectedStyle('sgs');
                              quarter = 'pada1';
                              chapter = Math.floor(Math.random() * 18) + 1;
                              verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                              autoplay = true;
                          } else if (intent === 'SringeriPaada') {
                              quarter = 'pada1_or_pada3';
                              chapter = Math.floor(Math.random() * 18) + 1;
                              verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                              autoplay = true;
                          } else if (intent === 'NextFullShloka') {
                              const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                              chapter = context ? Math.floor(context.parameters.chapter) : 1;
                              verse = context ? Math.floor(context.parameters.verse) + 1 : 1;
                              if (verse > verseCounts[chapter]) {
                                  chapter++;
                                  verse = 1;
                                  if (chapter > 18) {
                                      chapter = 1;
                                  }
                              }
                              autoplay = false;
                          } else if (intent === 'PreviousShloka') {
                              const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                              chapter = context ? Math.floor(context.parameters.chapter) : 1;
                              verse = context ? Math.floor(context.parameters.verse) - 1 : 1;
                              if (verse < 1) {
                                  chapter--;
                                  if (chapter < 1) {
                                      chapter = 18;
                                  }
                                  verse = verseCounts[chapter];
                              }
                              autoplay = false;
                          } else if (intent === 'FullShloka') {
                              const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                              if (!context || !context.parameters || !Number.isInteger(context.parameters.chapter) || !Number.isInteger(context.parameters.verse)) {
                                  chapter = 1;
                                  verse = 1;
                              } else {
                                  chapter = Math.floor(context.parameters.chapter);
                                  verse = Math.floor(context.parameters.verse);
                              }
                              isFullForQuarter = true;
                              autoplay = true;
                          }
                  
                          currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                          currentContext.push({
                              name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                              lifespanCount: 5,
                              parameters: { chapter: chapter, verse: verse, style: getSelectedStyle(), showingMeaning: false }
                          });
                          localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                          console.log('sendCommand: Updated context:', JSON.stringify(currentContext));
                  
                          const [sgsShloka, sringeriShloka] = await Promise.all([
                              fetchShlokaText(chapter, verse, 'sgs'),
                              fetchShlokaText(chapter, verse, 'sringeri')
                          ]);
                          sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                          sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                          adjustTextboxHeight();
                  
                          const audioUrl = await fetchAudioUrl(chapter, verse, quarter, isFullForQuarter);
                          if (audioUrl && audioUrl.error) {
                              sgsText.innerText = `${sgsText.innerText}\n${audioUrl.error}`;
                              sringeriText.innerText = `${sringeriText.innerText}\n${audioUrl.error}`;
                              adjustTextboxHeight();
                              return;
                          }
                          audioPlayer.src = audioUrl;
                          audioPlayer.load();
                          if (autoplay) {
                              await audioPlayer.play().catch(error => {
                                  console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                                  sgsText.innerText = `${sgsText.innerText}\nError playing audio: ${error.message}`;
                                  sringeriText.innerText = `${sringeriText.innerText}\nError playing audio: ${error.message}`;
                                  adjustTextboxHeight();
                              });
                          }
                          updateTextboxVisibility();
                      } catch (error) {
                          console.error('Error in sendCommand:', error);
                          const sgsText = document.getElementById('sgsText');
                          const sringeriText = document.getElementById('sringeriText');
                          sgsText.innerText = `Error: ${error.message}`;
                          sringeriText.innerText = `Error: ${error.message}`;
                          adjustTextboxHeight();
                      }
                  }
                  document.querySelectorAll('.top-buttons button').forEach(button => {
                  button.addEventListener('click', () => {
                  button.classList.toggle('clicked');
                  });
                  });
                  
         document.addEventListener("DOMContentLoaded", function () {
            const audio = document.getElementById("audioPlayer");
            const sgsBtn = document.querySelector(".top-buttons .sgs-button");
            const sringeriBtn = document.querySelector(".top-buttons .sringeri-button");
         
            let activeBtn = null; // Track which button was clicked
         
            function resetButtons() {
               [sgsBtn, sringeriBtn].forEach(btn => {
                  if (btn) {
                     btn.classList.remove("sgs-playing", "sringeri-playing", "reset");
                     btn.classList.add("reset");
                  }
               });
            }
         
            if (sgsBtn) {
               sgsBtn.addEventListener("click", function () {
                  activeBtn = sgsBtn;
               });
            }
         
            if (sringeriBtn) {
               sringeriBtn.addEventListener("click", function () {
                  activeBtn = sringeriBtn;
               });
            }
         
            if (audio) {
               // When audio starts
               audio.addEventListener("play", function () {
                  resetButtons(); // Clear old states first
                  if (activeBtn === sgsBtn) {
                     sgsBtn.classList.remove("reset");
                     sgsBtn.classList.add("sgs-playing");
                  } else if (activeBtn === sringeriBtn) {
                     sringeriBtn.classList.remove("reset");
                     sringeriBtn.classList.add("sringeri-playing");
                  }
               });
         
               // When audio ends
               audio.addEventListener("ended", function () {
                  resetButtons();
                  activeBtn = null; // clear after playback ends
               });
            }
         });
                  initialize();
               
      </script>
   </body>
</html>
