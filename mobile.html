<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gita Voice Bot (Mobile)</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #fafafa;
      text-align: center;
    }
    input[type="text"] {
      padding: 1rem;
      width: 80%;
      font-size: 1.2rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      padding: 1rem 2rem;
      margin-top: 1rem;
      font-size: 1.2rem;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 8px;
    }
    #response {
      margin-top: 2rem;
      font-size: 1.2rem;
    }
    audio {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h2>Bhagavad Gita Voice Bot (Mobile)</h2>
  <p>Type commands like <strong>zero</strong>, <strong>chapter 5</strong>, <strong>next</strong>, or <strong>full</strong></p>

  <input id="command" type="text" placeholder="Enter your command..." />
  <br/>
  <button onclick="sendText()">▶ Submit</button>

  <div id="response"></div>
  <audio id="audio" controls autoplay style="display:none;"></audio>

  <script>
    // Auto-detect webhook URL
    const isLocal = location.hostname === "localhost" || location.hostname.startsWith("192.168.");
    const webhookUrl = isLocal
      ? "http://192.168.1.7:8080/webhook"  // Replace with your actual LAN IP
      : "https://gita-voice-bot-504694669439.us-central1.run.app/webhook";

    const responseDiv = document.getElementById("response");
    const audioEl = document.getElementById("audio");

    async function sendText() {
      const text = document.getElementById("command").value.trim().toLowerCase();
      if (!text) return;

      responseDiv.innerHTML = `<em>You typed:</em> <strong>${text}</strong><br/>Thinking...`;

      const payload = {
        queryResult: {
          intent: { displayName: detectIntentFromText(text) },
          parameters: { chapter: parseInt(text.replace(/\D/g, '')) || 1 }
        },
        session: "mobile-debug"
      };

      try {
        const res = await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        const reply = data.fulfillmentText || "No response.";
        responseDiv.innerHTML += `<br/><strong>Bot:</strong> ${reply}`;

        const media = data.payload?.google?.richResponse?.items?.find(i => i.mediaResponse);
        if (media) {
          const audioUrl = media.mediaResponse.mediaObjects[0].contentUrl;
          audioEl.src = audioUrl;
          audioEl.style.display = "block";
          audioEl.play();
        }
      } catch (err) {
        console.error(err);
        responseDiv.innerHTML += `<br/><span style="color:red;">❌ Failed to reach server</span>`;
      }
    }

    function detectIntentFromText(text) {
      if (text.includes("zero")) return "ZeroIntent";
      if (text.includes("chapter")) return "ChapterIntent";
      if (text.includes("full")) return "FullIntent";
      if (text.includes("next")) return "NextIntent";
      return "UnknownIntent";
    }
  </script>
</body>
</html>
