<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Bhagavad Gita Bot</title>
      <meta name="description" content="Explore Bhagavad Gita shlokas in Telugu with SGS and Sringeri styles, featuring audio recitations and meanings.">
      <meta name="keywords" content="Bhagavad Gita, SGS, Sringeri, Telugu shlokas, audio recitation, spiritual app">
      <meta name="author" content="Dr. P. Udayabhaskar">
      <meta name="robots" content="index, follow">
      <link rel="canonical" href="https://pubsaroja.github.io/bhagavad-gita-bot/">
      <link href="https://fonts.googleapis.com/css2?family=Ramabhadra&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu&display=swap" rel="stylesheet">
      <!-- Intro.js for elegant guided tours -->
      <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
      <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
      <style>
         /* Global box-sizing for consistent sizing */
         *, *::before, *::after {
         box-sizing: border-box;
         }
         body {
         font-family: Outfit, sans-serif;    /* Page font */
         text-align: center;                 /* Center page text */
         padding: 20px;                     /* Outer space around content */
         margin: 0;                         /* Remove default margin */
         background-color: #f0f0f0;         /* Light grey background */
         overflow-x: hidden;                /* Prevent horizontal scroll on small screens */
         }
         h1 {
         color: #2c3e50;
         font-size: 1.5em;
         }
         h2 {
         color: #34495e;
         font-size: 1em;
         margin-top: 10px;
         }
         /* === PAGE FRAME (responsive border around the whole page) === */
         .page-frame {
         max-width: 900px;           /* wider than inner content for breathing room */
         margin: 8px auto;           /* space from screen edges and centered */
         padding: 12px;              /* inner padding so border doesn't hug content */
         border: 2px solid #357EC7;  /* theme-aligned border */
         border-radius: 10px;        /* pleasant rounding */
         background: #ffffff;        /* white card against body gray */
         box-shadow: 0 2px 6px rgba(0,0,0,0.04);
         }
         @media (max-width: 600px) {
         .page-frame {
         margin: 4px;               /* reduce outer gap around border on mobile */
         padding: 16px;             /* slightly smaller to avoid overflow */
         border-radius: 10px;       /* keep pleasant rounding on mobile */
         border-width: 4px;         /* thicker border to visually frame content */
         overflow: hidden;          /* keep children within border on wrap */
         }
         }
         /* === TOP BUTTONS CONTAINER === */
         .top-buttons {
         display: flex;
         justify-content: center;
         gap: 10px;
         width: 100%;
         max-width: 600px;   /* Match textbox max-width */
         margin: 0 auto;     /* Center horizontally */
         padding-left: 12px; /* Space from page-frame border */
         padding-right: 12px;/* Space from page-frame border */
         box-sizing: border-box;
         }
         /* === COMMON BUTTON STYLE === */
         .top-buttons button {
         width: 150px;
         height: 150px;
         border-radius: 25%;
         border: none;
         background-color: #357EC7;
         color: white;
         font-size: 20px;
         cursor: pointer;
         transition: background 0.3s ease;
         background-repeat: no-repeat;
         background-position: center;
         background-size: cover;
         }
         /* === SGS Button Hover/Active === */
         .top-buttons button.sgs-button:hover,
         .top-buttons button.sgs-button:active {
         background-image: url('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/main/sankhu.png');
         background-color: transparent !important;
         color: transparent !important;
         }
         /* === Sringeri Button Hover/Active === */
         .top-buttons button.sringeri-button:hover,
         .top-buttons button.sringeri-button:active {
         background-image: url('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/main/chakra.png');
         background-color: transparent !important;
         color: transparent !important;
         }
         /* === third-paada-button Hover/Active === */
         .top-buttons button.third-paada-button:hover,
         .top-buttons button.third-paada-button:active {
         background-image: url('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/main/chakra.png');
         background-color: transparent !important;
         color: transparent !important;
         }
         /* === Reset State (after audio ends) === */
         .top-buttons button.reset,
         .top-buttons button.reset:hover,
         .top-buttons button.reset:active,
         .top-buttons button.reset:focus {
         background: #357EC7 !important;   /* solid blue */
         color: white !important;          /* visible text */
         background-image: none !important;/* force remove picture */
         }
         /* == BUTTON GROUPS CONTAINER == */
         .button-groups {
         display: flex;
         justify-content: center;
         gap: 10px;
         max-width: 600px;
         margin: 0 auto;
         width: 100%;
         padding-left: 12px; /* Align with other containers */
         padding-right: 12px;/* Align with other containers */
         box-sizing: border-box;
         }
         .button-group {
         display: flex;
         flex-direction: column;
         gap: 10px;
         width: 50%;                       /* Two equal columns */
         }
         /* == OTHER BUTTONS == */
         .button-groups button {
         background-color: #357EC7;
         color: white;
         padding: 10px 18px;
         border: none;
         border-radius: 5px;               /* Different shape for these buttons */
         cursor: pointer;
         font-family: 'Outfit', sans-serif;
         font-size: 1.6em;
         width: 100%;
         max-width: 150px;
         transition: background-color 0.3s ease;
         }
         .button-groups button:hover {
         background-color: #ffffff;
         color: transparent;
         }
         select {
         padding: 10px;
         margin: 5px;
         font-size: 1em;
         border-radius: 5px;
         width: 100%;
         max-width: 150px;
         }
         /* == DROPDOWN CONTAINER == */
         .dropdown-container {
         display: flex;
         flex-direction: column;  /* Stack items vertically */
         gap: 20px;               /* Space between dropdown items */
         max-width: 600px;
         margin: 0 auto;
         border: 2px solid #357EC7;/* theme-aligned border */
         border-radius: 5px;
         padding: 10px 12px;     /* Align with button side padding */
         box-sizing: border-box;
         }
         .dropdown-item {
         display: flex;
         flex-direction: column;  /* Label on top, dropdown below */
         }
         .dropdown-label {
         margin-bottom: 6px;
         font-weight: bold;
         font-size: 1em;
         color: #2c3e50;
         }
         select {
         width: 100%;
         padding: 8px;
         font-size: 1em;
         border-radius: 5px;
         border: 1px solid #ccc;
         }
         /* == SHLOKA TEXT == */
         .shloka-text {
         margin-top: 10px;
         font-size: 1.5em;
         color: #333;
         white-space: pre-wrap;
         max-width: 100%;
         margin-left: 0;        /* Avoid shrinking due to auto margins */
         margin-right: 0;       /* Avoid shrinking due to auto margins */
         line-height: 1.5;
         min-height: 3em;
         overflow-y: auto;
         padding: 0;             /* Let container provide padding */
         display: none;
         justify-content: center;
         align-items: center;
         text-align: center;
         font-family: 'Noto Sans Telugu', sans-serif;
         box-sizing: border-box;
         }
         .shloka-text.active {
         display: flex;
         flex-direction: column;   /* stack multiple shlokas vertically */
         align-items: stretch;     /* let items take full width */
         }
         .shloka-text.active.multiline {
         display: block;
         text-align: left;
         }
         #sgsText, #sringeriText {
         display: block;
         width: 100%;
         white-space: normal !important; /* Override any pre-wrap */
         text-align: left;
         margin-left: 0;        /* Avoid shrinking due to auto margins */
         margin-right: 0;       /* Avoid shrinking due to auto margins */
         max-width: 100%;
         font-family: 'Noto Sans Telugu', sans-serif;
         font-size: 1.5em;
         line-height: 1.5;
         border: none;           /* Border handled by container */
         padding: 0;             /* Padding handled by container */
         overflow-y: auto;
         min-height: 3em;
         box-sizing: border-box;
         }
         #sgsText > div,
         #sringeriText > div {
         display: block;
         width: 100%;
         margin-bottom: 1em; /* Spacing between shlokas */
         }
         .hidden {
         display: none !important;
         }
         /* Center placeholder only inside shloka text boxes */
         .shloka-text.visible {
         display: flex !important;
         flex-direction: column;   /* stack vertically when visible */
         align-items: stretch;     /* take full width */
         justify-content: center;
         text-align: center !important;
         }
         /* Explicit placeholder state (works regardless of visible/active) */
         .shloka-text.placeholder {
         display: flex !important;
         flex-direction: column;   /* keep vertical flow in placeholder too */
         align-items: center;
         justify-content: center;
         text-align: center !important;
         }
         /* Revert to block and left-align when content spans multiple lines */
         .shloka-text.visible.multiline {
         display: block !important;
         text-align: left;
         }
         .visible {
         display: block !important;
         }
         #audioPlayer {
         margin: 10px auto;
         display: block;
         flex-shrink: 0;
         }
         .radio-group {
         margin: 10px 0;
         display: flex;
         justify-content: center;
         align-items: center;
         gap: 10px;
         width: 100%;
         max-width: 600px;      /* Match textbox max-width */
         margin-left: auto;     /* Center horizontally */
         margin-right: auto;    /* Center horizontally */
         padding-left: 12px;    /* Align with other containers */
         padding-right: 12px;   /* Align with other containers */
         box-sizing: border-box;
         }
         .radio-group label {
         margin: 0 10px;
         }
         .textbox-container {
         display: flex;
         flex-direction: column;
         align-items: stretch;   /* Let children take full width */
         gap: 10px;
         width: 100%;
         max-width: 600px;      /* Align outer width with buttons */
         margin: 12px auto 0;   /* Add top gap from previous container */
         padding-left: 12px;    /* Match other containers */
         padding-right: 12px;   /* Match other containers */
         border: 2px solid #357EC7; /* Move border to container for alignment */
         border-radius: 5px;
         box-sizing: border-box;
         }
         .textbox-container > div {
         width: 100%;
         max-width: 100%;      /* Let outer container control width */
         }
         .textbox-label {
         font-weight: bold;
         margin-bottom: 5px;
         display: none;
         }
         .textbox-label.active {
         display: block;
         }
         /* == MODAL == */
         .modal {
         display: none;
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background-color: rgba(0, 0, 0, 0.5);
         justify-content: center;
         align-items: center;
         z-index: 1000;
         }
         .modal-content {
         background-color: #fff;
         padding: 20px;
         border-radius: 5px;
         max-width: 80%;
         max-height: 80%;
         overflow-y: auto;
         border: 2px solid #357EC7;
         }
         .chapter-select {
         margin-bottom: 10px;
         padding: 10px;
         font-size: 1em;
         border-radius: 5px;
         width: 100%;
         max-width: 200px;
         }
         /* == VERSE GRID == */
         .verse-grid {
         display: grid;
         grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
         gap: 10px;
         padding: 10px;
         }
         .verse-button {
         background-color: #f9f9f9;
         border: 1px solid #357EC7;
         border-radius: 5px;
         padding: 10px;
         text-align: center;
         cursor: pointer;
         font-size: 0.9em;
         }
         .verse-button:hover {
         background-color: #e0e0e0;
         }
         .close-button {
         background-color: #ff4444;
         color: white;
         padding: 5px 10px;
         border: none;
         border-radius: 5px;
         cursor: pointer;
         float: right;
         }
         .close-button:hover {
         background-color: #cc0000;
         }
         .credits {
         font-size: 0.9em;
         color: #000;
         margin-top: 10px;
         }
         /* == RESPONSIVE MOBILE STYLES (≤600px) == */
         @media (max-width: 600px) {
       /* Reduce body padding on mobile to remove excess space around page border */
       body { padding: 6px; }
       /* Containers respect body padding with internal padding */
       .top-buttons,
       .button-groups,
       .dropdown-container,
       .radio-group,
       .player-container,
       .textbox-container {
       width: 100%;
       max-width: 100%;           /* avoid fixed max-width causing overflow */
       margin: 0 auto;
       padding-left: 12px;       /* standardized mobile padding */
       padding-right: 12px;
       box-sizing: border-box;
       flex-wrap: wrap;          /* Allow wrapping if needed */
       }
       .player-container { padding-left: 12px; padding-right: 12px; }
        /* Add a bit of breathing room above button sections */
        .top-buttons { margin-top: 6px; }
        .player-container { margin-top: 12px; }
        .button-groups { margin-top: 12px; }
        /* Slightly smaller shloka text on mobile for better fit */
        #sgsText, #sringeriText { font-size: 1.25em; }
       .top-buttons {
       gap: 5px;
       flex-direction: row;
       }
       /* Make player controls responsive to avoid overflow */
       .player-container {
       grid-template-columns: repeat(3, 1fr);
       }
       .player-container button {
       width: 100%;
       }
        .button-groups {
        gap: 5px;
        flex-direction: row;
        }
         .button-group {
         width: 50%;
         gap: 5px;
         }
         .top-buttons button {
         flex: 1 1 calc(33.333% - 10px); /* three per row minus gap */
         max-width: none;     /* let flex-basis control width */
         height: auto;        /* adjust height automatically */
         aspect-ratio: 1/1;   /* keep square shape */
         font-size: 0.8em;    /* reduce text size for mobile */
         }
         .button-groups button {
         padding: 6px 12px;
         font-size: 0.8em;
         max-width: 100%;
         }
         }
         /* == PLAYER CONTAINER == */
         .player-container {
         display: grid;
         grid-template-columns: repeat(3, max-content); /* 3 columns sized to button content */
         grid-template-rows: repeat(2, auto);           /* 2 rows */
         gap: 10px 5px;                                 /* row-gap and column-gap */
         justify-content: center;                       /* center entire grid horizontally */
         justify-items: center;                         /* center buttons horizontally inside cells */
         align-items: center;                           /* vertical center alignment */
         max-width: 600px;
         margin: 20px auto 0;
         width: 100%;
         box-sizing: border-box;
         border: none;
         border-radius: 5px;
         padding: 12px;             /* Align side padding with others */
         }
         .player-container button {
         width: 100px;               /* restore fixed button width */
         height: 40px;               /* fixed height */
         border: none;
         border-radius: 25px;        /* pill shape */
         background-color: #357EC7;
         color: white;
         font-family: 'Outfit', sans-serif;
         font-size: 16px;
         cursor: pointer;
         padding: 0 15px;            /* add horizontal padding */
         transition: background 0.3s ease;
         justify-self: center;       /* center button horizontally inside grid cell */
         align-self: center;         /* center vertically */
         }
         .player-container button:hover {
         background-color: #1e40af;
         }
         /* Elegant Intro.js customization */
         .introjs-overlay {
         background: rgba(0,0,0,0.5);
         }
         .introjs-helperLayer {
         box-shadow: 0 8px 24px rgba(0,0,0,0.25);
         border-radius: 10px;
         }
         .introjs-tooltip {
         border-radius: 12px;
         font-family: Outfit, sans-serif;
         line-height: 1.4;
         color: #1f2937; /* slate-800 */
         }
         .introjs-tooltip-header {
         border-bottom: none;
         }
         .introjs-tooltip-title {
         font-weight: 700;
         color: #111827; /* gray-900 */
         }
         .introjs-tooltiptext {
         font-size: 15px;
         }
         .introjs-button {
         border-radius: 999px;
         padding: 6px 14px;
         border: none;
         }
         .introjs-skipbutton,
         .introjs-prevbutton {
         background: #e5e7eb; /* gray-200 */
         color: #111827;
         }
         .introjs-nextbutton,
         .introjs-donebutton {
         background: #357EC7; /* app primary */
         color: white;
         }
      </style>
   </head>
   <body>
      <div class="page-frame">
      <h1>Srimad Bhagavad Gita</h1>
      <p>Listen, understand and memorize Bhagavad Gita shlokas</p>
      <div class="top-buttons" data-intro="Choose how you want to hear the shloka" data-title="Playback Options">
         <button class="sgs-button" onclick="sendCommand('SGSFirstPaada')" data-intro="Play only 1st Paada in SGS style" data-title="1st Paada (SGS)">1st Paada<br>Only</button>
         <button class="sringeri-button" onclick="sendCommand('SringeriPaada')" data-intro="Play 1st or 3rd Paada in Sringeri style" data-title="1st or 3rd Paada (Sringeri)">1st or 3rd Paada</button>
         <button class="third-paada-button" onclick="sendCommand('ThirdPaada')" data-intro="Play only 3rd Paada" data-title="3rd Paada Only">3rd Paada<br>Only</button>
      </div>
      <audio id="audioPlayer" controls data-intro="Use these controls to play, pause, or scrub through the audio." data-title="Audio Player"></audio>
      <div class="radio-group" data-intro="Pick the chanting style for display and playback" data-title="Chanting Style">
         <label>Style:</label>
         <input type="radio" name="style" value="sgs" id="sgs" onchange="updateTextboxVisibility()">
         <label for="sgs">SGS</label>
         <input type="radio" name="style" value="sringeri" id="sringeri" checked onchange="updateTextboxVisibility()">
         <label for="sringeri">Sringeri</label>
      </div>
      <div class="player-container">
         <button onclick="sendCommand('PreviousShloka')" data-intro="Go to previous shloka" data-title="Previous">Previous</button>
         <button onclick="sendCommand('FullShloka')" data-intro="Play the full shloka" data-title="Full Shloka">Full</button>
         <button onclick="sendCommand('NextFullShloka')" data-intro="Go to next shloka" data-title="Next">Next</button>
      </div>
      <div class="textbox-container">
         <div>
            <div id="sgsLabel" class="textbox-label">SGS Style Shloka</div>
            <div id="sgsText" class="shloka-text hidden">Your Shloka will appear here.</div>
         </div>
         <div>
            <div id="sringeriLabel" class="textbox-label active">Sringeri Style Shloka</div>
            <div id="sringeriText" class="shloka-text visible">Your Shloka will appear here.</div>
         </div>
      </div>
      <div class="player-container" >
         <button id="meaningsButton" onclick="handleMeanings()" data-intro="Toggle word-by-word and overall meaning" data-title="Meanings">Meanings</button>
         <button onclick="showVerseTable()" data-intro="Open chapter/verse selector" data-title="Selector">Selector</button>
         <button id="instructionsButton" onclick="toggleInstructions()" data-intro="Start a guided tour of the app" data-title="Help">Help</button>
         <button id="groupButton" onclick="window.open('https://pubsaroja.github.io/gita-voice-bot-web/GroupedShlokas.html', '_blank')" data-intro="Open carefully curated grouped shlokas helpful in memorizing the shloka numbers in a new tab" data-title="Grouped Shlokas">Grouped Shlokas</button>
         <button onclick="showConfusing()" data-intro="Listen to a set of often-confused shlokas" data-title="Confusing Shlokas">Confusing Shlokas</button>
         <button id="showUvacha" onclick="showUvacha()" data-intro="Play a random 'Uvacha' shloka" data-title="Uvacha">Uvacha</button>
      </div>
      <br>
      <div class="dropdown-container">
         <div>
            <label for="chapterSelect" 
               style="display:block; font-family:Outfit, sans-serif; font-size:1.1em;">
            Random Shloka Chapterwise:
            </label>
            <select id="chapterSelect" onchange="handleChapterSelect(this)" data-intro="Pick a chapter to play a random shloka from it" data-title="Random by Chapter">
               <option value="" selected disabled>Select Chapter</option>
               <option value="1">1. అర్జునవిషాదయోగః</option>
               <option value="2">2. సాఙ్ఖ్యయోగః</option>
               <option value="3">3. కర్మయోగః</option>
               <option value="4">4. జ్ఞానయోగః</option>
               <option value="5">5. కర్మసన్న్యాసయోగః</option>
               <option value="6">6. ఆత్మసంయమయోగః</option>
               <option value="7">7. జ్ఞానవిజ్ఞానయోగః</option>
               <option value="8">8. అక్షరపరబ్రహ్మయోగః</option>
               <option value="9">9. రాజవిద్యారాజగుహ్యయోగః</option>
               <option value="10">10. విభూతియోగః</option>
               <option value="11">11. విశ్వరూపసన్దర్శనయోగః</option>
               <option value="12">12. భక్తియోగః</option>
               <option value="13">13. క్షేత్రక్షేత్రజ్ఞవిభాగయోగః</option>
               <option value="14">14. గుణత్రయవిభాగయోగః</option>
               <option value="15">15. పురుషోత్తమప్రాప్తియోగః</option>
               <option value="16">16. దైవాసురసమ్పద్విభాగయోగః</option>
               <option value="17">17. శ్రద్ధాత్రయవిభాగయోగః</option>
               <option value="18">18. మోక్షసన్న్యాసయోగః</option>
            </select>
         </div>
         <div>
            <label for="chapterSelect" style="display:block; font-family:Outfit, sans-serif; font-size:1.1em;">Continuous Play:</label>
            <select id="continuousPlaySelect" onchange="handleContinuousPlay(this)" data-intro="Play an entire chapter continuously" data-title="Continuous Play">
               <option value="" selected disabled>Select Chapter</option>
               <option value="1">1. అర్జునవిషాదయోగః</option>
               <option value="2">2. సాఙ్ఖ్యయోగః</option>
               <option value="3">3. కర్మయోగః</option>
               <option value="4">4. జ్ఞానయోగః</option>
               <option value="5">5. కర్మసన్న్యాసయోగః</option>
               <option value="6">6. ఆత్మసంయమయోగః</option>
               <option value="7">7. జ్ఞానవిజ్ఞానయోగః</option>
               <option value="8">8. అక్షరపరబ్రహ్మయోగః</option>
               <option value="9">9. రాజవిద్యారాజగుహ్యయోగః</option>
               <option value="10">10. విభూతియోగః</option>
               <option value="11">11. విశ్వరూపసన్దర్శనయోగః</option>
               <option value="12">12. భక్తియోగః</option>
               <option value="13">13. క్షేత్రక్షేత్రజ్ఞవిభాగయోగః</option>
               <option value="14">14. గుణత్రయవిభాగయోగః</option>
               <option value="15">15. పురుషోత్తమప్రాప్తియోగః</option>
               <option value="16">16. దైవాసురసమ్పద్విభాగయోగః</option>
               <option value="17">17. శ్రద్ధాత్రయవిభాగయోగః</option>
               <option value="18">18. మోక్షసన్న్యాసయోగః</option>
            </select>
         </div>
      </div>
      </div>
      <div>
         <h3>Search for word (Telugu or English or Number):</h3>
         <input type="text" id="search-input" placeholder="Enter word or number to search" data-intro="Type a word to search across shlokas" data-title="Enter Query">
         <button id="search-button" data-intro="Click to search" data-title="Run Search">Search</button>
      </div>
      <div class="credits">
         SGS Audio:<br>
         Pujya Sri Datta Vijayanand Teertha Swamiji<br>
         Sringeri Audio courtesy:<br>
         Smt Mathangi Kailasnath<br>
         Developed by<br>
         Dr. P. Udayabhaskar
      </div>
      <div id="verseTableModal" class="modal">
      <div class="modal-content">
         <button class="close-button" onclick="closeVerseTable()">Close</button>
         <select id="chapterTableSelect" class="chapter-select" onchange="updateVerseGrid()">
            <option value="" selected disabled>-- Select Chapter --</option>
            <option value="1">Chapter 1 (47 verses)</option>
            <option value="2">Chapter 2 (72 verses)</option>
            <option value="3">Chapter 3 (43 verses)</option>
            <option value="4">Chapter 4 (42 verses)</option>
            <option value="5">Chapter 5 (29 verses)</option>
            <option value="6">Chapter 6 (47 verses)</option>
            <option value="7">Chapter 7 (30 verses)</option>
            <option value="8">Chapter 8 (28 verses)</option>
            <option value="9">Chapter 9 (34 verses)</option>
            <option value="10">Chapter 10 (42 verses)</option>
            <option value="11">Chapter 11 (55 verses)</option>
            <option value="12">Chapter 12 (20 verses)</option>
            <option value="13">Chapter 13 (34 verses)</option>
            <option value="14">Chapter 14 (27 verses)</option>
            <option value="15">Chapter 15 (20 verses)</option>
            <option value="16">Chapter 16 (24 verses)</option>
            <option value="17">Chapter 17 (28 verses)</option>
            <option value="18">Chapter 18 (78 verses)</option>
         </select>
         <div id="verseTableContent" class="verse-grid"></div>
      </div>
      <script>
         // Global variables holding text file contents
         let sringeriContent = '';
         let englishContent = '';
         
         let selectedStyle = 'sringeri';
         let isContinuousPlaying = false;
         let isInstructionsVisible = false;
         let isShowingMeanings = false;
         let previousText = '';
         let sessionId = 'session-' + Math.random().toString(36).substr(2, 9);
         let currentContext = [];
         let currentAllShlokas = []; // For Confusing Shlokas
         let isTourActive = false; // Intro.js tour state
         const baseUrl = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/main';
         const verseCounts = {
             1: 47, 2: 72, 3: 43, 4: 42, 5: 29, 6: 47, 7: 30, 8: 28,
             9: 34, 10: 42, 11: 55, 12: 20, 13: 34, 14: 27, 15: 20,
             16: 24, 17: 28, 18: 78
         };
         const confusingShlokaGroups = [
             ['1.24', '2.9', '11.9'], ['1.20', '1.37'], ['1.38', '1.39'], ['2.6', '11.32'],
             ['2.10', '1.21', '1.24'], ['2.17', '8.22', '18.46'], ['2.25', '2.26', '2.27', '2.30'],
             ['2.33', '2.38'], ['2.32', '4.22'], ['2.41', '2.44'], ['2.48', '5.10', '18.6', '18.26'],
             ['2.57', '2.58', '2.61', '2.68'], ['2.58', '5.9', '2.68'], ['2.56', '4.10'],
             ['2.71', '12.13'], ['3.13', '3.31', '4.31'], ['3.23', '4.11'], ['3.27', '13.29'],
             ['3.34', '18.51'], ['3.40', '3.42'], ['4.6', '9.8'], ['4.16', '9.1'],
             ['4.19', '4.37'], ['4.31', '4.40'], ['4.39', '5.6'], ['4.41', '9.9'],
             ['5.3', '2.45'], ['5.5', '13.27'], ['5.6', '18.1'], ['5.24', '5.26'],
             ['5.25', '12.4'], ['5.29', '10.3'], ['6.7', '12.18'], ['6.8', '14.24'],
             ['6.15', '6.28'], ['6.22', '18.32'], ['6.31', '13.23'], ['6.34', '8.14'],
             ['6.45', '13.28'], ['6.37', '6.40'], ['6.47', '4.40'], ['7.1', '6.35'],
             ['7.6', '10.8'], ['7.10', '10.36', '10.24'], ['7.13', '7.25'], ['7.16', '7.11'],
             ['7.15', '7.20'], ['7.23', '9.11'], ['7.27', '13.6'], ['7.30', '8.2'],
             ['8.2', '8.4'], ['8.1', '8.4'], ['8.7', '8.27', '12.14'], ['8.13', '9.32'],
             ['8.21', '15.6'], ['8.23', '10.1'], ['9.9', '14.24'], ['9.10', '9.23'],
             ['9.16', '9.24'], ['9.34', '18.65'], ['10.1', '18.64'], ['10.5', '16.2'],
             ['10.32', '10.39'], ['10.42', '6.42'], ['10.39', '18.40'], ['11.7', '11.13'],
             ['11.16', '11.17', '11.19'], ['11.18', '11.38'], ['11.25', '11.45'],
             ['11.52', '11.53'], ['12.6', '18.57'], ['13.2', '13.34'], ['13.23', '2.19'],
             ['16.3', '16.5'], ['16.10', '16.17'], ['16.18', '8.53'], ['16.23', '17.1'],
             ['17.1', '9.23'], ['17.19', '17.22', '18.22'], ['17.24', '17.25'],
             ['18.3', '18.5'], ['18.20', '13.16'], ['18.30', '16.7'], ['18.53', '14.26'],
             ['18.54', '12.17', '13.27'], ['18.58', '2.33'], ['18.76', '18.77']
         ];
                 const uvachaShlokas = [
                     '1.1', '1.2', '1.21', '1.24', '1.25', '1.28', '1.47', '2.1', '2.2', '2.4', '2.9', '2.10', '2.11', '2.54', '2.55',
                     '3.1', '3.3', '3.36', '3.37', '4.1', '4.4', '4.5', '5.1', '5.2', '6.1', '6.33', '6.5', '6.37', '6.40', '7.1',
                     '8.1', '8.3', '9.1', '10.1', '10.12', '10.19', '11.1', '11.5', '11.9', '11.15', '11.32', '11.35', '11.6', '11.47',
                     '11.50', '11.51', '11.52', '12.1', '12.2', '13.1', '14.1', '14.21', '14.22', '15.1', '16.1', '17.1', '17.2', '18.1',
                     '18.2', '18.73', '18.74'
                 ];
         
                 // Initialize
                 function initialize() {
                     console.log('initialize: Starting');
                     localStorage.removeItem('gitaSessionId');
                     localStorage.removeItem('gitaContext');
                     localStorage.setItem('gitaSessionId', sessionId);
                     updateTextboxVisibility();
                     adjustTextboxHeight();
                     console.log('initialize: Completed');
                 }
         
         // Load text files asynchronously from GitHub raw URLs
         async function loadFiles() {
             try {
                 const sringeriResponse = await fetch('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_Sringeri.txt');
                 if (!sringeriResponse.ok) throw new Error('Failed to load BG_Sringeri.txt');
                 sringeriContent = await sringeriResponse.text();
         
                 const englishResponse = await fetch('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_English_single_line.txt');
                 if (!englishResponse.ok) throw new Error('Failed to load BG_English_single_line.txt');
                 englishContent = await englishResponse.text();
         
                 console.log('Files loaded:', {
                     sringeriLines: sringeriContent.split('\n').length,
                     englishLines: englishContent.split('\n').length
                 });
             } catch (err) {
                 alert(err.message);
                 console.error(err);
             }
         }
         
         // Highlight matched words in output with red text
         function highlightText(text, searchTerm, isShlokaNumberSearch = false) {
             if (!searchTerm) return text;
             // Skip highlighting for shloka number in number searches
             if (isShlokaNumberSearch) {
                 return text;
             }
             // Escape special regex characters in searchTerm
             const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
             const regex = new RegExp(`(${escapedTerm})`, 'gi');
             return text.replace(regex, `<span style="color: red;">$1</span>`);
         }
         
         // Search function to handle Telugu, English, and shloka number searches
         async function performSearch() {
             const searchInput = document.getElementById('search-input').value.trim();
             const sgsOutput = document.getElementById('sgsText');
             const sringeriOutput = document.getElementById('sringeriText');
             const audioPlayer = document.getElementById('audioPlayer');
         
             if (!sgsOutput || !sringeriOutput || !audioPlayer) {
                 alert('Output or audio elements missing');
                 return;
             }
         
             // Clear previous results and reset audio
             sgsOutput.innerHTML = '';
             sringeriOutput.innerHTML = '';
             audioPlayer.src = '';
             audioPlayer.onended = null;
         
             if (!searchInput) {
                 sgsOutput.innerHTML = 'Please enter a search term.';
                 sringeriOutput.innerHTML = 'Please enter a search term.';
                 return;
             }
         
             // Check if files are loaded
             if (!sringeriContent || !englishContent) {
                 sgsOutput.innerHTML = 'Text files not loaded. Please try again.';
                 sringeriOutput.innerHTML = 'Text files not loaded. Please try again.';
                 return;
             }
         
             console.log('Searching for:', searchInput); // Debug log
         
             // Normalize line endings and split
             const sringeriLines = sringeriContent.replace(/\r\n/g, '\n').split('\n');
             const englishLines = englishContent.replace(/\r\n/g, '\n').split('\n');
         
             // Check if the input is a shloka number (e.g., 12.2)
             const shlokaNumberPattern = /^\d+\.\d+\s*$/;
             if (shlokaNumberPattern.test(searchInput)) {
                 let found = false;
                 let fullShloka = [];
                 const [chapter, verse] = searchInput.split('.').map(Number);
         
                 for (let i = 0; i < sringeriLines.length; i++) {
                     const line = sringeriLines[i].trim();
                     const normalizedLineStart = line.split(/[\s\t]+/)[0].trim();
                     if (normalizedLineStart === searchInput) {
                         fullShloka.push(line);
                         found = true;
                         // Collect subsequent lines until the next shloka number or empty line
                         for (let j = i + 1; j < sringeriLines.length; j++) {
                             const nextLine = sringeriLines[j].trim();
                             if (!nextLine || nextLine.match(shlokaNumberPattern)) {
                                 break;
                             }
                             fullShloka.push(nextLine);
                         }
                         break;
                     }
                 }
         
                 if (found) {
                     const highlighted = fullShloka.map(line => highlightText(line, searchInput, true)).join('<br>');
                     sgsOutput.innerHTML = highlighted;
                     sringeriOutput.innerHTML = highlighted;
                     console.log('Shloka found:', fullShloka); // Debug log
         
                     // Save context for this shloka
                     currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                     currentContext.push({
                         name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                         lifespanCount: 5,
                         parameters: { chapter, verse, style: getSelectedStyle(), showingMeaning: false }
                     });
                     localStorage.setItem('gitaContext', JSON.stringify(currentContext));
         
                     // Fetch and autoplay full shloka audio
                     const audioUrl = await fetchAudioUrl(chapter, verse, null, true);
                     if (audioUrl && audioUrl.error) {
                         sgsOutput.innerHTML += `<br>${audioUrl.error}`;
                         sringeriOutput.innerHTML += `<br>${audioUrl.error}`;
                         adjustTextboxHeight();
                     } else if (audioUrl) {
                         try {
                             isProcessingAudio = true;
                             audioPlayer.pause();
                             audioPlayer.src = '';
                             audioPlayer.currentTime = 0;
                             audioPlayer.src = audioUrl;
                             audioPlayer.load();
                             await audioPlayer.play();
                         } catch (err) {
                             const msg = `Error playing audio for ${chapter}.${verse}: ${err.message}`;
                             sgsOutput.innerHTML += `<br>${msg}`;
                             sringeriOutput.innerHTML += `<br>${msg}`;
                             console.error('performSearch (number):', msg);
                         } finally {
                             isProcessingAudio = false;
                             adjustTextboxHeight();
                         }
                     }
                 } else {
                     sgsOutput.innerHTML = `Shloka ${searchInput} not found.`;
                     sringeriOutput.innerHTML = `Shloka ${searchInput} not found.`;
                     console.log('Shloka not found:', searchInput); // Debug log
                 }
             } else {
                 // Normalize search input
                 const normalizedSearchInput = searchInput.replace(/\s+/g, ' ').trim().normalize('NFC');
         
                 // Check if the input is Telugu (contains Telugu characters)
                 const teluguPattern = /[\u0C00-\u0C7F]/;
                 if (teluguPattern.test(normalizedSearchInput)) {
                     // Search for Telugu word in sringeriContent
                     const results = [];
                     let currentShloka = [];
                     let currentShlokaNumber = null;
         
                     // Debug specific shlokas and all detected numbers
                     const debugShlokas = ['1.1', '1.2', '1.4', '5.7', '5.10'];
                     const debugContent = [];
                     const detectedNumbers = [];
         
                     for (let i = 0; i < sringeriLines.length; i++) {
                         const line = sringeriLines[i].trim();
                         const normalizedLine = line.replace(/\s+/g, ' ').trim().normalize('NFC');
                         const lineStart = line.split(/[\s\t]+/)[0].trim();
                         if (lineStart.match(shlokaNumberPattern)) {
                             detectedNumbers.push(lineStart); // Log all detected numbers
                             if (currentShloka.length > 0) {
                                 const shlokaText = currentShloka.join(' ').replace(/\s+/g, ' ').trim().normalize('NFC');
                                 const regex = new RegExp(normalizedSearchInput.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                                 if (regex.test(shlokaText)) {
                                     results.push(currentShloka.map(line => highlightText(line, normalizedSearchInput)).join('<br>'));
                                     console.log('Telugu match found for shloka:', currentShlokaNumber, currentShloka); // Debug log
                                 }
                                 if (debugShlokas.includes(currentShlokaNumber)) {
                                     debugContent.push({ number: currentShlokaNumber, text: currentShloka });
                                 }
                             }
                             currentShloka = [line];
                             currentShlokaNumber = lineStart;
                         } else if (currentShloka.length > 0 && line) {
                             currentShloka.push(line);
                         } else if (currentShloka.length > 0) {
                             const shlokaText = currentShloka.join(' ').replace(/\s+/g, ' ').trim().normalize('NFC');
                             const regex = new RegExp(normalizedSearchInput.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                             if (regex.test(shlokaText)) {
                                 results.push(currentShloka.map(line => highlightText(line, normalizedSearchInput)).join('<br>'));
                                 console.log('Telugu match found for shloka:', currentShlokaNumber, currentShloka); // Debug log
                             }
                             if (debugShlokas.includes(currentShlokaNumber)) {
                                 debugContent.push({ number: currentShlokaNumber, text: currentShloka });
                             }
                             currentShloka = [];
                             currentShlokaNumber = null;
                         }
                     }
                     // Check the last shloka
                     if (currentShloka.length > 0) {
                         const shlokaText = currentShloka.join(' ').replace(/\s+/g, ' ').trim().normalize('NFC');
                         const regex = new RegExp(normalizedSearchInput.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                         if (regex.test(shlokaText)) {
                             results.push(currentShloka.map(line => highlightText(line, normalizedSearchInput)).join('<br>'));
                             console.log('Telugu match found for last shloka:', currentShlokaNumber, currentShloka); // Debug log
                         }
                         if (debugShlokas.includes(currentShlokaNumber)) {
                             debugContent.push({ number: currentShlokaNumber, text: currentShloka });
                         }
                     }
         
                     console.log('Detected shloka numbers in BG_Sringeri.txt:', detectedNumbers.slice(0, 10)); // Debug first 10 numbers
                     console.log('Debug shlokas (1.1, 1.2, 1.4, 5.7, 5.10) in BG_Sringeri.txt:', debugContent); // Debug log
         
                     if (results.length > 0) {
                         const resultText = results.join('<br><br>');
                         sgsOutput.innerHTML = resultText;
                         sringeriOutput.innerHTML = resultText;
                         console.log('Telugu search results:', results); // Debug log
                         console.log('First few lines of BG_Sringeri.txt:', sringeriLines.slice(0, 5)); // Debug log
                     } else {
                         sgsOutput.innerHTML = `No shlokas found containing "${searchInput}".`;
                         sringeriOutput.innerHTML = `No shlokas found containing "${searchInput}".`;
                         console.log('No Telugu results for:', searchInput); // Debug log
                         console.log('First few lines of BG_Sringeri.txt:', sringeriLines.slice(0, 5)); // Debug log
                     }
                 } else {
                     // English word search
                     const matchingShlokaNumbers = [];
                     for (let i = 0; i < englishLines.length; i++) {
                         const line = englishLines[i].replace(/\s+/g, ' ').trim().normalize('NFC');
                         const regex = new RegExp(normalizedSearchInput.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                         if (regex.test(line)) {
                             const shlokaNumber = line.split(/[\s\t]+/)[0].trim();
                             if (shlokaNumber.match(shlokaNumberPattern)) {
                                 matchingShlokaNumbers.push(shlokaNumber);
                             }
                         }
                     }
                     console.log('English matching shloka numbers:', matchingShlokaNumbers); // Debug log
                     console.log('First few lines of BG_English_single_line.txt:', englishLines.slice(0, 5)); // Debug log
         
                     const results = [];
                     let currentShloka = [];
                     let currentShlokaNumber = null;
         
                     // Debug specific shlokas and all detected numbers
                     const debugShlokas = ['1.1', '1.2', '1.4', '5.7', '5.10'];
                     const debugContent = [];
                     const detectedNumbers = [];
         
                     for (let i = 0; i < sringeriLines.length; i++) {
                         const line = sringeriLines[i].trim();
                         const normalizedLineStart = line.split(/[\s\t]+/)[0].trim();
                         if (normalizedLineStart.match(shlokaNumberPattern)) {
                             detectedNumbers.push(normalizedLineStart); // Log all detected numbers
                             if (currentShloka.length > 0 && matchingShlokaNumbers.includes(currentShlokaNumber)) {
                                 results.push(currentShloka.map(line => highlightText(line, normalizedSearchInput)).join('<br>'));
                                 console.log('English match found for shloka:', currentShlokaNumber, currentShloka); // Debug log
                             } else if (currentShloka.length > 0 && !matchingShlokaNumbers.includes(currentShlokaNumber)) {
                                 console.log('No match in BG_Sringeri.txt for shloka number:', currentShlokaNumber); // Debug log
                             }
                             if (debugShlokas.includes(normalizedLineStart)) {
                                 debugContent.push({ number: normalizedLineStart, text: [line] });
                             }
                             currentShloka = [line];
                             currentShlokaNumber = normalizedLineStart;
                         } else if (currentShloka.length > 0 && line) {
                             currentShloka.push(line);
                             if (debugShlokas.includes(currentShlokaNumber)) {
                                 debugContent[debugContent.length - 1].text.push(line);
                             }
                         } else if (currentShloka.length > 0) {
                             if (matchingShlokaNumbers.includes(currentShlokaNumber)) {
                                 results.push(currentShloka.map(line => highlightText(line, normalizedSearchInput)).join('<br>'));
                                 console.log('English match found for shloka:', currentShlokaNumber, currentShloka); // Debug log
                             } else if (!matchingShlokaNumbers.includes(currentShlokaNumber)) {
                                 console.log('No match in BG_Sringeri.txt for shloka number:', currentShlokaNumber); // Debug log
                             }
                             currentShloka = [];
                             currentShlokaNumber = null;
                         }
                     }
                     // Check the last shloka
                     if (currentShloka.length > 0 && matchingShlokaNumbers.includes(currentShlokaNumber)) {
                         results.push(currentShloka.map(line => highlightText(line, normalizedSearchInput)).join('<br>'));
                         console.log('English match found for last shloka:', currentShlokaNumber, currentShloka); // Debug log
                     } else if (currentShloka.length > 0 && !matchingShlokaNumbers.includes(currentShlokaNumber)) {
                         console.log('No match in BG_Sringeri.txt for last shloka number:', currentShlokaNumber); // Debug log
                     }
         
                     console.log('Detected shloka numbers in BG_Sringeri.txt:', detectedNumbers.slice(0, 10)); // Debug first 10 numbers
                     console.log('Debug shlokas (1.1, 1.2, 1.4, 5.7, 5.10) in BG_Sringeri.txt:', debugContent); // Debug log
         
                     if (results.length > 0) {
                         // Sort results by shloka number
                         results.sort((a, b) => {
                             const [aChapter, aVerse] = a.split(/[\s\t]+/)[0].trim().split('.').map(Number);
                             const [bChapter, bVerse] = b.split(/[\s\t]+/)[0].trim().split('.').map(Number);
                             return aChapter === bChapter ? aVerse - bVerse : aChapter - bChapter;
                         });
                         const resultText = results.join('<br><br>');
                         sgsOutput.innerHTML = resultText;
                         sringeriOutput.innerHTML = resultText;
                         console.log('English search results:', results); // Debug log
                     } else {
                         sgsOutput.innerHTML = `No shlokas found for "${searchInput}".`;
                         sringeriOutput.innerHTML = `No shlokas found for "${searchInput}".`;
                         console.log('No English results for:', searchInput); // Debug log
                     }
                 }
             }
         
             // Auto-expand textboxes based on content
             [sgsOutput, sringeriOutput].forEach(el => {
                 el.style.height = 'auto'; // Reset height
                 el.style.height = `${el.scrollHeight}px`; // Expand to fit content
             });
         }
         
         // Add event listener to the search button
         document.getElementById('search-button').addEventListener('click', performSearch);
         
         // Optional: Add enter key support for search
         document.getElementById('search-input').addEventListener('keypress', (event) => {
             if (event.key === 'Enter') {
                 performSearch();
             }
         });
         // Wrap each shloka/line in a block div for vertical stacking
         function setResults(linesArray) {
           const html = linesArray.map(line => `<div>${line}</div>`).join('');
           document.getElementById("sgsText").innerHTML = html;
           document.getElementById("sringeriText").innerHTML = html;
         }
         
         // Adjust container heights after content change
         function adjustTextboxHeight() {
           ['sgsText', 'sringeriText'].forEach(id => {
             const el = document.getElementById(id);
             el.style.height = 'auto';
             el.style.height = `${el.scrollHeight}px`;
           });
         }
         
         // Load files when the page loads
         document.addEventListener('DOMContentLoaded', loadFiles);
         
         
         
         
         
         
                  
           // Verses per chapter in Bhagavad Gita
           const versesPerChapter = [47, 72, 43, 42, 29, 47, 30, 28, 34, 42, 55, 20, 35, 27, 20, 24, 28, 78];
         
           // Function to calculate line index for chapter and verse (0-based)
           function calculateLineIndex(chapter, verse) {
             let index = 0;
             for (let i = 1; i < chapter; i++) {
               index += versesPerChapter[i - 1];
             }
             index += verse - 1;
             return index;
           }
         
           // Initialize event listeners
           document.addEventListener('DOMContentLoaded', () => {
             loadFiles();
         
             const btn = document.getElementById('search-button');
             if (btn) btn.addEventListener('click', performSearch);
         
             const input = document.getElementById('search-input');
             if (input) input.addEventListener('keypress', e => {
               if (e.key === 'Enter') performSearch();
             });
             // Tour starts only when user taps the 'Help' button.
          });
         
         
         
                  
                  
                           console.log('Script loaded at', new Date('2025-08-17T12:18:00+05:30').toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }));
                           
                           //const baseUrl = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main';
                           //const verseCounts = {
                            //   1: 47, 2: 72, 3: 43, 4: 42, 5: 29, 6: 47, 7: 30, 8: 28,
                           //    9: 34, 10: 42, 11: 55, 12: 20, 13: 34, 14: 27, 15: 20,
                           //    16: 24, 17: 28, 18: 78
                          // };
                           
                           //let isContinuousPlaying = false;
                           let continuousPlayInterval = null;
                           //let isInstructionsVisible = false;
                           //let previousText = '';
                           //let isShowingMeanings = false;
                           //let sessionId = 'session-' + Math.random().toString(36).substr(2, 9);
                           //let currentContext = [];
                           
         
         
                           function initialize() {
                               try {
                                   console.log('Initializing Bhagavad Gita Bot');
                                   localStorage.removeItem('gitaSessionId');
                                   localStorage.removeItem('gitaContext');
                                   console.log('Cleared localStorage (gitaSessionId, gitaContext)');
                                   localStorage.setItem('gitaSessionId', sessionId);
                                   adjustTextboxHeight();
                                   updateTextboxVisibility();
                               } catch (error) {
                                   console.error('Initialization error:', error);
                               }
                           }
                           
                           // Intro.js tour instance (new API)
                          let tourInstance = null;
                          function buildTourInstance() {
                              if (typeof introJs === 'undefined' || typeof introJs.tour !== 'function') {
                                  console.error('Intro.js library not loaded or tour API unavailable');
                                  return null;
                              }
                              const t = introJs.tour();
                              t.setOptions({
                                  showProgress: true,
                                  showBullets: false,
                                  exitOnOverlayClick: true,
                                  disableInteraction: false,
                                  nextLabel: 'Next',
                                  prevLabel: 'Back',
                                  skipLabel: 'Skip',
                                  doneLabel: 'Done',
                                  tooltipClass: 'introjs-tooltip--custom',
                                  highlightClass: 'introjs-highlight--custom'
                              });
                              // Dynamically add steps from elements carrying data-intro
                              const stepEls = Array.from(document.querySelectorAll('[data-intro]'));
                              stepEls.forEach(el => {
                                  const intro = el.getAttribute('data-intro') || '';
                                  const title = el.getAttribute('data-title') || '';
                                  try { t.addStep({ element: el, title, intro }); } catch (_) { /* ignore invalid elements */ }
                              });
                              return t;
                          }
                          
                          function toggleInstructions() {
                              try {
                                  console.log('toggleInstructions (tour) called');
                                  const instructionsButton = document.getElementById('instructionsButton');
                                  const audioPlayer = document.getElementById('audioPlayer');
                                  // Pause any ongoing playback
                                  if (audioPlayer && !audioPlayer.paused) {
                                      audioPlayer.pause();
                                  }
                                  isContinuousPlaying = false;
                                  // Build a fresh tour instance using data-intro elements
                                  tourInstance = buildTourInstance();
                                  if (!tourInstance) return;
                                  const resetUI = () => {
                                      isTourActive = false;
                                      if (instructionsButton) instructionsButton.textContent = 'Help';
                                      adjustTextboxHeight();
                                      updateTextboxVisibility();
                                  };
                                  tourInstance.onbeforeexit(() => { resetUI(); });
                                  tourInstance.onexit(() => { resetUI(); });
                                  tourInstance.oncomplete(() => { resetUI(); });
                                  if (instructionsButton) instructionsButton.textContent = 'Close Tour';
                                  isTourActive = true;
                                  tourInstance.start();
                              } catch (error) {
                                  console.error('Error in toggleInstructions (tour):', error);
                              }
                          }

          // Fetch audio URL
          async function fetchAudioUrl(chapter, verse, quarter = null, isFull = false) {
             try {
                 console.log(`fetchAudioUrl: chapter=${chapter}, verse=${verse}, quarter=${quarter}, isFull=${isFull}`);
                 const style = getSelectedStyle();
                 const key = `${chapter}.${verse}`;
                 let url;
                 if (isFull) {
                     const folder = style === 'sringeri' ? 'AudioFullSringeri' : 'AudioFullSGS';
                     url = `${baseUrl}/${folder}/${key}.mp3`;
                 } else if (quarter === 'pada1') {
                     url = `${baseUrl}/AQ4PaadasSGS/Chapter ${chapter}/${verse}.1.mp3`;
                 } else if (quarter === 'pada3') {
                     const folder = style === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
                     url = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.3.mp3`;
                 } else if (quarter === 'pada1_or_pada3') {
                     const folder = style === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
                     const pada = Math.random() < 0.5 ? '1' : '3';
                     url = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.${pada}.mp3`;
                 } else {
                     const folder = style === 'sringeri' ? 'AudioFullSringeri' : 'AudioFullSGS';
                     url = `${baseUrl}/${folder}/${key}.mp3`;
                 }
                 const response = await fetch(url, { method: 'HEAD' });
                 if (!response.ok) throw new Error(`Audio not found: ${url}`);
                 return url;
             } catch (error) {
                 console.error(`fetchAudioUrl: Error for ${chapter}.${verse}: ${error.message}`);
                 return { error: `Audio not found for ${chapter}.${verse}` };
             }
         }
                           async function fetchShlokaText(chapter, verse, style) {
                               try {
                                   console.log(`fetchShlokaText called: chapter=${chapter}, verse=${verse}, style=${style}`);
                                   const url = style === 'sgs'
                                       ? 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG Telugu with Uvacha2.txt'
                                       : 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_Sringeri.txt';
                                   const response = await fetch(url);
                                   if (!response.ok) {
                                       throw new Error(`HTTP error: ${response.status}`);
                                   }
                                   const text = await response.text();
                                   
                                   const lines = text.split('\n');
                                   const key1 = `${chapter}.${verse}`;
                                   const key2 = `${chapter}-${verse}`;
                                   
                                   for (let i = 0; i < lines.length; i++) {
                                       const line = lines[i].trim();
                                       if (line.match(new RegExp(`^${key1}\\s+|^${key2}\\s+|^${key1}\\t|^${key2}\\t|^${key1}$|^${key2}$`))) {
                                           let shlokaLines = [line.substring(line.indexOf(' ') + 1 || line.indexOf('\t') + 1 || line.length).trim()];
                                           let j = i + 1;
                                           while (j < lines.length && !lines[j].match(/^\d+[.-]\d+/)) {
                                               if (lines[j].trim()) {
                                                   shlokaLines.push(lines[j].trim());
                                               }
                                               j++;
                                           }
                                           let shlokaText = shlokaLines.join('\n').trim();
                                           if (!shlokaText) {
                                               console.warn(`Empty shloka text for ${chapter}.${verse}, style=${style}`);
                                               return `Shloka ${chapter}.${verse} not found or empty`;
                                           }
                                           return `${chapter}.${verse} ${shlokaText}`;
                                       }
                                   }
                           
                                   console.warn(`Shloka ${chapter}.${verse} not found in ${url}`);
                                   return `Shloka ${chapter}.${verse} not found`;
                               } catch (error) {
                                   console.error(`Error loading shloka ${chapter}.${verse}: ${error.message}`);
                                   return `Error loading shloka ${chapter}.${verse}: ${error.message}`;
                               }
                           }
                           
                           async function fetchShlokaMeaning(chapter, verse) {
                               try {
                                   console.log(`fetchShlokaMeaning called: chapter=${chapter}, verse=${verse}`);
                                   const url = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/meanings.txt';
                                   const response = await fetch(url);
                                   if (!response.ok) {
                                       throw new Error(`HTTP error: ${response.status}`);
                                   }
                                   const data = await response.json();
                                   const key = `${chapter}.${verse}`;
                                   if (data[key]) {
                                       let meaningText = `${chapter}.${verse} Meaning:\n\nప్రతిపదార్థం (Word-to-Word Meaning):\n`;
                                       const wordToWord = data[key]["ప్రతిపదార్థం"];
                                       if (wordToWord) {
                                           for (const [word, meaning] of Object.entries(wordToWord)) {
                                               meaningText += `${word}: ${meaning}\n`;
                                           }
                                       } else {
                                           meaningText += 'Word-to-word meaning not available\n';
                                       }
                                       meaningText += `\nఅర్థము (Overall Meaning):\n${data[key].అర్థము || 'Overall meaning not available'}`;
                                       return meaningText;
                                   } else {
                                       return `Meaning for ${chapter}.${verse} not found`;
                                   }
                               } catch (error) {
                                   console.error(`Error loading meaning for ${chapter}.${verse}: ${error.message}`);
                                   return `Error loading meaning for ${chapter}.${verse}: ${error.message}`;
                               }
                           }
                           
                           async function handleContinuousPlay(selectElement) {
                               try {
                                   console.log('handleContinuousPlay called');
                                   const chapter = parseInt(selectElement.value);
                                   if (!chapter) {
                                       console.log('No chapter selected');
                                       return;
                                   }
                           
                                   isInstructionsVisible = false;
                                   document.getElementById('instructionsButton').textContent = 'Help';
                                   const sgsText = document.getElementById('sgsText');
                                   const sringeriText = document.getElementById('sringeriText');
                                   const audioPlayer = document.getElementById('audioPlayer');
                                   isContinuousPlaying = true;
                           
                                   if (continuousPlayInterval) {
                                       clearInterval(continuousPlayInterval);
                                   }
                           
                                   let verse = 1;
                                   const playNextVerse = async () => {
                                       if (!isContinuousPlaying || verse > verseCounts[chapter]) {
                                           isContinuousPlaying = false;
                                           selectElement.selectedIndex = 0;
                                           audioPlayer.src = '';
                                           console.log('Continuous play stopped');
                                           return;
                                       }
                           
                                       currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                                       currentContext.push({
                                           name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                                           lifespanCount: 5,
                                           parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: getSelectedStyle(), showingMeaning: false }
                                       });
                                       localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                                       console.log(`handleContinuousPlay: Updated context for ${chapter}.${verse}`);
                           
                                       const [sgsShloka, sringeriShloka] = await Promise.all([
                                           fetchShlokaText(chapter, verse, 'sgs'),
                                           fetchShlokaText(chapter, verse, 'sringeri')
                                       ]);
                                       sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                                       sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                                       adjustTextboxHeight();
                                       updateTextboxVisibility();
                           
                                       const audioUrl = getSelectedStyle() === 'sringeri' 
                                           ? `${baseUrl}/AudioFullSringeri/${chapter}.${verse}.mp3`
                                           : `${baseUrl}/AudioFullSGS/${chapter}.${verse}.mp3`;
                                       audioPlayer.src = audioUrl;
                                       try {
                                           audioPlayer.load();
                                           await audioPlayer.play();
                                       } catch (error) {
                                           const errorText = `${sgsText.innerText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                                           sgsText.innerText = errorText;
                                           sringeriText.innerText = errorText;
                                           adjustTextboxHeight();
                                           console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                                       }
                           
                                       audioPlayer.onended = () => {
                                           verse++;
                                           playNextVerse();
                                       };
                                   };
                           
                                   await playNextVerse();
                                   selectElement.selectedIndex = 0;
                               } catch (error) {
                                   console.error('Error in handleContinuousPlay:', error);
                                   const sgsText = document.getElementById('sgsText');
                                   const sringeriText = document.getElementById('sringeriText');
                                   sgsText.innerText = `Error in continuous play: ${error.message}`;
                                   sringeriText.innerText = `Error in continuous play: ${error.message}`;
                                   adjustTextboxHeight();
                               }
                           }
                           
                           function showVerseTable() {
                               try {
                                   console.log('showVerseTable called');
                                   isInstructionsVisible = false;
                                   document.getElementById('instructionsButton').textContent = 'Help';
                                   const modal = document.getElementById('verseTableModal');
                                   const chapterSelect = document.getElementById('chapterTableSelect');
                                   chapterSelect.value = '';
                                   updateVerseGrid();
                                   modal.style.display = 'flex';
                               } catch (error) {
                                   console.error('Error in showVerseTable:', error);
                               }
                           }
                           
                           function updateVerseGrid() {
                               try {
                                   console.log('updateVerseGrid called');
                                   const chapter = parseInt(document.getElementById('chapterTableSelect').value);
                                   const content = document.getElementById('verseTableContent');
                                   content.innerHTML = '';
                           
                                   if (chapter) {
                                       const verseGrid = document.createElement('div');
                                       verseGrid.className = 'verse-grid';
                                       for (let verse = 1; verse <= verseCounts[chapter]; verse++) {
                                           const verseButton = document.createElement('div');
                                           verseButton.className = 'verse-button';
                                           verseButton.textContent = `${chapter}.${verse}`;
                                           verseButton.onclick = () => selectVerse(chapter, verse);
                                           verseGrid.appendChild(verseButton);
                                       }
                                       content.appendChild(verseGrid);
                                   }
                               } catch (error) {
                                   console.error('Error in updateVerseGrid:', error);
                               }
                           }
                           
                           function closeVerseTable() {
                               try {
                                   console.log('closeVerseTable called');
                                   document.getElementById('verseTableModal').style.display = 'none';
                               } catch (error) {
                                   console.error('Error in closeVerseTable:', error);
                               }
                           }
                           
                           async function selectVerse(chapter, verse) {
                               try {
                                   console.log(`selectVerse called: chapter=${chapter}, verse=${verse}`);
                                   isContinuousPlaying = false;
                                   isInstructionsVisible = false;
                                   document.getElementById('instructionsButton').textContent = 'Help';
                                   const sgsText = document.getElementById('sgsText');
                                   const sringeriText = document.getElementById('sringeriText');
                                   currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                                   currentContext.push({
                                       name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                                       lifespanCount: 5,
                                       parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: getSelectedStyle(), showingMeaning: false }
                                   });
                                   localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                                   console.log('selectVerse: Updated context:', JSON.stringify(currentContext));
                                   
                                   const [sgsShloka, sringeriShloka] = await Promise.all([
                                       fetchShlokaText(chapter, verse, 'sgs'),
                                       fetchShlokaText(chapter, verse, 'sringeri')
                                   ]);
                                   sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                                   sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                                   adjustTextboxHeight();
                                   
                                   const audioUrl = await fetchAudioUrl(chapter, verse);
                                   const audioPlayer = document.getElementById('audioPlayer');
                                   audioPlayer.src = audioUrl;
                                   try {
                                       audioPlayer.load();
                                       await audioPlayer.play();
                                   } catch (error) {
                                       const errorText = `${sgsText.innerText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                                       sgsText.innerText = errorText;
                                       sringeriText.innerText = errorText;
                                       adjustTextboxHeight();
                                       console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                                   }
                                   
                                   updateTextboxVisibility();
                                   closeVerseTable();
                               } catch (error) {
                                   console.error('Error in selectVerse:', error);
                                   const sgsText = document.getElementById('sgsText');
                                   const sringeriText = document.getElementById('sringeriText');
                                   sgsText.innerText = `Error selecting verse: ${error.message}`;
                                   sringeriText.innerText = `Error selecting verse: ${error.message}`;
                                   adjustTextboxHeight();
                               }
                           }
                           
                           async function handlePreviousShloka() {
                               try {
                                   console.log('handlePreviousShloka called');
                                   isContinuousPlaying = false;
                                   isInstructionsVisible = false;
                                   document.getElementById('instructionsButton').textContent = 'Help';
                                   const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                                   const sgsText = document.getElementById('sgsText');
                                   const sringeriText = document.getElementById('sringeriText');
                                   if (context && context.parameters && Number.isInteger(context.parameters.chapter) && Number.isInteger(context.parameters.verse)) {
                                       let chapter = Math.floor(context.parameters.chapter);
                                       let verse = Math.floor(context.parameters.verse) - 1;
                                       if (verse < 1) {
                                           chapter -= 1;
                                           if (chapter < 1) {
                                               chapter = 1;
                                               verse = 1;
                                           } else {
                                               verse = verseCounts[chapter];
                                           }
                                       }
                                       currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                                       currentContext.push({
                                           name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                                           lifespanCount: 5,
                                           parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: getSelectedStyle(), showingMeaning: false }
                                       });
                                       localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                                       console.log('handlePreviousShloka: Updated context:', JSON.stringify(currentContext));
                                       
                                       const [sgsShloka, sringeriShloka] = await Promise.all([
                                           fetchShlokaText(chapter, verse, 'sgs'),
                                           fetchShlokaText(chapter, verse, 'sringeri')
                                       ]);
                                       sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                                       sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                                       adjustTextboxHeight();
                                       
                                       const audioUrl = getSelectedStyle() === 'sringeri' 
                                           ? `${baseUrl}/AudioFullSringeri/${chapter}.${verse}.mp3`
                                           : `${baseUrl}/AudioFullSGS/${chapter}.${verse}.mp3`;
                                       const audioPlayer = document.getElementById('audioPlayer');
                                       audioPlayer.src = audioUrl;
                                       audioPlayer.load(); // No autoplay
                                       
                                       updateTextboxVisibility();
                                   } else {
                                       sgsText.innerText = 'Please select a Shloka first';
                                       sringeriText.innerText = 'Please select a Shloka first';
                                       adjustTextboxHeight();
                                       updateTextboxVisibility();
                                   }
                               } catch (error) {
                                   console.error('Error in handlePreviousShloka:', error);
                                   const sgsText = document.getElementById('sgsText');
                                   const sringeriText = document.getElementById('sringeriText');
                                   sgsText.innerText = `Error in previous shloka: ${error.message}`;
                                   sringeriText.innerText = `Error in previous shloka: ${error.message}`;
                                   adjustTextboxHeight();
                               }
                           }
                           
                           async function handleMeanings() {
                               try {
                                   console.log('handleMeanings called');
                                   isContinuousPlaying = false;
                                   isInstructionsVisible = false;
                                   const meaningsButton = document.getElementById('meaningsButton');
                                   const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                                   const sgsText = document.getElementById('sgsText');
                                   const sringeriText = document.getElementById('sringeriText');
                                   if (context && context.parameters && Number.isInteger(context.parameters.chapter) && Number.isInteger(context.parameters.verse)) {
                                       const chapter = Math.floor(context.parameters.chapter);
                                       const verse = Math.floor(context.parameters.verse);
                                       
                                       if (!isShowingMeanings) {
                                           previousText = sgsText.innerText;
                                           const meaningText = await fetchShlokaMeaning(chapter, verse);
                                           sgsText.innerText = meaningText || `Meaning for ${chapter}.${verse} not found`;
                                           sringeriText.innerText = meaningText || `Meaning for ${chapter}.${verse} not found`;
                                           meaningsButton.textContent = 'Close Meanings';
                                           isShowingMeanings = true;
                                       } else {
                                           sgsText.innerText = previousText || 'Your Shloka will appear here.';
                                           sringeriText.innerText = previousText || 'Your Shloka will appear here.';
                                           meaningsButton.textContent = 'Meanings';
                                           isShowingMeanings = false;
                                       }
                                       adjustTextboxHeight();
                                       updateTextboxVisibility();
                                   } else {
                                       sgsText.innerText = 'Please select a Shloka first';
                                       sringeriText.innerText = 'Please select a Shloka first';
                                       adjustTextboxHeight();
                                       updateTextboxVisibility();
                                   }
                               } catch (error) {
                                   console.error('Error in handleMeanings:', error);
                                   const sgsText = document.getElementById('sgsText');
                                   const sringeriText = document.getElementById('sringeriText');
                                   sgsText.innerText = `Error fetching meanings: ${error.message}`;
                                   sringeriText.innerText = `Error fetching meanings: ${error.message}`;
                                   adjustTextboxHeight();
                               }
                           }
         // Show confusing shlokas
         async function showConfusing() {
             console.log('showConfusing: Called');
             isContinuousPlaying = false;
             isInstructionsVisible = false;
             isShowingMeanings = false;
             currentAllShlokas = [];
             const instructionsButton = document.getElementById('instructionsButton');
             const meaningsButton = document.getElementById('meaningsButton');
             if (instructionsButton) instructionsButton.textContent = 'Help';
            if (meaningsButton) meaningsButton.textContent = 'Meanings';
            const sgsText = document.getElementById('sgsText');
            const sringeriText = document.getElementById('sringeriText');
             const audioPlayer = document.getElementById('audioPlayer');
         
             const randomGroupIndex = Math.floor(Math.random() * confusingShlokaGroups.length);
             const selectedGroup = confusingShlokaGroups[randomGroupIndex];
             currentAllShlokas = selectedGroup.slice();
             const relatedShlokas = new Set(selectedGroup);
             confusingShlokaGroups.forEach((group, index) => {
                 if (index !== randomGroupIndex && group.some(shloka => selectedGroup.includes(shloka))) {
                     group.forEach(s => relatedShlokas.add(s));
                 }
             });
             const allShlokas = Array.from(relatedShlokas).sort((a, b) => {
                 const [aChapter, aVerse] = a.split('.').map(Number);
                 const [bChapter, bVerse] = b.split('.').map(Number);
                 return aChapter === bChapter ? aVerse - bVerse : aChapter - bChapter;
             });
         
             const shlokaTexts = await Promise.all(allShlokas.map(async shloka => {
                 const [chapter, verse] = shloka.split('.').map(Number);
                 return fetchShlokaText(chapter, verse, selectedStyle);
             }));
         const textOutput = shlokaTexts.map(text => `<div>${text}</div>`).join('');
             sgsText.innerHTML = highlightText(textOutput, '');
             sringeriText.innerHTML = highlightText(textOutput, '');
             adjustTextboxHeight();
             updateTextboxVisibility();
         
             // Play audio for all related shlokas (including overlaps), not just the initially selected group
             console.log('showConfusing: Audio play order =', allShlokas.join(', '));
             for (const shloka of allShlokas) {
                 const [chapter, verse] = shloka.split('.').map(Number);
                 const audioUrl = await fetchAudioUrl(chapter, verse, 'isFull', false);
                 if (!audioUrl.error) {
                     audioPlayer.src = audioUrl;
                     await new Promise(resolve => {
                         audioPlayer.onended = resolve;
                         audioPlayer.play().catch(error => {
                             console.error(`showConfusing: Error playing audio for ${shloka}: ${error.message}`);
                             sgsText.innerHTML += `<br>Error playing audio for ${shloka}: ${error.message}`;
                             sringeriText.innerHTML += `<br>Error playing audio for ${shloka}: ${error.message}`;
                             adjustTextboxHeight();
                             resolve();
                         });
                     });
                 } else {
                     sgsText.innerHTML += `<br>${audioUrl.error}`;
                     sringeriText.innerHTML += `<br>${audioUrl.error}`;
                     adjustTextboxHeight();
                 }
             }
         
             const [chapter, verse] = selectedGroup[0].split('.').map(Number);
             currentContext = [{ name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`, lifespanCount: 5, parameters: { chapter, verse, style: selectedStyle } }];
             localStorage.setItem('gitaContext', JSON.stringify(currentContext));
         }
         
         
         
             // Show uvacha shlokas
                 async function showUvacha() {
                     console.log('showUvacha: Called');
                     isContinuousPlaying = false;
                     isInstructionsVisible = false;
                     isShowingMeanings = false;
                     const instructionsButton = document.getElementById('instructionsButton');
                     const meaningsButton = document.getElementById('meaningsButton');
                     if (instructionsButton) instructionsButton.textContent = 'Help';
                    if (meaningsButton) meaningsButton.textContent = 'Meanings';
                    const audioPlayer = document.getElementById('audioPlayer');
                    const activeTextbox = getSelectedStyle() === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
         
                     if (!audioPlayer || !activeTextbox) {
                         console.error('showUvacha: Missing audioPlayer or activeTextbox');
                         return;
                     }
         
                     const randomIndex = Math.floor(Math.random() * uvachaShlokas.length);
                     const shloka = uvachaShlokas[randomIndex];
                     const [chapter, verse] = shloka.split('.').map(Number);
                     const shlokaText = await fetchShlokaText(chapter, verse, getSelectedStyle());
                     activeTextbox.innerText = shlokaText || `Shloka ${shloka} not found`;
                     adjustTextboxHeight();
                     updateTextboxVisibility();
         
                     const audioUrl = await fetchAudioUrl(chapter, verse, null, true);
                     if (audioUrl.error) {
                         activeTextbox.innerText += `\n${audioUrl.error}`;
                         adjustTextboxHeight();
                         return;
                     }
                     audioPlayer.src = audioUrl;
                     audioPlayer.play().catch(error => {
                         activeTextbox.innerText += `\nError playing audio for ${shloka}: ${error.message}`;
                         adjustTextboxHeight();
                     });
         
                     currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                     currentContext.push({
                         name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                         lifespanCount: 5,
                         parameters: { chapter, verse, style: getSelectedStyle(), showingMeaning: false }
                     });
                     localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                 }
         
         
         
         
         
         // Handle chapter select                  
                           async function handleChapterSelect(selectElement) {
                               try {
                                   console.log('handleChapterSelect called');
                                   isContinuousPlaying = false;
                                   isInstructionsVisible = false;
                                   document.getElementById('instructionsButton').textContent = 'Help';
                                   const chapter = parseInt(selectElement.value);
                                   if (!chapter) {
                                       console.log('No chapter selected');
                                       return;
                                   }
                           
                                   const verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                                   const sgsText = document.getElementById('sgsText');
                                   const sringeriText = document.getElementById('sringeriText');
                                   currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                                   currentContext.push({
                                       name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                                       lifespanCount: 5,
                                       parameters: { chapter: chapter, verse: verse, style: getSelectedStyle(), showingMeaning: false }
                                   });
                                   localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                                   console.log('handleChapterSelect: Updated context:', JSON.stringify(currentContext));
                           
                                   const [sgsShloka, sringeriShloka] = await Promise.all([
                                       fetchShlokaText(chapter, verse, 'sgs'),
                                       fetchShlokaText(chapter, verse, 'sringeri')
                                   ]);
                                   sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                                   sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                                   adjustTextboxHeight();
                           
                                   const folder = getSelectedStyle() === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
                                   const randomPada = Math.random() < 0.5 ? '1' : '3';
                                   const audioUrl = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.${randomPada}.mp3`;
                                   const audioPlayer = document.getElementById('audioPlayer');
                                   audioPlayer.src = audioUrl;
                                   try {
                                       audioPlayer.load();
                                       await audioPlayer.play();
                                   } catch (error) {
                                       const errorText = `${sgsText.innerText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                                       sgsText.innerText = errorText;
                                       sringeriText.innerText = errorText;
                                       adjustTextboxHeight();
                                       console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                                   }
                           
                                   updateTextboxVisibility();
                                   selectElement.selectedIndex = 0;
                               } catch (error) {
                                   console.error('Error in handleChapterSelect:', error);
                                   const sgsText = document.getElementById('sgsText');
                                   const sringeriText = document.getElementById('sringeriText');
                                   sgsText.innerText = `Error selecting random shloka: ${error.message}`;
                                   sringeriText.innerText = `Error selecting random shloka: ${error.message}`;
                                   adjustTextboxHeight();
                                   updateTextboxVisibility();
                               }
                           }
                           
                           function getSelectedStyle() {
                               try {
                                   const style = document.querySelector('input[name="style"]:checked').value;
                                   console.log(`getSelectedStyle: ${style}`);
                                   return style;
                               } catch (error) {
                                   console.error('Error in getSelectedStyle:', error);
                                   return 'sringeri'; // Default to Sringeri style if error occurs
                               }
                           }
                           
                           function setSelectedStyle(style) {
                               try {
                                   if (style === 'sgs') {
                                       document.getElementById('sgs').checked = true;
                                   } else {
                                       document.getElementById('sringeri').checked = true;
                                   }
                                   updateTextboxVisibility();
                                   console.log(`setSelectedStyle: Set style to ${style}`);
                               } catch (error) {
                                   console.error('Error in setSelectedStyle:', error);
                               }
                           }
                           
         function updateTextboxVisibility() {
           const sgsText = document.getElementById('sgsText');
           const sringeriText = document.getElementById('sringeriText');
           const sgsLabel = document.getElementById('sgsLabel');
           const sringeriLabel = document.getElementById('sringeriLabel');
           const sgsRadio = document.getElementById('sgs');
           const sringeriRadio = document.getElementById('sringeri');
         
           // Make sure texts are synchronized
           if (sgsRadio.checked) {
             sringeriText.innerHTML = sgsText.innerHTML;
         
             sgsText.classList.add('visible');
             sgsText.classList.remove('hidden');
         
             sringeriText.classList.add('hidden');
             sringeriText.classList.remove('visible');
         
             sgsLabel.classList.add('active');
             sringeriLabel.classList.remove('active');
           } else {
             sgsText.innerHTML = sringeriText.innerHTML;
         
             sringeriText.classList.add('visible');
             sringeriText.classList.remove('hidden');
         
             sgsText.classList.add('hidden');
             sgsText.classList.remove('visible');
         
             sringeriLabel.classList.add('active');
             sgsLabel.classList.remove('active');
           }
         
           adjustTextboxHeight();  // fix heights after toggle
         }
         
         
                           
                           async function sendCommand(intent) {
                               try {
                                   console.log(`sendCommand called: intent=${intent}`);
                                   isContinuousPlaying = false;
                                   isInstructionsVisible = false;
                                   isShowingMeanings = false;
                                   document.getElementById('instructionsButton').textContent = 'Help';
                                   document.getElementById('meaningsButton').textContent = 'Meanings';
                                   const sgsText = document.getElementById('sgsText');
                                   const sringeriText = document.getElementById('sringeriText');
                                   const audioPlayer = document.getElementById('audioPlayer');
                                   let chapter, verse, quarter, isFullForQuarter = false, autoplay = true;
                           
                                   if (intent === 'SGSFirstPaada') {
                                       setSelectedStyle('sgs');
                                       quarter = 'pada1';
                                       chapter = Math.floor(Math.random() * 18) + 1;
                                       verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                                       autoplay = true;
                                   } else if (intent === 'SringeriPaada') {
                                       quarter = 'pada1_or_pada3';
                                       chapter = Math.floor(Math.random() * 18) + 1;
                                       verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                                       autoplay = true;
                } else if (intent === 'ThirdPaada') {
                    quarter = 'pada3';
                    chapter = Math.floor(Math.random() * 18) + 1;
                    verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                    autoplay = true;
                                   } else if (intent === 'NextFullShloka') {
                                       const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                                       chapter = context ? Math.floor(context.parameters.chapter) : 1;
                                       verse = context ? Math.floor(context.parameters.verse) + 1 : 1;
                                       if (verse > verseCounts[chapter]) {
                                           chapter++;
                                           verse = 1;
                                           if (chapter > 18) {
                                               chapter = 1;
                                           }
                                       }
                                       autoplay = false;
                                   } else if (intent === 'PreviousShloka') {
                                       const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                                       chapter = context ? Math.floor(context.parameters.chapter) : 1;
                                       verse = context ? Math.floor(context.parameters.verse) - 1 : 1;
                                       if (verse < 1) {
                                           chapter--;
                                           if (chapter < 1) {
                                               chapter = 18;
                                           }
                                           verse = verseCounts[chapter];
                                       }
                                       autoplay = false;
                                   } else if (intent === 'FullShloka') {
                                       const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                                       if (!context || !context.parameters || !Number.isInteger(context.parameters.chapter) || !Number.isInteger(context.parameters.verse)) {
                                           chapter = 1;
                                           verse = 1;
                                       } else {
                                           chapter = Math.floor(context.parameters.chapter);
                                           verse = Math.floor(context.parameters.verse);
                                       }
                                       isFullForQuarter = true;
                                       autoplay = true;
                                   }
                           
                                   currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                                   currentContext.push({
                                       name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                                       lifespanCount: 5,
                                       parameters: { chapter: chapter, verse: verse, style: getSelectedStyle(), showingMeaning: false }
                                   });
                                   localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                                   console.log('sendCommand: Updated context:', JSON.stringify(currentContext));
                           
                                   const [sgsShloka, sringeriShloka] = await Promise.all([
                                       fetchShlokaText(chapter, verse, 'sgs'),
                                       fetchShlokaText(chapter, verse, 'sringeri')
                                   ]);
                                   sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                                   sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                                   adjustTextboxHeight();
                           
                                   const audioUrl = await fetchAudioUrl(chapter, verse, quarter, isFullForQuarter);
                                   if (audioUrl && audioUrl.error) {
                                       sgsText.innerText = `${sgsText.innerText}\n${audioUrl.error}`;
                                       sringeriText.innerText = `${sringeriText.innerText}\n${audioUrl.error}`;
                                       adjustTextboxHeight();
                                       return;
                                   }
                                   audioPlayer.src = audioUrl;
                                   audioPlayer.load();
                                   if (autoplay) {
                                       await audioPlayer.play().catch(error => {
                                           console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                                           sgsText.innerText = `${sgsText.innerText}\nError playing audio: ${error.message}`;
                                           sringeriText.innerText = `${sringeriText.innerText}\nError playing audio: ${error.message}`;
                                           adjustTextboxHeight();
                                       });
                                   }
                                   updateTextboxVisibility();
                               } catch (error) {
                                   console.error('Error in sendCommand:', error);
                                   const sgsText = document.getElementById('sgsText');
                                   const sringeriText = document.getElementById('sringeriText');
                                   sgsText.innerText = `Error: ${error.message}`;
                                   sringeriText.innerText = `Error: ${error.message}`;
                                   adjustTextboxHeight();
                               }
                           }
                           document.querySelectorAll('.top-buttons button').forEach(button => {
                           button.addEventListener('click', () => {
                           button.classList.toggle('clicked');
                           });
                           });
                           
                  document.addEventListener("DOMContentLoaded", function () {
                     const audio = document.getElementById("audioPlayer");
                     const sgsBtn = document.querySelector(".top-buttons .sgs-button");
                     const sringeriBtn = document.querySelector(".top-buttons .sringeri-button");
                  
                     let activeBtn = null; // Track which button was clicked
                  
                     function resetButtons() {
                        [sgsBtn, sringeriBtn].forEach(btn => {
                           if (btn) {
                              btn.classList.remove("sgs-playing", "sringeri-playing", "reset");
                              btn.classList.add("reset");
                           }
                        });
                     }
                  
                     if (sgsBtn) {
                        sgsBtn.addEventListener("click", function () {
                           activeBtn = sgsBtn;
                        });
                     }
                  
                     if (sringeriBtn) {
                        sringeriBtn.addEventListener("click", function () {
                           activeBtn = sringeriBtn;
                        });
                     }
                  
                     if (audio) {
                        // When audio starts
                        audio.addEventListener("play", function () {
                           resetButtons(); // Clear old states first
                           if (activeBtn === sgsBtn) {
                              sgsBtn.classList.remove("reset");
                              sgsBtn.classList.add("sgs-playing");
                           } else if (activeBtn === sringeriBtn) {
                              sringeriBtn.classList.remove("reset");
                              sringeriBtn.classList.add("sringeri-playing");
                           }
                        });
                  
                        // When audio ends
                        audio.addEventListener("ended", function () {
                           resetButtons();
                           activeBtn = null; // clear after playback ends
                        });
                     }
                  });
                      
         			 initialize();
           document.addEventListener('DOMContentLoaded', () => {
             loadFiles().then(() => {
               updateTextboxVisibility();
               adjustTextboxHeight();
               // Comment out initial search on load to test responsiveness
               // performSearch();
             });
           
             document.getElementById('groupButton').onclick = () => {
             window.open('https://pubsaroja.github.io/gita-voice-bot-web/GroupedShlokas.html', '_blank');
            };
         });
               
      </script>
      </div>
  </body>
</html>
