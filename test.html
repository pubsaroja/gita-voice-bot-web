<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Bhagavad Gita Bot</title>
      <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu&family=Noto+Sans+Devanagari&family=Noto+Sans+Kannada&family=Noto+Sans+Tamil&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
      <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
      <style>
         :root { --bg:#f0f0f0; --text:#2c3e50; --card:#fff; --border:#357EC7; --btn:#357EC7; --btn-txt:#fff; --hover:#1e40af; }
         [data-theme="dark"] { --bg:#1a1a1a; --text:#fff; --card:#2a2a2a; --border:#4a90e2; --btn:#4a90e2; --hover:#357abd; }
         * { box-sizing: border-box; }
         body { font-family: Outfit, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; text-align: center; }
         .page { max-width: 900px; margin: 0 auto; background: var(--card); border: 2px solid var(--border); border-radius: 12px; padding: 20px; }
         .top-btns { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
         .top-btns button { width: 140px; height: 140px; border-radius: 50%; border: none; background: var(--btn); color: var(--btn-txt); font-size: 1.1em; cursor: pointer; }
         .top-btns button:hover { background: var(--hover); }
         #audioPlayer { width: 100%; margin: 15px 0; }
         .style-radio { display: flex; justify-content: center; gap: 20px; margin: 10px 0; }
         .lang-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; margin: 15px 0; }
         .lang-grid label { display: flex; align-items: center; gap: 5px; }
         .textbox { border: 2px solid var(--border); border-radius: 8px; padding: 12px; margin: 15px 0; min-height: 120px; font-size: 1.4em; line-height: 1.6; text-align: center; background: var(--card); white-space: pre-wrap; }
         #sgsBox { display: none; }
         .player-btns { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin: 20px 0; }
         .player-btns button { padding: 12px; font-size: 1em; background: var(--btn); color: var(--btn-txt); border: none; border-radius: 50px; cursor: pointer; }
         .theme-toggle { position: fixed; top: 10px; right: 10px; display: flex; gap: 10px; z-index: 999; }
         .theme-toggle button { background: none; border: none; font-size: 24px; cursor: pointer; }
      </style>
   </head>
   <body>

      <div class="theme-toggle">
         <button id="light">Light</button>
         <button id="dark">Dark</button>
      </div>

      <div class="page">
         <h1>Srimad Bhagavad Gita</h1>
         <p>Listen, understand and memorize shlokas</p>

         <div class="top-btns">
            <button onclick="sendCommand('SGSFirstPaada')">1st Paada<br>Only</button>
            <button onclick="sendCommand('SringeriPaada')">1st or 3rd Paada</button>
            <button onclick="sendCommand('ThirdPaada')">3rd Paada<br>Only</button>
         </div>

         <audio id="audioPlayer" controls></audio>

         <div class="style-radio">
            <label><input type="radio" name="style" value="sgs" onchange="switchStyle()"> SGS</label>
            <label><input type="radio" name="style" value="sringeri" checked onchange="switchStyle()"> Sringeri</label>
         </div>

         <div class="lang-grid">
            <label><input type="checkbox" name="lang" value="te" checked> Telugu</label>
            <label><input type="checkbox" name="lang" value="sa"> Devanagari</label>
            <label><input type="checkbox" name="lang" value="kn"> Kannada</label>
            <label><input type="checkbox" name="lang" value="ta"> Tamil</label>
            <label><input type="checkbox" name="lang" value="en"> English</label>
         </div>

         <div id="sgsBox" class="textbox">Loading...</div>
         <div id="sringeriBox" class="textbox">Loading...</div>

         <div class="player-btns">
            <button onclick="sendCommand('PreviousShloka')">Previous</button>
            <button onclick="sendCommand('FullShloka')">Full</button>
            <button onclick="sendCommand('NextFullShloka')">Next</button>
         </div>

         <div class="player-btns">
            <button onclick="alert('Coming soon!')">Meanings</button>
            <button onclick="alert('Coming soon!')">Selector</button>
            <button onclick="introJs().start()">Help</button>
            <button onclick="window.open('https://pubsaroja.github.io/gita-voice-bot-web/GroupedShlokas.html', '_blank')">Grouped</button>
            <button onclick="showConfusing()">Confusing</button>
            <button onclick="showUvacha()">Uvacha</button>
         </div>
      </div>

      <script>
         const BASE = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/main';

         // === CORRECT FILE NAMES (verified in repo) ===
         const files = {
            te: { sgs: 'BG_Telugu_SGS.txt', sringeri: 'BG_Telugu_Sringeri.txt' },
            sa: { sgs: 'BG_Devanagari_SGS.txt', sringeri: 'BG_Devanagari_Sringeri.txt' },
            kn: { sgs: 'BG_Kannada_SGS.txt', sringeri: 'BG_Kannada_Sringeri.txt' },
            ta: { sgs: 'BG_Tamil_SGS.txt', sringeri: 'BG_Tamil_Sringeri.txt' },
            en: 'BG_English_diacritics.txt'  // DIACRITICS FIXED
         };

         let chapter = 1, verse = 1;
         let style = 'sringeri';
         let paada = null;

         // === AUDIO PATHS (100% correct) ===
         function audioURL(c, v, s, p = null) {
            const cc = c.toString();
            const vv = v.toString().padStart(2, '0');
            if (p) {
               const folder = s === 'sgs' ? 'AQ4PaadasSGS' : 'AQ4PaadasSringeri';
               const pp = p === 'first' ? '1' : '3';
               return `${BASE}/${folder}/Chapter ${cc}/${cc}.${vv}_${pp}.mp3`;
            }
            const folder = s === 'sgs' ? 'AudioFullSGS' : 'AudioFullSringeri';
            return `${BASE}/${folder}/${cc}.${vv}.mp3`;
         }

         async function getText(c, v, s, lang) {
            const url = lang === 'en' ? `${BASE}/${files.en}` : `${BASE}/${files[lang][s]}`;
            try {
               const res = await fetch(url);
               if (!res.ok) return "Error";
               const txt = await res.text();
               const line = txt.split('\n').find(l => l.trim().startsWith(`${c}.${v}`));
               return line ? line.replace(/^[\d\.\-\s]+/, '').trim() : "Not found";
            } catch { return "Failed"; }
         }

         async function showText() {
            const langs = Array.from(document.querySelectorAll('input[name="lang"]:checked')).map(cb => cb.value);
            if (!langs.length) langs.push('te');

            const texts = await Promise.all(langs.map(l => getText(chapter, verse, style, l)));
            const out = texts.map((t, i) => {
               const names = { te: 'Telugu', sa: 'Devanagari', kn: 'Kannada', ta: 'Tamil', en: 'English' };
               return `${chapter}.${verse} (${names[langs[i]]})\n${t}`;
            }).join('\n\n---\n\n');

            document.getElementById('sgsBox').textContent = out;
            document.getElementById('sringeriBox').textContent = out;
            switchStyle();
         }

         function play() {
            const url = audioURL(chapter, verse, style, paada);
            const a = document.getElementById('audioPlayer');
            a.src = url;
            a.play().catch(e => console.log("Play failed (user gesture needed)", e));
         }

         function sendCommand(cmd) {
            console.log("Command:", cmd);
            paada = null;
            if (cmd === 'SGSFirstPaada') { style = 'sgs'; paada = 'first'; }
            if (cmd === 'SringeriPaada') { style = 'sringeri'; paada = Math.random() < 0.5 ? 'first' : 'third'; }
            if (cmd === 'ThirdPaada') { style = 'sringeri'; paada = 'third'; }
            if (cmd === 'PreviousShloka') { verse--; if (verse < 1) { chapter--; verse = 47; } }
            if (cmd === 'NextFullShloka') { verse++; if (verse > 47) { chapter++; verse = 1; } }
            if (cmd === 'FullShloka') { paada = null; }
            chapter = ((chapter - 1 + 17) % 18) + 1;
            play();
            showText();
         }

         function switchStyle() {
            style = document.querySelector('input[name="style"]:checked').value;
            document.getElementById('sgsBox').style.display = style === 'sgs' ? 'block' : 'none';
            document.getElementById('sringeriBox').style.display = style === 'sringeri' ? 'block' : 'none';
         }

         // Language change = text only
         document.querySelectorAll('input[name="lang"]').forEach(cb => cb.addEventListener('change', showText));

         // Confusing & Uvacha
         function showConfusing() {
            const list = [{c:2,v:47},{c:2,v:48},{c:3,v:27},{c:3,v:28}];
            const r = list[Math.floor(Math.random()*list.length)];
            chapter = r.c; verse = r.v; paada = null; style = 'sringeri';
            play(); showText();
         }
         function showUvacha() {
            const list = [{c:1,v:1},{c:2,v:11},{c:11,v:1},{c:18,v:1}];
            const r = list[Math.floor(Math.random()*list.length)];
            chapter = r.c; verse = r.v; paada = null; style = 'sringeri';
            play(); showText();
         }

         // === UNLOCK AUDIO ON FIRST USER CLICK ===
         document.body.addEventListener('click', function unlock() {
            const a = document.getElementById('audioPlayer');
            a.muted = true; a.play().then(() => { a.muted = false; }).catch(() => {});
            document.body.removeEventListener('click', unlock);
         }, { once: true });

         // Init
         window.onload = () => {
            showText();
            // Preload first audio to avoid delay
            const a = document.getElementById('audioPlayer');
            a.src = audioURL(1,1,'sringeri');
         };

         // Theme
         document.getElementById('light').onclick = () => document.documentElement.setAttribute('data-theme', 'light');
         document.getElementById('dark').onclick = () => document.documentElement.setAttribute('data-theme', 'dark');
      </script>
   </body>
</html>
