<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bhagavad Gita Bot – Fixed & Working</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400&family=Noto+Sans+Telugu&family=Noto+Sans+Devanagari&family=Noto+Sans+Kannada&family=Noto+Sans+Tamil&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
<script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
<style>
:root{
   --bg:#f0f0f0;--text:#2c3e50;--card:#fff;--border:#357EC7;--btn:#357EC7;--btn-txt:#fff;
   --hover:#1e40af;--dark-bg:#1a1a1a;--dark-text:#fff;--dark-card:#2a2a2a;--dark-border:#4a90e2;
}
[data-theme="dark"]{--bg:#1a1a1a;--text:#fff;--card:#2a2a2a;--border:#4a90e2;--btn:#4a90e2;--hover:#357abd;}
*,*::before,*::after{box-sizing:border-box;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px;text-align:center;}
h1{color:var(--border);font-size:1.8em;}
.page{max-width:900px;margin:0 auto;background:var(--card);border:2px solid var(--border);border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.1);}
.top-btns{display:flex;gap:15px;justify-content:center;flex-wrap:wrap;margin:20px 0;}
.top-btns button{width:140px;height:140px;border-radius:50%;border:none;background:var(--btn);color:var(--btn-txt);font-size:1.1em;cursor:pointer;transition:.3s;}
.top-btns button:hover{background:var(--hover);}
#audioPlayer{width:100%;margin:15px 0;}
.style-radio{display:flex;justify-content:center;gap:20px;margin:10px 0;}
.lang-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:15px 0;}
.lang-grid label{display:flex;align-items:center;gap:5px;}
.textbox{border:2px solid var(--border);border-radius:8px;padding:12px;margin:15px 0;min-height:120px;font-size:1.4em;line-height:1.6;text-align:center;background:var(--card);}
#sgsBox{display:none;}
#sringeriBox{display:block;}
.hidden{display:none !important;}
.player-btns{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:20px 0;}
.player-btns button{padding:12px;font-size:1em;background:var(--btn);color:var(--btn-txt);border:none;border-radius:50px;cursor:pointer;}
.theme-toggle{position:fixed;top:10px;right:10px;display:flex;gap:10px;z-index:999;}
.theme-toggle button{background:none;border:none;font-size:24px;cursor:pointer;}
</style>
</head>
<body>

<div class="theme-toggle">
   <button id="light">Light</button>
   <button id="dark">Dark</button>
</div>

<div class="page">
   <h1>Srimad Bhagavad Gita</h1>
   <p>Listen, understand and memorize shlokas</p>

   <div class="top-btns">
      <button onclick="sendCommand('SGSFirstPaada')">1st Paada<br>Only</button>
      <button onclick="sendCommand('SringeriPaada')">1st or 3rd Paada</button>
      <button onclick="sendCommand('ThirdPaada')">3rd Paada<br>Only</button>
   </div>

   <audio id="audioPlayer" controls></audio>

   <div class="style-radio">
      <label><input type="radio" name="style" value="sgs" onchange="switchStyle()"> SGS</label>
      <label><input type="radio" name="style" value="sringeri" checked onchange="switchStyle()"> Sringeri</label>
   </div>

   <div class="lang-grid">
      <label><input type="checkbox" name="lang" value="te" checked> Telugu</label>
      <label><input type="checkbox" name="lang" value="sa"> Devanagari</label>
      <label><input type="checkbox" name="lang" value="kn"> Kannada</label>
      <label><input type="checkbox" name="lang" value="ta"> Tamil</label>
      <label><input type="checkbox" name="lang" value="en"> English</label>
   </div>

   <div id="sgsBox" class="textbox hidden">Loading SGS...</div>
   <div id="sringeriBox" class="textbox">Loading Sringeri...</div>

   <div class="player-btns">
      <button onclick="sendCommand('PreviousShloka')">Previous</button>
      <button onclick="sendCommand('FullShloka')">Full</button>
      <button onclick="sendCommand('NextFullShloka')">Next</button>
   </div>
</div>

<script>
const BASE = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/main';

// --- Correct file names (verified in repo) ---
const files = {
   te: {sgs:'BG_Telugu_SGS.txt', sringeri:'BG_Telugu_Sringeri.txt'},
   sa: {sgs:'BG_Devanagari_SGS.txt', sringeri:'BG_Devanagari_Sringeri.txt'},
   kn: {sgs:'BG_Kannada_SGS.txt', sringeri:'BG_Kannada_Sringeri.txt'},
   ta: {sgs:'BG_Tamil_SGS.txt', sringeri:'BG_Tamil_Sringeri.txt'},
   en: 'BG_English_single_line.txt'
};

// --- Global state ---
let chapter = 1, verse = 1;
let style = 'sringeri';
let paadaMode = null; // null | 'first' | 'third'

async function loadFile(url){
   const r = await fetch(url);
   if(!r.ok) throw new Error(`404 ${url}`);
   return await r.text();
}

function audioURL(ch, v, st, paada=null){
   const c = ch.toString();
   const vpad = v.toString().padStart(2,'0');
   if(paada){
      const folder = st==='sgs' ? 'AQ4PaadasSGS' : 'AQ4PaadasSringeri';
      const p = paada==='first'?'1':'3';
      return `${BASE}/${folder}/Chapter ${c}/${c}.${vpad}_${p}.mp3`;
   }
   const folder = st==='sgs' ? 'AudioFullSGS' : 'AudioFullSringeri';
   return `${BASE}/${folder}/${c}.${vpad}.mp3`;
}

async function fetchShloka(ch, v, st, lang){
   try{
      let url;
      if(lang==='en'){
         url = `${BASE}/${files.en}`;
      }else{
         const fname = files[lang][st];
         url = `${BASE}/${fname}`;
      }
      const text = await loadFile(url);
      const regex = new RegExp(`^${ch}\\.${v}\\s`);
      const line = text.split('\n').find(l=>regex.test(l));
      if(!line) return "Not found";
      return line.replace(/^[\d\.\-\s]+/, '').trim();
   }catch(e){
      return "Error loading";
   }
}

async function displayShloka(){
   const langs = Array.from(document.querySelectorAll('input[name="lang"]:checked'))
                 .map(cb=>cb.value);
   if(langs.length===0) langs.push('te');

   const promises = langs.map(l=>fetchShloka(chapter,verse,style,l));
   const results = await Promise.all(promises);

   const html = results.map((txt,i)=>{
      const name = {te:'Telugu',sa:'Devanagari',kn:'Kannada',ta:'Tamil',en:'English'}[langs[i]];
      return `<strong>${chapter}.${verse} (${name})</strong><br>${txt.replace(/\n/g,'<br>')}`;
   }).join('<br><br><hr><br>');

   document.getElementById('sgsBox').innerHTML = html;
   document.getElementById('sringeriBox').innerHTML = html;
   switchStyle();
}

function playAudio(){
   const url = audioURL(chapter,verse,style,paadaMode);
   const a = document.getElementById('audioPlayer');
   a.src = url;
   a.play().catch(()=>console.log("Play blocked – user interaction needed"));
}

function sendCommand(cmd){
   console.log("Command:",cmd);
   paadaMode = null;
   if(cmd==='SGSFirstPaada'){ style='sgs'; paadaMode='first'; }
   if(cmd==='SringeriPaada'){ style='sringeri'; paadaMode=Math.random()<0.5?'first':'third'; }
   if(cmd==='ThirdPaada'){ style='sringeri'; paadaMode='third'; }
   if(cmd==='PreviousShloka'){ verse--; if(verse<1){chapter--;verse=chapter===0?1:47;} }
   if(cmd==='NextFullShloka'){ verse++; if(verse>47){chapter++;verse=1;} }
   if(cmd==='FullShloka'){ paadaMode=null; }
   chapter = ((chapter-1+18)%18)+1;
   playAudio();
   displayShloka();
}

function switchStyle(){
   style = document.querySelector('input[name="style"]:checked').value;
   document.getElementById('sgsBox').classList.toggle('hidden',style!=='sgs');
   document.getElementById('sringeriBox').classList.toggle('hidden',style!=='sringeri');
}

// Language change → only text, no audio replay
document.querySelectorAll('input[name="lang"]').forEach(cb=>{
   cb.addEventListener('change',displayShloka);
});

// Theme
document.getElementById('light').onclick=()=>document.documentElement.setAttribute('data-theme','light');
document.getElementById('dark').onclick=()=>document.documentElement.setAttribute('data-theme','dark');

// Init
window.onload=()=>{
   displayShloka();
   // Play a tiny silent sound to unlock audio on mobile
   const a=document.getElementById('audioPlayer');
   a.volume=0; a.src='data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAA'; a.play();
};
</script>
</body>
</html>
