<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bhagavad Gita Bot</title>
    <link href="https://fonts.googleapis.com/css2?family=Ramabhadra&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
            background-color: #f0f0f0;
        }
        h1 {
            color: #2c3e50;
            font-size: 1.5em;
        }
        h2 {
            color: #34495e;
            font-size: 1em;
            margin-top: 10px;
        }
        p {
            font-size: 12px;
        }         
        .options-buttons, .bottom-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        button {
            background-color: #357EC7;
            color: white;
            padding: 10px 18px;
            margin: 0 auto;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.6em;
            width: 100%;
            max-width: 600px;
            display: block;
        }
        button:hover {
            background-color: #008CBA;
        }
        select {
            padding: 10px;
            margin: 5px;
            font-size: 1em;
            border-radius: 5px;
            width: 100%;
            max-width: 150px;            
        }
        .dropdown-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 600px;
            border: 2px solid #357EC7;
            border-radius: 5px;
            padding: 10px;
            box-sizing: border-box;
            margin: 10px auto;
        }
        .dropdown-container label {
            font-weight: bold;
            margin-right: 5px;
            font-size: 1em;
        }
        .dropdown-container div {
            display: flex;
            align-items: center;
        }
        .shloka-text {
            margin-top: 10px;
            font-size: 1.5em;
            color: #333;
            white-space: pre-wrap;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.5;
            min-height: 3em;
            overflow-y: auto;
            padding: 10px;
            border: 2px solid #357EC7;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-family: 'Ramabhadra', sans-serif;
        }
        .shloka-text.multiline {
            text-align: left;
            display: block;
        }
        #audioPlayer {
            margin: 10px auto;
            display: block;
        }
        .radio-group {
            margin: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .radio-group label {
            margin: 0 10px;
        }
        .textbox-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .textbox-container > div {
            width: 100%;
            max-width: 600px;
        }
        .textbox-label {
            font-weight: bold;
            margin-bottom: 5px;
            display: none;
        }
        .textbox-label.active {
            display: block;
        }
        .shloka-text {
            display: none;
        }
        .shloka-text.active {
            display: flex;
        }
        .shloka-text.active.multiline {
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
            border: 2px solid #357EC7;
        }
        .chapter-select {
            margin-bottom: 10px;
            padding: 10px;
            font-size: 1em;
            border-radius: 5px;
            width: 100%;
            max-width: 200px;
        }
        .verse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            padding: 10px;
        }
        .verse-button {
            background-color: #f9f9f9;
            border: 1px solid #357EC7;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 0.9em;
        }
        .verse-button:hover {
            background-color: #e0e0e0;
        }
        .close-button {
            background-color: #ff4444;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            float: right;
        }
        .close-button:hover {
            background-color: #cc0000;
        }
        @media (max-width: 600px) {
            .options-buttons, .bottom-buttons {
                gap: 8px;
            }
            button {
                padding: 8px 16px;
                font-size: 1.15em;
            }
            .dropdown-container {
                flex-direction: column;
                align-items: center;
                gap: 8px;
                max-width: 100%;
                padding: 8px;
            }
            .dropdown-container div {
                width: 100%;
                max-width: 200px;
                justify-content: center;
            }
            .verse-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            }
        }
    </style>
</head>
<body>
    <h1>Bhagavad Gita Bot</h1>
    
    <div class="options-buttons">
        <button onclick="sendCommand('ZeroIntent', {quarter: 'pada1', style: getSelectedStyle()})">SGS (First Paada)</button>
        <button onclick="sendCommand('ZeroIntent', {quarter: 'pada1_or_pada3', style: getSelectedStyle()})">Sringeri (First or Third Paada)</button>
        <button onclick="sendCommand('NextIntent', {style: getSelectedStyle()})">Next Full Shloka</button>
        <button id="previousButton" onclick="handlePreviousShloka()">Previous Shloka</button>
        <button onclick="sendCommand('FullIntent', {style: getSelectedStyle(), isFullForQuarter: true})">Full Shloka of Quarter</button>
    </div>
    
    <audio id="audioPlayer" controls></audio>
    
    <div class="dropdown-container">
        <div>
            <label for="chapterSelect">Select Chapter:</label>
            <select id="chapterSelect" onchange="handleChapterSelect(this)">
                <option value="" selected disabled>-- Select Chapter --</option>
                <option value="1">1. అర్జునవిషాదయోగః</option>
                <option value="2">2. సాఙ్ఖ్యయోగః</option>
                <option value="3">3. కర్మయోగః</option>
                <option value="4">4. జ్ఞానయోగః</option>
                <option value="5">5. కర్మసన్న్యాసయోగః</option>
                <option value="6">6. ఆత్మసంయమయోగః</option>
                <option value="7">7. జ్ఞానవిజ్ఞానయోగః</option>
                <option value="8">8. అక్షరపరబ్రహ్మయోగః</option>
                <option value="9">9. రాజవిద్యారాజగుహ్యయోగః</option>
                <option value="10">10. విభూతియోగః</option>
                <option value="11">11. విశ్వరూపసన్దర్శనయోగః</option>
                <option value="12">12. భక్తియోగః</option>
                <option value="13">13. క్షేత్రక్షేత్రజ్ఞవిభాగయోగః</option>
                <option value="14">14. గుణత్రయవిభాగయోగః</option>
                <option value="15">15. పురుషోత్తమప్రాప్తియోగః</option>
                <option value="16">16. దైవాసురసమ్పద్విభాగయోగః</option>
                <option value="17">17. శ్రద్ధాత్రయవిభాగయోగః</option>
                <option value="18">18. మోక్షసన్న్యాసయోగః</option>
            </select>
        </div>
        <div>
            <label for="continuousPlaySelect">Continuous Play:</label>
            <select id="continuousPlaySelect" onchange="handleContinuousPlay(this)">
                <option value="" selected disabled>-- Select Chapter --</option>
                <option value="1">1. అర్జునవిషాదయోగః</option>
                <option value="2">2. సాఙ్ఖ్యయోగః</option>
                <option value="3">3. కర్మయోగః</option>
                <option value="4">4. జ్ఞానయోగః</option>
                <option value="5">5. కర్మసన్న్యాసయోగః</option>
                <option value="6">6. ఆత్మసంయమయోగః</option>
                <option value="7">7. జ్ఞానవిజ్ఞానయోగః</option>
                <option value="8">8. అక్షరపరబ్రహ్మయోగః</option>
                <option value="9">9. రాజవిద్యారాజగుహ్యయోగః</option>
                <option value="10">10. విభూతియోగః</option>
                <option value="11">11. విశ్వరూపసన్దర్శనయోగః</option>
                <option value="12">12. భక్తియోగః</option>
                <option value="13">13. క్షేత్రక్షేత్రజ్ఞవిభాగయోగః</option>
                <option value="14">14. గుణత్రయవిభాగయోగః</option>
                <option value="15">15. పురుషోత్తమప్రాప్తియోగః</option>
                <option value="16">16. దైవాసురసమ్పద్విభాగయోగః</option>
                <option value="17">17. శ్రద్ధాత్రయవిభాగయోగః</option>
                <option value="18">18. మోక్షసన్న్యాసయోగః</option>
            </select>
        </div>
    </div>
    
    <div class="radio-group">
        <label>Full Shloka Style:</label>
        <input type="radio" name="style" value="sgs" id="sgs" onchange="updateTextboxVisibility()">
        <label for="sgs">SGS Style</label>
        <input type="radio" name="style" value="sringeri" id="sringeri" checked onchange="updateTextboxVisibility()">
        <label for="sringeri">Sringeri Style</label>
    </div>
    
    <div class="textbox-container">
        <div>
            <div id="sgsLabel" class="textbox-label">SGS Style Shloka</div>
            <div id="sgsText" class="shloka-text">Your Shloka will appear here.</div>
        </div>
        <div>
            <div id="sringeriLabel" class="textbox-label active">Sringeri Style Shloka</div>
            <div id="sringeriText" class="shloka-text active">Your Shloka will appear here.</div>
        </div>
    </div>
    
    <div class="bottom-buttons">
        <button onclick="handleMeanings()">Meanings</button>
        <button onclick="showVerseTable()">Select Shloka</button>
        <button id="instructionsButton" onclick="toggleInstructions()">Instructions</button>
    </div>
    
    <div id="verseTableModal" class="modal">
        <div class="modal-content">
            <button class="close-button" onclick="closeVerseTable()">Close</button>
            <select id="chapterTableSelect" class="chapter-select" onchange="updateVerseGrid()">
                <option value="" selected disabled>-- Select Chapter --</option>
                <option value="1">Chapter 1 (47 verses)</option>
                <option value="2">Chapter 2 (72 verses)</option>
                <option value="3">Chapter 3 (43 verses)</option>
                <option value="4">Chapter 4 (42 verses)</option>
                <option value="5">Chapter 5 (29 verses)</option>
                <option value="6">Chapter 6 (47 verses)</option>
                <option value="7">Chapter 7 (30 verses)</option>
                <option value="8">Chapter 8 (28 verses)</option>
                <option value="9">Chapter 9 (34 verses)</option>
                <option value="10">Chapter 10 (42 verses)</option>
                <option value="11">Chapter 11 (55 verses)</option>
                <option value="12">Chapter 12 (20 verses)</option>
                <option value="13">Chapter 13 (34 verses)</option>
                <option value="14">Chapter 14 (27 verses)</option>
                <option value="15">Chapter 15 (20 verses)</option>
                <option value="16">Chapter 16 (24 verses)</option>
                <option value="17">Chapter 17 (28 verses)</option>
                <option value="18">Chapter 18 (78 verses)</option>
            </select>
            <div id="verseTableContent" class="verse-grid"></div>
        </div>
    </div>
    
    <script>
        console.log('Script loaded at', new Date().toLocaleString());

        const verseCounts = {
            1: 47, 2: 72, 3: 43, 4: 42, 5: 29, 6: 47, 7: 30, 8: 28,
            9: 34, 10: 42, 11: 55, 12: 20, 13: 34, 14: 27, 15: 20,
            16: 24, 17: 28, 18: 78
        };

        let isContinuousPlaying = false;
        let continuousPlayInterval = null;
        let isInstructionsVisible = false;
        let sessionId = 'session-' + Math.random().toString(36).substr(2, 9);
        let currentContext = [];

        function initialize() {
            try {
                console.log('Initializing Bhagavad Gita Bot');
                localStorage.removeItem('gitaSessionId');
                localStorage.removeItem('gitaContext');
                console.log('Cleared localStorage (gitaSessionId, gitaContext)');
                localStorage.setItem('gitaSessionId', sessionId);
                adjustTextboxHeight();
                updateTextboxVisibility();
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        function toggleInstructions() {
            try {
                console.log('toggleInstructions called');
                isContinuousPlaying = false;
                const instructionsButton = document.getElementById('instructionsButton');
                const style = getSelectedStyle();
                const activeTextbox = style === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                
                if (!isInstructionsVisible) {
                    fetch('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/instructions.txt')
                        .then(response => {
                            if (!response.ok) throw new Error('Failed to fetch instructions');
                            return response.text();
                        })
                        .then(text => {
                            activeTextbox.innerHTML = text.replace(/\n/g, '<br>');
                            instructionsButton.textContent = 'Close Instructions';
                            isInstructionsVisible = true;
                            adjustTextboxHeight();
                            updateTextboxVisibility();
                        })
                        .catch(error => {
                            console.error('Error fetching instructions:', error);
                            activeTextbox.innerText = `Error loading instructions: ${error.message}`;
                            adjustTextboxHeight();
                            updateTextboxVisibility();
                        });
                } else {
                    activeTextbox.innerText = 'Your Shloka will appear here.';
                    instructionsButton.textContent = 'Instructions';
                    isInstructionsVisible = false;
                    adjustTextboxHeight();
                    updateTextboxVisibility();
                }
            } catch (error) {
                console.error('Error in toggleInstructions:', error);
                const activeTextbox = getSelectedStyle() === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                activeTextbox.innerText = `Error in instructions: ${error.message}`;
                adjustTextboxHeight();
            }
        }

        function adjustTextboxHeight() {
            try {
                console.log('adjustTextboxHeight called');
                const sgsText = document.getElementById('sgsText');
                const sringeriText = document.getElementById('sringeriText');
                [sgsText, sringeriText].forEach(textbox => {
                    textbox.style.height = 'auto';
                    const scrollHeight = textbox.scrollHeight;
                    textbox.style.height = `${scrollHeight}px`;
                    if (textbox.innerText.includes('\n') || textbox.innerHTML.includes('<br>')) {
                        textbox.classList.add('multiline');
                    } else {
                        textbox.classList.remove('multiline');
                    }
                    console.log(`adjustTextboxHeight: ${textbox.id}, scrollHeight: ${scrollHeight}px, multiline: ${textbox.classList.contains('multiline')}`);
                });
            } catch (error) {
                console.error('Error in adjustTextboxHeight:', error);
            }
        }

        async function fetchAudioUrl(chapter, verse, quarter = null, backendAudioUrl = null, isFullForQuarter = false) {
            try {
                console.log(`fetchAudioUrl called: chapter=${chapter}, verse=${verse}, quarter=${quarter}, backendAudioUrl=${backendAudioUrl}, isFullForQuarter=${isFullForQuarter}`);
                const baseUrl = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main';
                const style = getSelectedStyle();
                const key = `${chapter}.${verse}`;
                let audioUrl;
                let errorMessage = '';

                const tryUrl = async (url, type) => {
                    try {
                        console.log(`fetchAudioUrl: Attempting ${type}: ${url}`);
                        const check = await fetch(url, { method: 'HEAD', mode: 'cors' });
                        if (!check.ok) {
                            console.log(`fetchAudioUrl: Failed to fetch ${type}, HTTP status: ${check.status}`);
                            throw new Error(`${type} inaccessible: HTTP ${check.status}`);
                        }
                        console.log(`fetchAudioUrl: Successfully fetched ${type}: ${url}`);
                        return url;
                    } catch (error) {
                        console.log(`fetchAudioUrl: Error for ${type}: ${error.message}`);
                        return null;
                    }
                };

                if (quarter === 'pada1') {
                    audioUrl = await tryUrl(`${baseUrl}/AudioQuarter/Chapter ${chapter}/${verse}.1.mp3`, `AudioQuarter/Chapter ${chapter}/${verse}.1.mp3`);
                    if (!audioUrl) {
                        errorMessage = `Quarter audio (Pada1) not found in AudioQuarter/Chapter ${chapter} for ${key}`;
                        audioUrl = style === 'sringeri' 
                            ? `${baseUrl}/AudioFullSringeri/${key}.mp3`
                            : `${baseUrl}/AudioFullSGS/${key}.mp3`;
                    }
                } else if (quarter === 'pada1_or_pada3') {
                    const folder = style === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
                    const pada1Url = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.1.mp3`;
                    const pada3Url = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.3.mp3`;
                    audioUrl = await tryUrl(pada1Url, `${folder}/Chapter ${chapter}/${verse}.1.mp3`);
                    if (!audioUrl) {
                        audioUrl = await tryUrl(pada3Url, `${folder}/Chapter ${chapter}/${verse}.3.mp3`);
                    }
                    if (!audioUrl) {
                        errorMessage = `Quarter audio (Pada1 or Pada3) not found in ${folder}/Chapter ${chapter} for ${key}`;
                        audioUrl = style === 'sringeri' 
                            ? `${baseUrl}/AudioFullSringeri/${key}.mp3`
                            : `${baseUrl}/AudioFullSGS/${key}.mp3`;
                    }
                    if (backendAudioUrl) {
                        const backendUrlResult = await tryUrl(backendAudioUrl, `Backend-provided ${quarter}`);
                        if (backendUrlResult) {
                            console.log(`fetchAudioUrl: Using backend audio for ${quarter}: ${backendUrlResult}`);
                            return backendUrlResult;
                        }
                    }
                } else {
                    audioUrl = style === 'sringeri' 
                        ? `${baseUrl}/AudioFullSringeri/${key}.mp3`
                        : `${baseUrl}/AudioFullSGS/${key}.mp3`;
                }

                const fullCheck = await fetch(audioUrl, { method: 'HEAD', mode: 'cors' });
                if (!fullCheck.ok) {
                    throw new Error(`Audio inaccessible: HTTP ${fullCheck.status}`);
                }
                console.log(`fetchAudioUrl: Using audio for ${key}: ${audioUrl}`);
                return errorMessage ? { url: audioUrl, error: errorMessage } : audioUrl;
            } catch (error) {
                console.error(`fetchAudioUrl: Error for ${key}: ${error.message}`);
                return { url: audioUrl || '', error: `No audio available for ${key}: ${error.message}` };
            }
        }

        async function fetchShlokaText(chapter, verse, style) {
            try {
                console.log(`fetchShlokaText called: chapter=${chapter}, verse=${verse}, style=${style}`);
                const url = style === 'sgs'
                    ? 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG Telugu with Uvacha2.txt'
                    : 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_Sringeri.txt';
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                const text = await response.text();
                
                const lines = text.split('\n');
                const key1 = `${chapter}.${verse}`;
                const key2 = `${chapter}-${verse}`;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.match(new RegExp(`^${key1}\\s+|^${key2}\\s+|^${key1}\\t|^${key2}\\t|^${key1}$|^${key2}$`))) {
                        let shlokaLines = [line.substring(line.indexOf(' ') + 1 || line.indexOf('\t') + 1 || line.length)];
                        let j = i + 1;
                        while (j < lines.length && !lines[j].match(/^\d+[.-]\d+/)) {
                            shlokaLines.push(lines[j].trim());
                            j++;
                        }
                        let shlokaText = shlokaLines.join('\n').trim();
                        return `${chapter}.${verse} ${shlokaText}`;
                    }
                }

                return `Shloka ${chapter}.${verse} not found`;
            } catch (error) {
                console.error(`Error loading shloka ${chapter}.${verse}: ${error.message}`);
                return `Error loading shloka ${chapter}.${verse}: ${error.message}`;
            }
        }

        async function fetchShlokaMeaning(chapter, verse) {
            try {
                console.log(`fetchShlokaMeaning called: chapter=${chapter}, verse=${verse}`);
                const url = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/meanings.txt';
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                const data = await response.json();
                const key = `${chapter}.${verse}`;
                if (data[key] && data[key].అర్థము) {
                    return `${chapter}.${verse} Meaning:\n${data[key].అర్థము}`;
                } else {
                    return `Meaning for ${chapter}.${verse} not found`;
                }
            } catch (error) {
                console.error(`Error loading meaning for ${chapter}.${verse}: ${error.message}`);
                return `Error loading meaning for ${chapter}.${verse}: ${error.message}`;
            }
        }

        async function handleContinuousPlay(selectElement) {
            try {
                console.log('handleContinuousPlay called');
                const chapter = parseInt(selectElement.value);
                if (!chapter) {
                    console.log('No chapter selected');
                    return;
                }

                isInstructionsVisible = false;
                document.getElementById('instructionsButton').textContent = 'Instructions';
                const style = getSelectedStyle();
                const activeTextbox = style === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                const audioPlayer = document.getElementById('audioPlayer');
                isContinuousPlaying = true;

                if (continuousPlayInterval) {
                    clearInterval(continuousPlayInterval);
                }

                let verse = 1;
                const playNextVerse = async () => {
                    if (!isContinuousPlaying || verse > verseCounts[chapter]) {
                        isContinuousPlaying = false;
                        selectElement.selectedIndex = 0;
                        audioPlayer.src = '';
                        console.log('Continuous play stopped');
                        return;
                    }

                    currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                    currentContext.push({
                        name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                        lifespanCount: 5,
                        parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: style, showingMeaning: false }
                    });
                    localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                    console.log(`handleContinuousPlay: Updated context for ${chapter}.${verse}`);

                    const shlokaText = await fetchShlokaText(chapter, verse, style);
                    activeTextbox.innerText = shlokaText;
                    adjustTextboxHeight();
                    updateTextboxVisibility();

                    const audioResult = await fetchAudioUrl(chapter, verse);
                    audioPlayer.src = typeof audioResult === 'string' ? audioResult : audioResult.url;
                    try {
                        audioPlayer.load();
                        await audioPlayer.play();
                        if (typeof audioResult === 'object' && audioResult.error) {
                            const errorText = `${shlokaText}\n${audioResult.error}`;
                            activeTextbox.innerText = errorText;
                            adjustTextboxHeight();
                        }
                    } catch (error) {
                        const errorText = `${shlokaText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                        activeTextbox.innerText = errorText;
                        adjustTextboxHeight();
                        console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                    }

                    audioPlayer.onended = () => {
                        verse++;
                        playNextVerse();
                    };
                };

                await playNextVerse();
                selectElement.selectedIndex = 0;
            } catch (error) {
                console.error('Error in handleContinuousPlay:', error);
                const activeTextbox = getSelectedStyle() === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                activeTextbox.innerText = `Error in continuous play: ${error.message}`;
                adjustTextboxHeight();
            }
        }

        function showVerseTable() {
            try {
                console.log('showVerseTable called');
                isInstructionsVisible = false;
                document.getElementById('instructionsButton').textContent = 'Instructions';
                const modal = document.getElementById('verseTableModal');
                const chapterSelect = document.getElementById('chapterTableSelect');
                chapterSelect.value = '';
                updateVerseGrid();
                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error in showVerseTable:', error);
            }
        }

        function updateVerseGrid() {
            try {
                console.log('updateVerseGrid called');
                const chapter = parseInt(document.getElementById('chapterTableSelect').value);
                const content = document.getElementById('verseTableContent');
                content.innerHTML = '';

                if (chapter) {
                    const verseGrid = document.createElement('div');
                    verseGrid.className = 'verse-grid';
                    for (let verse = 1; verse <= verseCounts[chapter]; verse++) {
                        const verseButton = document.createElement('div');
                        verseButton.className = 'verse-button';
                        verseButton.textContent = `${chapter}.${verse}`;
                        verseButton.onclick = () => selectVerse(chapter, verse);
                        verseGrid.appendChild(verseButton);
                    }
                    content.appendChild(verseGrid);
                }
            } catch (error) {
                console.error('Error in updateVerseGrid:', error);
            }
        }

        function closeVerseTable() {
            try {
                console.log('closeVerseTable called');
                document.getElementById('verseTableModal').style.display = 'none';
            } catch (error) {
                console.error('Error in closeVerseTable:', error);
            }
        }

        async function selectVerse(chapter, verse) {
            try {
                console.log(`selectVerse called: chapter=${chapter}, verse=${verse}`);
                isContinuousPlaying = false;
                isInstructionsVisible = false;
                document.getElementById('instructionsButton').textContent = 'Instructions';
                const style = getSelectedStyle();
                const activeTextbox = style === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                currentContext.push({
                    name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                    lifespanCount: 5,
                    parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: style, showingMeaning: false }
                });
                localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                console.log('selectVerse: Updated context:', JSON.stringify(currentContext));
                
                const shlokaText = await fetchShlokaText(chapter, verse, style);
                activeTextbox.innerText = shlokaText;
                adjustTextboxHeight();
                
                const audioResult = await fetchAudioUrl(chapter, verse);
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = typeof audioResult === 'string' ? audioResult : audioResult.url;
                try {
                    audioPlayer.load();
                    await audioPlayer.play();
                    if (typeof audioResult === 'object' && audioResult.error) {
                        const errorText = `${shlokaText}\n${audioResult.error}`;
                        activeTextbox.innerText = errorText;
                        adjustTextboxHeight();
                    }
                } catch (error) {
                    const errorText = `${shlokaText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                    activeTextbox.innerText = errorText;
                    adjustTextboxHeight();
                    console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                }
                
                updateTextboxVisibility();
                closeVerseTable();
            } catch (error) {
                console.error('Error in selectVerse:', error);
                const activeTextbox = getSelectedStyle() === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                activeTextbox.innerText = `Error selecting verse: ${error.message}`;
                adjustTextboxHeight();
            }
        }

        async function handlePreviousShloka() {
            try {
                console.log('handlePreviousShloka called');
                isContinuousPlaying = false;
                isInstructionsVisible = false;
                document.getElementById('instructionsButton').textContent = 'Instructions';
                const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                const style = getSelectedStyle();
                const activeTextbox = style === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                if (context && context.parameters && Number.isInteger(context.parameters.chapter) && Number.isInteger(context.parameters.verse)) {
                    let chapter = Math.floor(context.parameters.chapter);
                    let verse = Math.floor(context.parameters.verse);
                    verse -= 1;
                    if (verse < 1) {
                        chapter -= 1;
                        if (chapter < 1) {
                            chapter = 1;
                            verse = 1;
                        } else {
                            verse = verseCounts[chapter];
                        }
                    }
                    currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                    currentContext.push({
                        name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                        lifespanCount: 5,
                        parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: style, showingMeaning: false }
                    });
                    localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                    console.log('handlePreviousShloka: Updated context:', JSON.stringify(currentContext));
                    
                    const shlokaText = await fetchShlokaText(chapter, verse, style);
                    activeTextbox.innerText = shlokaText;
                    adjustTextboxHeight();
                    
                    const audioResult = await fetchAudioUrl(chapter, verse);
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = typeof audioResult === 'string' ? audioResult : audioResult.url;
                    try {
                        audioPlayer.load();
                        await audioPlayer.play();
                        if (typeof audioResult === 'object' && audioResult.error) {
                            const errorText = `${shlokaText}\n${audioResult.error}`;
                            activeTextbox.innerText = errorText;
                            adjustTextboxHeight();
                        }
                    } catch (error) {
                        const errorText = `${shlokaText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                        activeTextbox.innerText = errorText;
                        adjustTextboxHeight();
                        console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                    }
                    
                    updateTextboxVisibility();
                } else {
                    activeTextbox.innerText = 'Please select a Shloka first';
                    adjustTextboxHeight();
                    updateTextboxVisibility();
                }
            } catch (error) {
                console.error('Error in handlePreviousShloka:', error);
                const activeTextbox = getSelectedStyle() === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                activeTextbox.innerText = `Error in previous shloka: ${error.message}`;
                adjustTextboxHeight();
            }
        }

        async function handleMeanings() {
            try {
                console.log('handleMeanings called');
                isContinuousPlaying = false;
                isInstructionsVisible = false;
                document.getElementById('instructionsButton').textContent = 'Instructions';
                const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                const style = getSelectedStyle();
                const activeTextbox = style === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                if (context && context.parameters && Number.isInteger(context.parameters.chapter) && Number.isInteger(context.parameters.verse)) {
                    const chapter = Math.floor(context.parameters.chapter);
                    const verse = Math.floor(context.parameters.verse);
                    
                    currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                    currentContext.push({
                        name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                        lifespanCount: 5,
                        parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: style, showingMeaning: true }
                    });
                    localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                    console.log('handleMeanings: Updated context:', JSON.stringify(currentContext));
                    
                    const meaningText = await fetchShlokaMeaning(chapter, verse);
                    activeTextbox.innerText = meaningText;
                    adjustTextboxHeight();
                    
                    updateTextboxVisibility();
                } else {
                    activeTextbox.innerText = 'Please select a Shloka first';
                    adjustTextboxHeight();
                    updateTextboxVisibility();
                }
            } catch (error) {
                console.error('Error in handleMeanings:', error);
                const activeTextbox = getSelectedStyle() === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                activeTextbox.innerText = `Error fetching meanings: ${error.message}`;
                adjustTextboxHeight();
            }
        }

        async function handleChapterSelect(selectElement) {
            try {
                console.log('handleChapterSelect called');
                isContinuousPlaying = false;
                isInstructionsVisible = false;
                document.getElementById('instructionsButton').textContent = 'Instructions';
                const chapter = parseInt(selectElement.value);
                if (chapter) {
                    const style = getSelectedStyle();
                    console.log(`handleChapterSelect: Sending ChapterIntent for chapter ${chapter}, style: ${style}`);
                    await sendCommand('ChapterIntent', { chapter: chapter, style: style });
                    selectElement.selectedIndex = 0;
                }
            } catch (error) {
                console.error('Error in handleChapterSelect:', error);
                const activeTextbox = getSelectedStyle() === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                activeTextbox.innerText = `Error selecting chapter: ${error.message}`;
                adjustTextboxHeight();
            }
        }

        function getSelectedStyle() {
            try {
                const style = document.querySelector('input[name="style"]:checked').value;
                console.log(`getSelectedStyle: ${style}`);
                return style;
            } catch (error) {
                console.error('Error in getSelectedStyle:', error);
                return 'sringeri'; // Default to sringeri if error
            }
        }

        async function updateTextboxVisibility() {
            try {
                console.log('updateTextboxVisibility called');
                const style = getSelectedStyle();
                const sgsText = document.getElementById('sgsText');
                const sringeriText = document.getElementById('sringeriText');
                const sgsLabel = document.getElementById('sgsLabel');
                const sringeriLabel = document.getElementById('sringeriLabel');

                if (style === 'sgs') {
                    sgsText.classList.add('active');
                    sgsLabel.classList.add('active');
                    sringeriText.classList.remove('active');
                    sringeriLabel.classList.remove('active');
                    if (!isInstructionsVisible && !sringeriText.innerText.includes('Please select a Shloka first') && !sringeriText.innerText.includes('Error')) {
                        sringeriText.innerText = 'Your Shloka will appear here.';
                        adjustTextboxHeight();
                    }
                } else {
                    sgsText.classList.remove('active');
                    sgsLabel.classList.remove('active');
                    sringeriText.classList.add('active');
                    sringeriLabel.classList.add('active');
                    if (!isInstructionsVisible && !sgsText.innerText.includes('Please select a Shloka first') && !sgsText.innerText.includes('Error')) {
                        sgsText.innerText = 'Your Shloka will appear here.';
                        adjustTextboxHeight();
                    }
                }

                const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                if (context && context.parameters && Number.isInteger(context.parameters.chapter) && Number.isInteger(context.parameters.verse)) {
                    const chapter = Math.floor(context.parameters.chapter);
                    const verse = Math.floor(context.parameters.verse);
                    const showingMeaning = context.parameters.showingMeaning || false;

                    currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                    currentContext.push({
                        name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                        lifespanCount: 5,
                        parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: style, showingMeaning: showingMeaning }
                    });
                    localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                    console.log('updateTextboxVisibility: Updated context:', JSON.stringify(currentContext));

                    if (!showingMeaning && !isInstructionsVisible) {
                        const shlokaText = await fetchShlokaText(chapter, verse, style);
                        const activeTextbox = style === 'sgs' ? sgsText : sringeriText;
                        activeTextbox.innerText = shlokaText;
                        adjustTextboxHeight();
                    }
                }
            } catch (error) {
                console.error('Error in updateTextboxVisibility:', error);
                const activeTextbox = getSelectedStyle() === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                activeTextbox.innerText = `Error updating textbox: ${error.message}`;
                adjustTextboxHeight();
            }
        }

        async function sendCommand(intent, params) {
            try {
                console.log(`sendCommand called: intent=${intent}, params=`, params);
                isContinuousPlaying = false;
                isInstructionsVisible = false;
                document.getElementById('instructionsButton').textContent = 'Instructions';
                const webhookUrl = 'https://gita-voice-bot-504694669439.us-central1.run.app/webhook';
                const style = params.style || getSelectedStyle();
                const activeTextbox = style === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                const quarter = params.quarter || null;
                const isFullForQuarter = params.isFullForQuarter || false;
                const payload = {
                    session: sessionId,
                    queryResult: {
                        intent: { displayName: intent },
                        parameters: { ...params, style: style },
                        outputContexts: currentContext
                    }
                };

                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.outputContexts && data.outputContexts.length > 0) {
                    currentContext = data.outputContexts;
                    const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                    if (context && context.parameters) {
                        context.parameters.showingMeaning = false;
                    }
                    localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                    console.log('sendCommand: Updated context:', JSON.stringify(currentContext));
                }

                const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                let backendAudioUrl = null;
                if (data.payload && data.payload.google && data.payload.google.richResponse && data.payload.google.richResponse.items) {
                    const mediaItem = data.payload.google.richResponse.items.find(item => item.mediaResponse && item.mediaResponse.mediaObjects);
                    if (mediaItem && mediaItem.mediaResponse.mediaObjects[0]) {
                        backendAudioUrl = data.payload.google.richResponse.items[0].mediaResponse.mediaObjects[0].contentUrl;
                        console.log(`sendCommand: Backend audio URL: ${backendAudioUrl}`);
                    }
                }

                if (context && context.parameters && Number.isInteger(context.parameters.chapter) && Number.isInteger(context.parameters.verse)) {
                    const chapter = Math.floor(context.parameters.chapter);
                    const verse = Math.floor(context.parameters.verse);
                    
                    const shlokaText = await fetchShlokaText(chapter, verse, style);
                    activeTextbox.innerText = shlokaText;
                    adjustTextboxHeight();
                    
                    const audioResult = intent === 'ChapterIntent' ? backendAudioUrl : await fetchAudioUrl(chapter, verse, quarter, backendAudioUrl, isFullForQuarter);
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = typeof audioResult === 'string' ? audioResult : audioResult.url;
                    try {
                        audioPlayer.load();
                        if (intent !== 'NextIntent') {
                            await audioPlayer.play();
                        }
                        if (typeof audioResult === 'object' && audioResult.error) {
                            const errorText = `${shlokaText}\n${audioResult.error}`;
                            activeTextbox.innerText = errorText;
                            adjustTextboxHeight();
                        }
                    } catch (error) {
                        const errorText = `${shlokaText}\nError loading audio for ${chapter}.${verse}: ${error.message}`;
                        activeTextbox.innerText = errorText;
                        adjustTextboxHeight();
                        console.error(`Error loading audio for ${chapter}.${verse}: ${error.message}`);
                    }
                } else {
                    activeTextbox.innerText = 'Please select a Shloka first';
                    adjustTextboxHeight();
                }

                updateTextboxVisibility();
            } catch (error) {
                console.error(`sendCommand: Error for ${intent}: ${error.message}`);
                const activeTextbox = getSelectedStyle() === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                activeTextbox.innerText = `Error communicating with server for ${intent}: ${error.message}`;
                adjustTextboxHeight();
                updateTextboxVisibility();
            }
        }

        document.addEventListener('click', () => {
            console.log('Document click event: Unmuting audio');
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.muted = false;
        }, { once: true });

        // Initialize the application
        initialize();
    </script>
    <h2>SGS Audio: Pujya Sri Datta Vijayanand Teertha Swamiji</h2>
    <h2>Sringeri Audio courtesy: Smt Mathangi Kailasnath</h2>
    <h2>Developed by Dr.P.Udayabhaskar</h2>
</body>
</html>
