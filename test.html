<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Bhagavad Gita Bot</title>
      <meta name="description" content="Explore Bhagavad Gita shlokas in Telugu with SGS and Sringeri styles, featuring audio recitations and meanings.">
      <meta name="keywords" content="Bhagavad Gita, SGS, Sringeri, Telugu shlokas, audio recitation, spiritual app">
      <meta name="author" content="Dr. P. Udayabhaskar">
      <meta name="robots" content="index, follow">
      <link rel="canonical" href="https://pubsaroja.github.io/bhagavad-gita-bot/">
      <style type="text/css">@font-face {font-family:Ramabhadra;font-style:normal;font-weight:400;src:url(/cf-fonts/s/ramabhadra/5.0.11/latin/400/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Ramabhadra;font-style:normal;font-weight:400;src:url(/cf-fonts/s/ramabhadra/5.0.11/telugu/400/normal.woff2);unicode-range:U+0951-0952,U+0964-0965,U+0C00-0C7F,U+1CDA,U+200C-200D,U+25CC;font-display:swap;}</style>
      <style type="text/css">@font-face {font-family:Outfit;font-style:normal;font-weight:300;src:url(/cf-fonts/v/outfit/5.0.11/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Outfit;font-style:normal;font-weight:300;src:url(/cf-fonts/v/outfit/5.0.11/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}</style>
      <style type="text/css">@font-face {font-family:Noto Sans Telugu;font-style:normal;font-weight:400;src:url(/cf-fonts/v/noto-sans-telugu/5.0.12/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Noto Sans Telugu;font-style:normal;font-weight:400;src:url(/cf-fonts/v/noto-sans-telugu/5.0.12/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Noto Sans Telugu;font-style:normal;font-weight:400;src:url(/cf-fonts/v/noto-sans-telugu/5.0.12/telugu/wght/normal.woff2);unicode-range:U+0951-0952,U+0964-0965,U+0C00-0C7F,U+1CDA,U+200C-200D,U+25CC;font-display:swap;}</style>
      <style type="text/css">@font-face {font-family:Noto Sans Devanagari;font-style:normal;font-weight:400;src:url(/cf-fonts/v/noto-sans-devanagari/5.0.11/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Noto Sans Devanagari;font-style:normal;font-weight:400;src:url(/cf-fonts/v/noto-sans-devanagari/5.0.11/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Noto Sans Devanagari;font-style:normal;font-weight:400;src:url(/cf-fonts/v/noto-sans-devanagari/5.0.11/devanagari/wght/normal.woff2);unicode-range:U+0900-097F,U+1CD0-1CF9,U+200C-200D,U+20A8,U+20B9,U+25CC,U+A830-A839,U+A8E0-A8FF;font-display:swap;}</style>
      <style type="text/css">@font-face {font-family:Noto Sans Kannada;font-style:normal;font-weight:400;src:url(/cf-fonts/v/noto-sans-kannada/5.0.12/kannada/wght/normal.woff2);unicode-range:U+0964-0965,U+0C80-0CF2,U+200C-200D,U+20B9,U+25CC;font-display:swap;}@font-face {font-family:Noto Sans Kannada;font-style:normal;font-weight:400;src:url(/cf-fonts/v/noto-sans-kannada/5.0.12/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Noto Sans Kannada;font-style:normal;font-weight:400;src:url(/cf-fonts/v/noto-sans-kannada/5.0.12/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}</style>
      <style type="text/css">@font-face {font-family:Noto Sans Tamil;font-style:normal;font-weight:400;src:url(/cf-fonts/v/noto-sans-tamil/5.0.11/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Noto Sans Tamil;font-style:normal;font-weight:400;src:url(/cf-fonts/v/noto-sans-tamil/5.0.11/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Noto Sans Tamil;font-style:normal;font-weight:400;src:url(/cf-fonts/v/noto-sans-tamil/5.0.11/tamil/wght/normal.woff2);unicode-range:U+0964-0965,U+0B82-0BFA,U+200C-200D,U+20B9,U+25CC;font-display:swap;}</style>
      <!-- Intro.js for elegant guided tours -->
      <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
      <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
      <style>
         /* Define CSS variables for theming */
         :root {
         --bg-color: #f0f0f0;
         --text-color: #2c3e50;
         --card-bg: #ffffff;
         --card-border: #357EC7;
         --button-bg: #357EC7;
         --button-text: #ffffff;
         --button-hover-bg: #1e40af;
         --header-color: #2c3e50;
         --subheader-color: #34495e;
         --input-border: #ccc;
         --modal-bg: #ffffff;
         --verse-button-bg: #f9f9f9;
         --verse-button-hover-bg: #e0e0e0;
         --intro-overlay: rgba(0,0,0,0.5);
         --intro-button-bg: #e5e7eb;
         --intro-button-text: #111827;
         --intro-tooltip-bg: #ffffff;
         }
         [data-theme="dark"] {
         --bg-color: #1a1a1a;
         --text-color: #ffffff;
         --card-bg: #2a2a2a;
         --card-border: #4a90e2;
         --button-bg: #4a90e2;
         --button-text: #ffffff;
         --button-hover-bg: #357abd;
         --header-color: #ffffff;
         --subheader-color: #cccccc;
         --input-border: #444;
         --modal-bg: #2a2a2a;
         --verse-button-bg: #333;
         --verse-button-hover-bg: #444;
         --intro-overlay: rgba(0,0,0,0.7);
         --intro-button-bg: #444;
         --intro-button-text: #ffffff;
         --intro-tooltip-bg: #333;
         }
         /* Global box-sizing for consistent sizing */
         *, *::before, *::after {
         box-sizing: border-box;
         }
         body {
         font-family: Outfit, sans-serif;
         text-align: center;
         padding: 20px;
         margin: 0;
         background-color: var(--bg-color);
         color: var(--text-color);
         overflow-x: hidden;
         transition: all 0.3s ease;
         }
         h1 {
         color: var(--header-color);
         font-size: 1.5em;
         }
         h2 {
         color: var(--subheader-color);
         font-size: 1em;
         margin-top: 10px;
         }
         /* Theme toggle buttons */
         .theme-toggle {
         position: fixed;
         top: 10px;
         right: 10px; /* Changed to align to the right */
         display: flex;
         gap: 10px;
         z-index: 1001;
         }
         .theme-toggle button {
         background: none;
         border: none;
         cursor: pointer;
         font-size: 20px;
         color: var(--text-color);
         opacity: 0.6;
         transition: opacity 0.3s;
         }
         .theme-toggle button:hover,
         .theme-toggle button.active {
         opacity: 1;
         }
         /* Page frame */
         .page-frame {
         max-width: 900px;
         margin: 8px auto;
         padding: 12px;
         border: 2px solid var(--card-border);
         border-radius: 10px;
         background: var(--card-bg);
         box-shadow: 0 2px 6px rgba(0,0,0,0.04);
         }
         @media (max-width: 600px) {
         .page-frame {
         margin: 4px;
         padding: 16px;
         border-radius: 10px;
         border-width: 4px;
         overflow: hidden;
         }
         }
         @media (max-width: 600px) {
         .top-buttons button {
         font-size: 1.1em !important;   /* Makes the text clearly readable on phones */
         }
         }
         /* Top buttons container */
         .top-buttons {
         display: flex;
         justify-content: center;
         gap: 10px;
         width: 100%;
         max-width: 600px;
         margin: 0 auto;
         padding-left: 12px;
         padding-right: 12px;
         box-sizing: border-box;
         }
         .top-buttons button {
         width: 150px;
         height: 150px;
         border-radius: 25%;
         border: none;
         background-color: var(--button-bg);
         color: var(--button-text);
         font-size: 20px;
         cursor: pointer;
         transition: background 0.3s ease;
         background-repeat: no-repeat;
         background-position: center;
         background-size: cover;
         }
         .top-buttons button.sgs-button:hover,
         .top-buttons button.sgs-button:active {
         background-image: url('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/main/sankhu.png');
         background-color: transparent !important;
         color: transparent !important;
         }
         .top-buttons button.sringeri-button:hover,
         .top-buttons button.sringeri-button:active,
         .top-buttons button.third-paada-button:hover,
         .top-buttons button.third-paada-button:active {
         background-image: url('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/main/chakra.png');
         background-color: transparent !important;
         color: transparent !important;
         }
         .top-buttons button.reset,
         .top-buttons button.reset:hover,
         .top-buttons button.reset:active,
         .top-buttons button.reset:focus {
         background: var(--button-bg) !important;
         color: var(--button-text) !important;
         background-image: none !important;
         }
         /* Button groups container */
         .button-groups {
         display: flex;
         justify-content: center;
         gap: 10px;
         max-width: 600px;
         margin: 0 auto;
         width: 100%;
         padding-left: 12px;
         padding-right: 12px;
         box-sizing: border-box;
         }
         .button-group {
         display: flex;
         flex-direction: column;
         gap: 10px;
         width: 50%;
         }
         .button-groups button {
         background-color: var(--button-bg);
         color: var(--button-text);
         padding: 10px 18px;
         border: none;
         border-radius: 5px;
         cursor: pointer;
         font-family: 'Outfit', sans-serif;
         font-size: 1.6em;
         width: 100%;
         max-width: 150px;
         transition: background-color 0.3s ease;
         }
         .button-groups button:hover {
         background-color: var(--card-bg);
         color: transparent;
         }
         /* Dropdown container */
         .dropdown-container {
         display: flex;
         flex-direction: column;
         gap: 20px;
         max-width: 600px;
         margin: 0 auto;
         border: 2px solid var(--card-border);
         border-radius: 5px;
         padding: 10px 12px;
         box-sizing: border-box;
         }
         .dropdown-item {
         display: flex;
         flex-direction: column;
         }
         .dropdown-label {
         margin-bottom: 6px;
         font-weight: bold;
         font-size: 1em;
         color: var(--header-color);
         }
         select {
         width: 100%;
         padding: 8px;
         font-size: 1em;
         border-radius: 5px;
         border: 1px solid var(--input-border);
         background-color: var(--card-bg);
         color: var(--text-color);
         }
         /* Shloka text */
         .shloka-text {
         margin-top: 10px;
         font-size: 1.5em;
         color: var(--text-color);
         white-space: pre-wrap;
         max-width: 100%;
         margin-left: 0;
         margin-right: 0;
         line-height: 1.5;
         min-height: 3em;
         overflow-y: auto;
         padding: 0;
         display: none;
         justify-content: center;
         align-items: center;
         text-align: center;
         font-family: 'Noto Sans Telugu', 'Noto Sans Devanagari', 'Noto Sans Kannada', 'Noto Sans Tamil', sans-serif;
         box-sizing: border-box;
         }
         .shloka-text.active {
         display: flex;
         }
         .shloka-text.active.multiline {
         display: block;
         text-align: left;
         }
         .shloka-number {
         font-weight: bold;
         margin-bottom: 5px;
         text-align: left;
         font-size: 1em;
         }
         .shloka-lines {
         text-align: left;
         }
         #sgsText, #sringeriText {
         display: block;
         width: 100%;
         white-space: pre-line !important;
         /* Ensure long words in Indic scripts (e.g., Tamil) wrap on small screens */
         word-wrap: break-word;
         overflow-wrap: break-word;
         overflow-wrap: anywhere;
         word-break: break-word;
         hyphens: auto;
         text-align: center;
         margin-left: 0;
         margin-right: 0;
         max-width: 100%;
         font-family: 'Noto Sans Telugu', 'Noto Sans Devanagari', 'Noto Sans Kannada', 'Noto Sans Tamil', sans-serif;
         font-size: 1.5em;
         line-height: 1.5;
         border: none;
         padding: 0;
         overflow-y: auto;
         overflow-x: auto;
         min-height: 3em;
         box-sizing: border-box;
         }
         #sgsText > div,
         #sringeriText > div {
         display: block;
         width: 100%;
         margin-bottom: 1em;
         }
         .hidden {
         display: none !important;
         }
         .shloka-text.visible {
         display: flex !important;
         flex-direction: column;
         align-items: center;
         justify-content: center;
         text-align: center;
         }
         .shloka-text.placeholder {
         display: flex !important;
         flex-direction: column;
         align-items: center;
         justify-content: center;
         text-align: center;
         }
         .shloka-text.visible.multiline {
         display: block !important;
         text-align: left;
         }
         .visible {
         display: block !important;
         }
         #audioPlayer {
         margin: 10px auto;
         display: block;
         flex-shrink: 0;
         }
         .radio-group {
         margin: 10px 0;
         display: flex;
         justify-content: center;
         align-items: center;
         gap: 10px;
         width: 100%;
         max-width: 600px;
         margin-left: auto;
         margin-right: auto;
         padding-left: 12px;
         padding-right: 12px;
         box-sizing: border-box;
         }
         .radio-group label {
         margin: 0 10px;
         color: var(--text-color);
         }
         .radio-group input[type="text"] {
         padding: 8px;
         font-size: 1em;
         border-radius: 5px;
         border: 1px solid var(--input-border);
         background-color: var(--card-bg);
         color: var(--text-color);
         }
         .radio-group input[type="submit"] {
         background-color: var(--button-bg);
         color: var(--button-text);
         padding: 8px 15px;
         border: none;
         border-radius: 5px;
         cursor: pointer;
         transition: background-color 0.3s ease;
         }
         .radio-group input[type="submit"]:hover {
         background-color: var(--button-hover-bg);
         }
         .textbox-container {
         display: flex;
         flex-direction: column;
         align-items: stretch;
         gap: 10px;
         width: 100%;
         max-width: 600px;
         margin: 12px auto 0;
         padding-left: 12px;
         padding-right: 12px;
         border: 2px solid var(--card-border);
         border-radius: 5px;
         box-sizing: border-box;
         }
         .textbox-container > div {
         width: 100%;
         max-width: 100%;
         }
         .textbox-label {
         font-weight: bold;
         margin-bottom: 5px;
         display: none;
         color: var(--header-color);
         }
         .textbox-label.active {
         display: block;
         }
         /* Modal */
         .modal {
         display: none;
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background-color: var(--intro-overlay);
         justify-content: center;
         align-items: center;
         z-index: 1000;
         }
         .modal-content {
         background-color: var(--modal-bg);
         padding: 20px;
         border-radius: 5px;
         max-width: 80%;
         max-height: 80%;
         overflow-y: auto;
         border: 2px solid var(--card-border);
         }
         .chapter-select {
         margin-bottom: 10px;
         padding: 10px;
         font-size: 1em;
         border-radius: 5px;
         width: 100%;
         max-width: 200px;
         background-color: var(--card-bg);
         color: var(--text-color);
         border: 1px solid var(--input-border);
         }
         /* Verse grid */
         .verse-grid {
         display: grid;
         grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
         gap: 10px;
         padding: 10px;
         }
         .verse-button {
         background-color: var(--verse-button-bg);
         border: 1px solid var(--card-border);
         border-radius: 5px;
         padding: 10px;
         text-align: center;
         cursor: pointer;
         font-size: 0.9em;
         color: var(--text-color);
         }
         .verse-button:hover {
         background-color: var(--verse-button-hover-bg);
         }
         .close-button {
         background-color: #ff4444;
         color: white;
         padding: 5px 10px;
         border: none;
         border-radius: 5px;
         cursor: pointer;
         float: right;
         }
         .close-button:hover {
         background-color: #cc0000;
         }
         .credits {
         font-size: 0.9em;
         color: var(--text-color);
         margin-top: 10px;
         }
         /* Player container */
         .player-container {
         display: grid;
         grid-template-columns: repeat(3, max-content);
         grid-template-rows: repeat(2, auto);
         gap: 10px 5px;
         justify-content: center;
         justify-items: center;
         align-items: center;
         max-width: 600px;
         margin: 20px auto 0;
         width: 100%;
         box-sizing: border-box;
         border: none;
         border-radius: 5px;
         padding: 12px;
         }
         .player-container button {
         width: 100px;
         height: 40px;
         border: none;
         border-radius: 25px;
         background-color: var(--button-bg);
         color: var(--button-text);
         font-family: 'Outfit', sans-serif;
         font-size: 16px;
         cursor: pointer;
         padding: 0 15px;
         transition: background 0.3s ease;
         justify-self: center;
         align-self: center;
         }
         .player-container button:hover {
         background-color: var(--button-hover-bg);
         }
         /* Elegant Intro.js customization */
         .introjs-overlay {
         background: var(--intro-overlay);
         }
         .introjs-helperLayer {
         box-shadow: 0 8px 24px rgba(0,0,0,0.25);
         border-radius: 10px;
         }
         .introjs-tooltip {
         border-radius: 12px;
         font-family: Outfit, sans-serif;
         line-height: 1.4;
         color: var(--text-color);
         background-color: var(--intro-tooltip-bg);
         }
         .introjs-tooltip-header {
         border-bottom: none;
         }
         .introjs-tooltip-title {
         font-weight: 700;
         color: var(--header-color);
         }
         .introjs-tooltiptext {
         font-size: 15px;
         }
         .introjs-button {
         border-radius: 999px;
         padding: 6px 14px;
         border: none;
         }
         .introjs-skipbutton,
         .introjs-prevbutton {
         background: var(--intro-button-bg);
         color: var(--intro-button-text);
         }
         .introjs-nextbutton,
         .introjs-donebutton {
         background: var(--button-bg);
         color: var(--button-text);
         }
         /* Responsive mobile styles (‚â§600px) */
         @media (max-width: 600px) {
         body {
         padding: 6px;
         }
         .top-buttons,
         .button-groups,
         .dropdown-container,
         .radio-group,
         .player-container,
         .textbox-container {
         width: 100%;
         max-width: 100%;
         margin: 0 auto;
         padding-left: 12px;
         padding-right: 12px;
         box-sizing: border-box;
         flex-wrap: wrap;
         }
         .top-buttons {
         margin-top: 6px;
         gap: 5px;
         flex-direction: row;
         }
         .player-container {
         margin-top: 12px;
         padding-left: 12px;
         padding-right: 12px;
         grid-template-columns: repeat(3, 1fr);
         }
         .player-container button {
         width: 100%;
         }
         .shloka-text {
         font-size: 1.25em;
         padding: 0;
         text-align: left;
         overflow-x: auto;
         }
         .shloka-number {
         font-weight: bold;
         margin-bottom: 5px;
         text-align: left;
         font-size: 1em;
         padding-left: 0;
         }
         #sgsText, #sringeriText {
         font-size: 1.25em;
         text-align: left;
         padding-left: 0;
         white-space: pre-line;
         /* Extra safety for mobile wrapping */
         word-wrap: break-word;
         overflow-wrap: break-word;
         overflow-wrap: anywhere;
         word-break: break-word;
         hyphens: auto;
         overflow-x: auto;
         }
         .shloka-text.visible,
         .shloka-text.placeholder {
         justify-content: flex-start;
         text-align: left;
         }
         .button-groups {
         margin-top: 12px;
         gap: 5px;
         flex-direction: row;
         }
         .button-group {
         width: 50%;
         gap: 5px;
         }
         .top-buttons button {
         flex: 1 1 calc(33.333% - 10px);
         max-width: none;
         height: auto;
         aspect-ratio: 1/1;
         font-size: 0.8em;
         }
         .button-groups button {
         padding: 6px 12px;
         font-size: 0.8em;
         max-width: 100%;
         }
            /* ‚Äî‚Äî‚Äî PERFECT LANGUAGE CHECKBOXES ON MOBILE ‚Äî‚Äî‚Äî */
@media (max-width: 600px) {
   .language-group {
      display: flex !important;
      flex-wrap: wrap;
      justify-content: center;
      gap: 14px;
      padding: 12px 0;
      font-size: 1.05em;         /* Slightly larger text */
   }
   .language-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      margin: 0 !important;
      padding: 6px 10px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
   }
   .language-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--button-bg);   /* Matches your theme color */
   }
}

/* Also improve on desktop for consistency (optional but beautiful) */
.language-group {
   display: flex;
   flex-wrap: wrap;
   justify-content: center;
   gap: 16px;
   margin: 15px 0;
   font-size: 1.1em;
}
.language-group label {
   cursor: pointer;
   display: flex;
   align-items: center;
  Êæ°
   gap: 8px;
}
      </style>
   </head>
   <body>
      <div class="theme-toggle" data-intro="Change the theme Light or Dark" data-title="Theme">
         <button id="themeLight" title="Light Theme" data-theme="light" class="active">‚òÄÔ∏è</button>
         <button id="themeDark" title="Dark Theme" data-theme="dark">üåô</button>
      </div>
      <div class="page-frame">
         <h1>Srimad Bhagavad Gita</h1>
         <p>Listen, understand and memorize Bhagavad Gita shlokas</p>
         <div class="top-buttons" data-intro="Choose how you want to hear the shloka" data-title="Playback Options">
            <button class="sgs-button" onclick="sendCommand('SGSFirstPaada')" data-intro="Play only 1st Paada in SGS style" data-title="1st Paada (SGS)">1st Paada<br>Only</button>
            <button class="sringeri-button" onclick="sendCommand('SringeriPaada')" data-intro="Play 1st or 3rd Paada in Sringeri style" data-title="1st or 3rd Paada (Sringeri)">1st or 3rd Paada</button>
            <button class="third-paada-button" onclick="sendCommand('ThirdPaada')" data-intro="Play only 3rd Paada" data-title="3rd Paada Only">3rd Paada<br>Only</button>
         </div>
<!-- Continuous Random Play ‚Äì Perfect Width & Smart Stop Button -->
<div class="continuous-play-box" style="margin:25px auto 0;max-width:600px;padding:18px;background:var(--card-bg);border:2px solid var(--card-border);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);">
   <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center;justify-content:center;">
      <strong style="flex:1 1 100%;text-align:center;font-size:1.35em;color:var(--header-color);">Continuous Random Play</strong>
      
      <div style="display:flex;gap:5px;flex-wrap:wrap;justify-content:center;">
         <label style="cursor:pointer;font-size:1.15em;white-space:nowrap;">
            <input type="radio" name="continuousGap" id="gap30" value="30"> 30-sec gap
         </label>
         <label style="cursor:pointer;font-size:1.15em;white-space:nowrap;">
            <input type="radio" name="continuousGap" id="gap60" value="60"> 60-sec gap
         </label>
      </div>
      
      <button id="stopContinuousBtn" 
              style="display:none;background:#d32f2f;color:white;padding:10px 24px;border:none;border-radius:10px;font-size:1.1em;font-weight:bold;cursor:pointer;">
         Stop Continuous Play
      </button>
      
      <small style="flex:1 1 100%;text-align:center;color:var(--subheader-color);margin-top:8px;font-style:italic;">
         Applies only to the 3 top buttons
      </small>
   </div>
</div>
         <audio id="audioPlayer" controls data-intro="Use these controls to play, pause, or scrub through the audio." data-title="Audio Player"></audio>
         <div class="radio-group" data-intro="Pick the chanting style for display and playback" data-title="Chanting Style">
            <label>Style:</label>
            <input type="radio" name="style" value="sgs" id="sgs" onchange="updateTextboxVisibility()">
            <label for="sgs">SGS</label>
            <input type="radio" name="style" value="sringeri" id="sringeri" checked onchange="updateTextboxVisibility()">
            <label for="sringeri">Sringeri</label>
         </div>
         <div class="player-container">
            <button onclick="sendCommand('PreviousShloka')" data-intro="Go to previous shloka" data-title="Previous">Previous</button>
            <button onclick="sendCommand('FullShloka')" data-intro="Play the full shloka" data-title="Full Shloka">Full</button>
            <button onclick="sendCommand('NextFullShloka')" data-intro="Go to next shloka" data-title="Next">Next</button>
         </div>
         <div class="radio-group language-group">
            <label>Languages:</label>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:8px;">
               <label><input type="checkbox" name="language" value="te" id="telugu" checked> Telugu</label>
               <label><input type="checkbox" name="language" value="sa" id="devanagari"> Devanagari</label>
               <label><input type="checkbox" name="language" value="en" id="english"> English</label>
               <label><input type="checkbox" name="language" value="kn" id="kannada"> Kannada</label>
               <label><input type="checkbox" name="language" value="ta" id="tamil"> Tamil</label>
            </div>
         </div>
         <div class="textbox-container">
            <div>
               <div id="sgsLabel" class="textbox-label">SGS Style Shloka</div>
               <div id="sgsText" class="shloka-text hidden">Your Shloka will appear here.</div>
            </div>
            <div>
               <div id="sringeriLabel" class="textbox-label active">Sringeri Style Shloka</div>
               <div id="sringeriText" class="shloka-text visible">Your Shloka will appear here.</div>
            </div>
         </div>
         <div class="player-container" >
            <button id="meaningsButton" onclick="handleMeanings()" data-intro="Toggle word-by-word and overall meaning" data-title="Meanings">Meanings</button>
            <button onclick="showVerseTable()" data-intro="Open chapter/verse selector" data-title="Selector">Selector</button>
            <button id="instructionsButton" onclick="toggleInstructions()" data-intro="Start a guided tour of the app" data-title="Help">Help</button>
            <button id="groupButton" onclick="window.open('https://pubsaroja.github.io/gita-voice-bot-web/GroupedShlokas.html', '_blank')" data-intro="Open carefully curated grouped shlokas helpful in memorizing the shloka numbers in a new tab" data-title="Grouped Shlokas">Grouped Shlokas</button>
            <button onclick="showConfusing()" data-intro="Listen to a set of often-confused shlokas" data-title="Confusing Shlokas">Confusing Shlokas</button>
            <button id="showUvacha" onclick="showUvacha()" data-intro="Play a random 'Uvacha' shloka" data-title="Uvacha">Uvacha</button>
         </div>
         <br>
         <div class="dropdown-container">
            <div>
               <label for="chapterSelect" 
                  style="display:block; font-family:Outfit, sans-serif; font-size:1.1em;">
               Random Shloka Chapterwise:
               </label>
               <select id="chapterSelect" onchange="handleChapterSelect(this)" data-intro="Pick a chapter to play a random shloka from it" data-title="Random by Chapter">
                  <option value="" selected disabled>Select Chapter</option>
                  <option value="1">1. ‡∞Ö‡∞∞‡±ç‡∞ú‡±Å‡∞®‡∞µ‡∞ø‡∞∑‡∞æ‡∞¶‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="2">2. ‡∞∏‡∞æ‡∞ô‡±ç‡∞ñ‡±ç‡∞Ø‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="3">3. ‡∞ï‡∞∞‡±ç‡∞Æ‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="4">4. ‡∞ú‡±ç‡∞û‡∞æ‡∞®‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="5">5. ‡∞ï‡∞∞‡±ç‡∞Æ‡∞∏‡∞®‡±ç‡∞®‡±ç‡∞Ø‡∞æ‡∞∏‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="6">6. ‡∞Ü‡∞§‡±ç‡∞Æ‡∞∏‡∞Ç‡∞Ø‡∞Æ‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="7">7. ‡∞ú‡±ç‡∞û‡∞æ‡∞®‡∞µ‡∞ø‡∞ú‡±ç‡∞û‡∞æ‡∞®‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="8">8. ‡∞Ö‡∞ï‡±ç‡∞∑‡∞∞‡∞™‡∞∞‡∞¨‡±ç‡∞∞‡∞π‡±ç‡∞Æ‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="9">9. ‡∞∞‡∞æ‡∞ú‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø‡∞æ‡∞∞‡∞æ‡∞ú‡∞ó‡±Å‡∞π‡±ç‡∞Ø‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="10">10. ‡∞µ‡∞ø‡∞≠‡±Ç‡∞§‡∞ø‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="11">11. ‡∞µ‡∞ø‡∞∂‡±ç‡∞µ‡∞∞‡±Ç‡∞™‡∞∏‡∞®‡±ç‡∞¶‡∞∞‡±ç‡∞∂‡∞®‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="12">12. ‡∞≠‡∞ï‡±ç‡∞§‡∞ø‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="13">13. ‡∞ï‡±ç‡∞∑‡±á‡∞§‡±ç‡∞∞‡∞ï‡±ç‡∞∑‡±á‡∞§‡±ç‡∞∞‡∞ú‡±ç‡∞û‡∞µ‡∞ø‡∞≠‡∞æ‡∞ó‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="14">14. ‡∞ó‡±Å‡∞£‡∞§‡±ç‡∞∞‡∞Ø‡∞µ‡∞ø‡∞≠‡∞æ‡∞ó‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="15">15. ‡∞™‡±Å‡∞∞‡±Å‡∞∑‡±ã‡∞§‡±ç‡∞§‡∞Æ‡∞™‡±ç‡∞∞‡∞æ‡∞™‡±ç‡∞§‡∞ø‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="16">16. ‡∞¶‡±à‡∞µ‡∞æ‡∞∏‡±Å‡∞∞‡∞∏‡∞Æ‡±ç‡∞™‡∞¶‡±ç‡∞µ‡∞ø‡∞≠‡∞æ‡∞ó‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="17">17. ‡∞∂‡±ç‡∞∞‡∞¶‡±ç‡∞ß‡∞æ‡∞§‡±ç‡∞∞‡∞Ø‡∞µ‡∞ø‡∞≠‡∞æ‡∞ó‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="18">18. ‡∞Æ‡±ã‡∞ï‡±ç‡∞∑‡∞∏‡∞®‡±ç‡∞®‡±ç‡∞Ø‡∞æ‡∞∏‡∞Ø‡±ã‡∞ó‡∞É</option>
               </select>
            </div>
            <div>
               <label for="chapterSelect" style="display:block; font-family:Outfit, sans-serif; font-size:1.1em;">Continuous Play:</label>
               <select id="continuousPlaySelect" onchange="handleContinuousPlay(this)" data-intro="Play an entire chapter continuously" data-title="Continuous Play">
                  <option value="" selected disabled>Select Chapter</option>
                  <option value="1">1. ‡∞Ö‡∞∞‡±ç‡∞ú‡±Å‡∞®‡∞µ‡∞ø‡∞∑‡∞æ‡∞¶‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="2">2. ‡∞∏‡∞æ‡∞ô‡±ç‡∞ñ‡±ç‡∞Ø‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="3">3. ‡∞ï‡∞∞‡±ç‡∞Æ‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="4">4. ‡∞ú‡±ç‡∞û‡∞æ‡∞®‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="5">5. ‡∞ï‡∞∞‡±ç‡∞Æ‡∞∏‡∞®‡±ç‡∞®‡±ç‡∞Ø‡∞æ‡∞∏‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="6">6. ‡∞Ü‡∞§‡±ç‡∞Æ‡∞∏‡∞Ç‡∞Ø‡∞Æ‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="7">7. ‡∞ú‡±ç‡∞û‡∞æ‡∞®‡∞µ‡∞ø‡∞ú‡±ç‡∞û‡∞æ‡∞®‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="8">8. ‡∞Ö‡∞ï‡±ç‡∞∑‡∞∞‡∞™‡∞∞‡∞¨‡±ç‡∞∞‡∞π‡±ç‡∞Æ‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="9">9. ‡∞∞‡∞æ‡∞ú‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø‡∞æ‡∞∞‡∞æ‡∞ú‡∞ó‡±Å‡∞π‡±ç‡∞Ø‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="10">10. ‡∞µ‡∞ø‡∞≠‡±Ç‡∞§‡∞ø‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="11">11. ‡∞µ‡∞ø‡∞∂‡±ç‡∞µ‡∞∞‡±Ç‡∞™‡∞∏‡∞®‡±ç‡∞¶‡∞∞‡±ç‡∞∂‡∞®‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="12">12. ‡∞≠‡∞ï‡±ç‡∞§‡∞ø‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="13">13. ‡∞ï‡±ç‡∞∑‡±á‡∞§‡±ç‡∞∞‡∞ï‡±ç‡∞∑‡±á‡∞§‡±ç‡∞∞‡∞ú‡±ç‡∞û‡∞µ‡∞ø‡∞≠‡∞æ‡∞ó‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="14">14. ‡∞ó‡±Å‡∞£‡∞§‡±ç‡∞∞‡∞Ø‡∞µ‡∞ø‡∞≠‡∞æ‡∞ó‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="15">15. ‡∞™‡±Å‡∞∞‡±Å‡∞∑‡±ã‡∞§‡±ç‡∞§‡∞Æ‡∞™‡±ç‡∞∞‡∞æ‡∞™‡±ç‡∞§‡∞ø‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="16">16. ‡∞¶‡±à‡∞µ‡∞æ‡∞∏‡±Å‡∞∞‡∞∏‡∞Æ‡±ç‡∞™‡∞¶‡±ç‡∞µ‡∞ø‡∞≠‡∞æ‡∞ó‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="17">17. ‡∞∂‡±ç‡∞∞‡∞¶‡±ç‡∞ß‡∞æ‡∞§‡±ç‡∞∞‡∞Ø‡∞µ‡∞ø‡∞≠‡∞æ‡∞ó‡∞Ø‡±ã‡∞ó‡∞É</option>
                  <option value="18">18. ‡∞Æ‡±ã‡∞ï‡±ç‡∞∑‡∞∏‡∞®‡±ç‡∞®‡±ç‡∞Ø‡∞æ‡∞∏‡∞Ø‡±ã‡∞ó‡∞É</option>
               </select>
            </div>
         </div>
      </div>
      <div>
         <h3>Search for word (Telugu or English or Number):</h3>
         <input type="text" id="search-input" placeholder="Enter word or number to search" data-intro="Type a word to search across shlokas" data-title="Enter Query">
         <button id="search-button" data-intro="Click to search" data-title="Run Search">Search</button>
      </div>
      <div class="credits">
         SGS Audio:<br>
         Pujya Sri Datta Vijayanand Teertha Swamiji<br>
         Sringeri Audio courtesy:<br>
         Smt Mathangi Kailasnath<br>
         Developed by<br>
         Dr. P. Udayabhaskar
      </div>
      <div id="verseTableModal" class="modal">
         <div class="modal-content">
            <button class="close-button" onclick="closeVerseTable()">Close</button>
            <select id="chapterTableSelect" class="chapter-select" onchange="updateVerseGrid()">
               <option value="" selected disabled>-- Select Chapter --</option>
               <option value="1">Chapter 1 (47 verses)</option>
               <option value="2">Chapter 2 (72 verses)</option>
               <option value="3">Chapter 3 (43 verses)</option>
               <option value="4">Chapter 4 (42 verses)</option>
               <option value="5">Chapter 5 (29 verses)</option>
               <option value="6">Chapter 6 (47 verses)</option>
               <option value="7">Chapter 7 (30 verses)</option>
               <option value="8">Chapter 8 (28 verses)</option>
               <option value="9">Chapter 9 (34 verses)</option>
               <option value="10">Chapter 10 (42 verses)</option>
               <option value="11">Chapter 11 (55 verses)</option>
               <option value="12">Chapter 12 (20 verses)</option>
               <option value="13">Chapter 13 (34 verses)</option>
               <option value="14">Chapter 14 (27 verses)</option>
               <option value="15">Chapter 15 (20 verses)</option>
               <option value="16">Chapter 16 (24 verses)</option>
               <option value="17">Chapter 17 (28 verses)</option>
               <option value="18">Chapter 18 (78 verses)</option>
            </select>
            <div id="verseTableContent" class="verse-grid"></div>
         </div>
         <script>
            // Global variables holding text file contents
            let sgsTeluguContent = '';
            let sringeriTeluguContent = '';
            let englishSGSContent = '';
            let englishSringeriContent = '';
            let englishContent = '';
            
            let selectedStyle = 'sringeri';
            let isContinuousPlaying = false;
            let isInstructionsVisible = false;
            let isShowingMeanings = false;
            let previousText = '';
            let sessionId = 'session-' + Math.random().toString(36).substr(2, 9);
            let currentContext = [];
            let currentAllShlokas = []; // For Confusing Shlokas
            let isConfusingPlaying = false;
            let confusingPlayId = 0;
            let isTourActive = false; // Intro.js tour state
            const baseUrl = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/main';
            const verseCounts = {
                1: 47, 2: 72, 3: 43, 4: 42, 5: 29, 6: 47, 7: 30, 8: 28,
                9: 34, 10: 42, 11: 55, 12: 20, 13: 34, 14: 27, 15: 20,
                16: 24, 17: 28, 18: 78
            };
            const confusingShlokaGroups = [
                ['1.24', '2.9', '11.9'], ['1.20', '1.37'], ['1.38', '1.39'], ['2.6', '11.32'],
                ['2.10', '1.21', '1.24'], ['2.17', '8.22', '18.46'], ['2.25', '2.26', '2.27', '2.30'],
                ['2.33', '2.38'], ['2.32', '4.22'], ['2.41', '2.44'], ['2.48', '5.10', '18.6', '18.26'],
                ['2.57', '2.58', '2.61', '2.68'], ['2.58', '5.9', '2.68'], ['2.56', '4.10'],
                ['2.71', '12.13'], ['3.13', '3.31', '4.31'], ['3.23', '4.11'], ['3.27', '13.29'],
                ['3.34', '18.51'], ['3.40', '3.42'], ['4.6', '9.8'], ['4.16', '9.1'],
                ['4.19', '4.37'], ['4.31', '4.40'], ['4.39', '5.6'], ['4.41', '9.9'],
                ['5.3', '2.45'], ['5.5', '13.27'], ['5.6', '18.1'], ['5.24', '5.26'],
                ['5.25', '12.4'], ['5.29', '10.3'], ['6.7', '12.18'], ['6.8', '14.24'],
                ['6.15', '6.28'], ['6.22', '18.32'], ['6.31', '13.23'], ['6.34', '8.14'],
                ['6.45', '13.28'], ['6.37', '6.40'], ['6.47', '4.40'], ['7.1', '6.35'],
                ['7.6', '10.8'], ['7.10', '10.36', '10.24'], ['7.13', '7.25'], ['7.16', '7.11'],
                ['7.15', '7.20'], ['7.23', '9.11'], ['7.27', '13.6'], ['7.30', '8.2'],
                ['8.2', '8.4'], ['8.1', '8.4'], ['8.7', '8.27', '12.14'], ['8.13', '9.32'],
                ['8.21', '15.6'], ['8.23', '10.1'], ['9.9', '14.24'], ['9.10', '9.23'],
                ['9.16', '9.24'], ['9.34', '18.65'], ['10.1', '18.64'], ['10.5', '16.2'],
                ['10.32', '10.39'], ['10.42', '6.42'], ['10.39', '18.40'], ['11.7', '11.13'],
                ['11.16', '11.17', '11.19'], ['11.18', '11.38'], ['11.25', '11.45'],
                ['11.52', '11.53'], ['12.6', '18.57'], ['13.2', '13.34'], ['13.23', '2.19'],
                ['16.3', '16.5'], ['16.10', '16.17'], ['16.18', '8.53'], ['16.23', '17.1'],
                ['17.1', '9.23'], ['17.19', '17.22', '18.22'], ['17.24', '17.25'],
                ['18.3', '18.5'], ['18.20', '13.16'], ['18.30', '16.7'], ['18.53', '14.26'],
                ['18.54', '12.17', '13.27'], ['18.58', '2.33'], ['18.76', '18.77']
            ];
                    const uvachaShlokas = [
                        '1.1', '1.2', '1.21', '1.24', '1.25', '1.28', '1.47', '2.1', '2.2', '2.4', '2.9', '2.10', '2.11', '2.54', '2.55',
                        '3.1', '3.3', '3.36', '3.37', '4.1', '4.4', '4.5', '5.1', '5.2', '6.1', '6.33', '6.5', '6.37', '6.40', '7.1',
                        '8.1', '8.3', '9.1', '10.1', '10.12', '10.19', '11.1', '11.5', '11.9', '11.15', '11.32', '11.35', '11.6', '11.47',
                        '11.50', '11.51', '11.52', '12.1', '12.2', '13.1', '14.1', '14.21', '14.22', '15.1', '16.1', '17.1', '17.2', '18.1',
                        '18.2', '18.73', '18.74'
                    ];
            
                    // Initialize
                    function initialize() {
                        console.log('initialize: Starting');
                        localStorage.removeItem('gitaSessionId');
                        localStorage.removeItem('gitaContext');
                        console.log('Cleared localStorage (gitaSessionId, gitaContext)');
                        localStorage.setItem('gitaSessionId', sessionId);
                        updateTextboxVisibility();
                        adjustTextboxHeight();
                        console.log('initialize: Completed');
                    }
            
            // Load text files asynchronously from GitHub raw URLs
            async function loadFiles() {
                try {
                    const sgsTeluguResponse = await fetch('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_Telugu_SGS.txt');
                    if (!sgsTeluguResponse.ok) throw new Error('Failed to load BG_Telugu_SGS.txt');
                    sgsTeluguContent = await sgsTeluguResponse.text();
            
                    const sringeriTeluguResponse = await fetch('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_Telugu_Sringeri.txt');
                    if (!sringeriTeluguResponse.ok) throw new Error('Failed to load BG_Telugu_Sringeri.txt');
                    sringeriTeluguContent = await sringeriTeluguResponse.text();
            
                    const englishSGSResponse = await fetch('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_English_SGS.txt');
                    if (!englishSGSResponse.ok) throw new Error('Failed to load BG_English_SGS.txt');
                    englishSGSContent = await englishSGSResponse.text();
            
                    const englishSringeriResponse = await fetch('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_English_Sringeri.txt');
                    if (!englishSringeriResponse.ok) throw new Error('Failed to load BG_English_Sringeri.txt');
                    englishSringeriContent = await englishSringeriResponse.text();
            
                    // Combined buffer for English search across both styles
                    englishContent = `${englishSGSContent}\n${englishSringeriContent}`;
            
                    console.log('Files loaded:', {
                        sgsTeluguLines: sgsTeluguContent.split('\n').length,
                        sringeriTeluguLines: sringeriTeluguContent.split('\n').length,
                        englishSGSLines: englishSGSContent.split('\n').length,
                        englishSringeriLines: englishSringeriContent.split('\n').length
                    });
                } catch (err) {
                    alert(err.message);
                    console.error(err);
                }
            }
            
            // Highlight matched words in output with red text
            function highlightText(text, searchTerm, isShlokaNumberSearch = false) {
                if (!searchTerm) return text;
                // Skip highlighting for shloka number in number searches
                if (isShlokaNumberSearch) {
                    return text;
                }
                // Escape special regex characters in searchTerm
                const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedTerm})`, 'gi');
                return text.replace(regex, `<span style="color: red;">$1</span>`);
            }
            
            // Format shloka display with number on its own line and two poetic lines
            function formatShlokaDisplay(lines, searchTerm, isShlokaNumberSearch = false) {
               try {
                   if (!Array.isArray(lines) || lines.length === 0) return '';
                   const firstLine = (lines[0] || '').trim();
                   let number = '';
                   let firstRemainder = '';
                   const m = firstLine.match(/^(\d+\.\d+)\s*(.*)$/);
                   if (m) {
                       number = m[1];
                       firstRemainder = (m[2] || '').trim();
                   } else {
                       number = (firstLine.split(/[\s\t]+/)[0] || '').trim();
                       firstRemainder = firstLine.slice(number.length).trim();
                   }
                   const contentParts = [];
                   if (firstRemainder) contentParts.push(firstRemainder);
                   for (let i = 1; i < lines.length; i++) {
                       const part = (lines[i] || '').trim();
                       if (part) contentParts.push(part);
                   }
                   let content = contentParts.join(' ').replace(/\s+/g, ' ').trim();
                   let line1 = content;
                   let line2 = '';
                   const dandaIdx = content.indexOf('‡••');
                   if (dandaIdx !== -1) {
                       line1 = content.slice(0, dandaIdx + 1).trim();
                       line2 = content.slice(dandaIdx + 1).trim();
                   }
                   if (searchTerm && !isShlokaNumberSearch) {
                       line1 = highlightText(line1, searchTerm, false);
                       line2 = highlightText(line2, searchTerm, false);
                   }
                   const numHtml = `<div class="shloka-number">${number}</div>`;
                   const linesHtml = `<div class="shloka-lines">${line1}${line2 ? '<br>' + line2 : ''}</div>`;
                   return `<div>${numHtml}${linesHtml}</div>`;
               } catch (e) {
                   console.error('formatShlokaDisplay error:', e);
                   return lines.map(l => highlightText(l, searchTerm, isShlokaNumberSearch)).join('<br>');
               }
            }
            
            // Search function to handle Telugu, English, and shloka number searches
            async function performSearch() {
                const searchInput = document.getElementById('search-input').value.trim();
                const sgsOutput = document.getElementById('sgsText');
                const sringeriOutput = document.getElementById('sringeriText');
                const audioPlayer = document.getElementById('audioPlayer');
                const style = getSelectedStyle();
            
                if (!sgsOutput || !sringeriOutput || !audioPlayer) {
                    alert('Output or audio elements missing');
                    return;
                }
            
                // Clear previous results and reset audio
                sgsOutput.innerHTML = '';
                sringeriOutput.innerHTML = '';
                audioPlayer.src = '';
                audioPlayer.onended = null;
            
                if (!searchInput) {
                    sgsOutput.innerHTML = 'Please enter a search term.';
                    sringeriOutput.innerHTML = 'Please enter a search term.';
                    return;
                }
            
                // Check if files are loaded
                if (!sgsTeluguContent || !sringeriTeluguContent || !englishContent) {
                    sgsOutput.innerHTML = 'Text files not loaded. Please try again.';
                    sringeriOutput.innerHTML = 'Text files not loaded. Please try again.';
                    return;
                }
            
                console.log('Searching for:', searchInput); // Debug log
            
                // Normalize line endings and split
                const teluguContent = style === 'sgs' ? sgsTeluguContent : sringeriTeluguContent;
                const teluguLines = teluguContent.replace(/\r\n/g, '\n').split('\n');
                const englishLines = englishContent.replace(/\r\n/g, '\n').split('\n');
            
                // Check if the input is a shloka number (e.g., 12.2)
                const shlokaNumberPattern = /^\d+\.\d+\s*$/;
                if (shlokaNumberPattern.test(searchInput)) {
                    const [chapter, verse] = searchInput.split('.').map(Number);
                    const combinedText = await fetchCombinedShlokaText(chapter, verse, style);
                    sgsOutput.innerHTML = combinedText;
                    sringeriOutput.innerHTML = combinedText;
                    console.log('Shloka found:', searchInput); // Debug log
            
                    // Save context for this shloka
                    currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                    currentContext.push({
                        name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                        lifespanCount: 5,
                        parameters: { chapter, verse, style: getSelectedStyle(), showingMeaning: false }
                    });
                    localStorage.setItem('gitaContext', JSON.stringify(currentContext));
            
                    // Fetch and autoplay full shloka audio
                    const audioUrl = await fetchAudioUrl(chapter, verse, null, true);
                    if (audioUrl && audioUrl.error) {
                        sgsOutput.innerHTML += `<br>${audioUrl.error}`;
                        sringeriOutput.innerHTML += `<br>${audioUrl.error}`;
                        adjustTextboxHeight();
                    } else if (audioUrl) {
                        try {
                            isProcessingAudio = true;
                            audioPlayer.pause();
                            audioPlayer.src = '';
                            audioPlayer.currentTime = 0;
                            audioPlayer.src = audioUrl;
                            audioPlayer.load();
                            await audioPlayer.play();
                        } catch (err) {
                            const msg = `Error playing audio for ${chapter}.${verse}: ${err.message}`;
                            sgsOutput.innerHTML += `<br>${msg}`;
                            sringeriOutput.innerHTML += `<br>${msg}`;
                            console.error('performSearch (number):', msg);
                        } finally {
                            isProcessingAudio = false;
                            adjustTextboxHeight();
                        }
                    }
                } else {
                    // Normalize search input
                    const normalizedSearchInput = searchInput.replace(/\s+/g, ' ').trim().normalize('NFC');
            
                    // Check if the input is Telugu (contains Telugu characters)
                    const teluguPattern = /[\u0C00-\u0C7F]/;
                    let foundShlokas = [];
                    if (teluguPattern.test(normalizedSearchInput)) {
                        // Search for Telugu word in teluguContent
                        let currentShloka = [];
                        let currentShlokaNumber = null;
            
                        for (let i = 0; i < teluguLines.length; i++) {
                            const line = teluguLines[i].trim();
                            const normalizedLine = line.replace(/\s+/g, ' ').trim().normalize('NFC');
                            const lineStart = line.split(/[\s\t]+/)[0].trim();
                            if (lineStart.match(shlokaNumberPattern)) {
                                if (currentShloka.length > 0) {
                                    const shlokaText = currentShloka.join(' ').replace(/\s+/g, ' ').trim().normalize('NFC');
                                    const regex = new RegExp(normalizedSearchInput.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                                    if (regex.test(shlokaText)) {
                                        foundShlokas.push(currentShlokaNumber);
                                    }
                                }
                                currentShloka = [line];
                                currentShlokaNumber = lineStart;
                            } else if (currentShloka.length > 0 && line) {
                                currentShloka.push(line);
                            }
                        }
                        // Check the last shloka
                        if (currentShloka.length > 0) {
                            const shlokaText = currentShloka.join(' ').replace(/\s+/g, ' ').trim().normalize('NFC');
                            const regex = new RegExp(normalizedSearchInput.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                            if (regex.test(shlokaText)) {
                                foundShlokas.push(currentShlokaNumber);
                            }
                        }
                    } else {
                        // English word search
                        for (let i = 0; i < englishLines.length; i++) {
                            const line = englishLines[i].replace(/\s+/g, ' ').trim().normalize('NFC');
                            const regex = new RegExp(normalizedSearchInput.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                            if (regex.test(line)) {
                                const shlokaNumber = line.split(/[\s\t]+/)[0].trim();
                                if (shlokaNumber.match(shlokaNumberPattern)) {
                                    foundShlokas.push(shlokaNumber);
                                }
                            }
                        }
                    }
            
                    if (foundShlokas.length > 0) {
                        // Sort found shlokas
                        foundShlokas.sort((a, b) => {
                            const [aChapter, aVerse] = a.split('.').map(Number);
                            const [bChapter, bVerse] = b.split('.').map(Number);
                            return aChapter === bChapter ? aVerse - bVerse : aChapter - bChapter;
                        });
            
                        const results = await Promise.all(foundShlokas.map(async num => {
                            const [chapter, verse] = num.split('.').map(Number);
                            let combined = await fetchCombinedShlokaText(chapter, verse, style);
                            return highlightText(combined, searchInput);
                        }));
            
                        const resultText = results.join('<br><br>');
                        sgsOutput.innerHTML = resultText;
                        sringeriOutput.innerHTML = resultText;
                    } else {
                        sgsOutput.innerHTML = `No shlokas found containing "${searchInput}".`;
                        sringeriOutput.innerHTML = `No shlokas found containing "${searchInput}".`;
                    }
                }
            
                // Auto-expand textboxes based on content
                [sgsOutput, sringeriOutput].forEach(el => {
                    el.style.height = 'auto'; // Reset height
                    el.style.height = `${el.scrollHeight}px`; // Expand to fit content
                });
            }
            
            // Add event listener to the search button
            document.getElementById('search-button').addEventListener('click', performSearch);
            
            // Optional: Add enter key support for search
            document.getElementById('search-input').addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    performSearch();
                }
            });
            // Wrap each shloka/line in a block div for vertical stacking
            function setResults(linesArray) {
              const html = linesArray.map(line => `<div>${line}</div>`).join('');
              document.getElementById("sgsText").innerHTML = html;
              document.getElementById("sringeriText").innerHTML = html;
            }
            
            // Adjust container heights after content change
            function adjustTextboxHeight() {
              ['sgsText', 'sringeriText'].forEach(id => {
                const el = document.getElementById(id);
                el.style.height = 'auto';
                el.style.height = `${el.scrollHeight}px`;
              });
            }
            
            // Load files when the page loads
            document.addEventListener('DOMContentLoaded', loadFiles);
            
            
            
            
            
            
            
                     
              // Verses per chapter in Bhagavad Gita
              const versesPerChapter = [47, 72, 43, 42, 29, 47, 30, 28, 34, 42, 55, 20, 35, 27, 20, 24, 28, 78];
            
              // Function to calculate line index for chapter and verse (0-based)
              function calculateLineIndex(chapter, verse) {
                let index = 0;
                for (let i = 1; i < chapter; i++) {
                  index += versesPerChapter[i - 1];
                }
                index += verse - 1;
                return index;
              }
            
              // Initialize event listeners
              document.addEventListener('DOMContentLoaded', () => {
                loadFiles();
            
                const btn = document.getElementById('search-button');
                if (btn) btn.addEventListener('click', performSearch);
            
                const input = document.getElementById('search-input');
                if (input) input.addEventListener('keypress', e => {
                  if (e.key === 'Enter') performSearch();
                });
                // Tour starts only when user taps the 'Help' button.
             });
            
            
                     
                     
                              console.log('Script loaded at', new Date('2025-08-17T12:18:00+05:30').toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }));
                              
                              //const baseUrl = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main';
                              //const verseCounts = {
                               //   1: 47, 2: 72, 3: 43, 4: 42, 5: 29, 6: 47, 7: 30, 8: 28,
                              //    9: 34, 10: 42, 11: 55, 12: 20, 13: 34, 14: 27, 15: 20,
                              //    16: 24, 17: 28, 18: 78
                             // };
                              
                              //let isContinuousPlaying = false;
                              let continuousPlayInterval = null;
                              //let isInstructionsVisible = false;
                              //let previousText = '';
                              //let isShowingMeanings = false;
                              //let sessionId = 'session-' + Math.random().toString(36).substr(2, 9);
                              //let currentContext = [];
                              
            
            
                              function initialize() {
                                  try {
                                      console.log('Initializing Bhagavad Gita Bot');
                                      localStorage.removeItem('gitaSessionId');
                                      localStorage.removeItem('gitaContext');
                                      console.log('Cleared localStorage (gitaSessionId, gitaContext)');
                                      localStorage.setItem('gitaSessionId', sessionId);
                                      adjustTextboxHeight();
                                      updateTextboxVisibility();
                                  } catch (error) {
                                      console.error('Initialization error:', error);
                                  }
                              }
                              
                              // Intro.js tour instance (new API)
                             let tourInstance = null;
                             function buildTourInstance() {
                                 if (typeof introJs === 'undefined' || typeof introJs.tour !== 'function') {
                                     console.error('Intro.js library not loaded or tour API unavailable');
                                     return null;
                                 }
                                 const t = introJs.tour();
                                 t.setOptions({
                                     showProgress: true,
                                     showBullets: false,
                                     exitOnOverlayClick: true,
                                     disableInteraction: false,
                                     nextLabel: 'Next',
                                     prevLabel: 'Back',
                                     skipLabel: 'Skip',
                                     doneLabel: 'Done',
                                     tooltipClass: 'introjs-tooltip--custom',
                                     highlightClass: 'introjs-highlight--custom'
                                 });
                                 // Dynamically add steps from elements carrying data-intro
                                 const stepEls = Array.from(document.querySelectorAll('[data-intro]'));
                                 stepEls.forEach(el => {
                                     const intro = el.getAttribute('data-intro') || '';
                                     const title = el.getAttribute('data-title') || '';
                                     try { t.addStep({ element: el, title, intro }); } catch (_) { /* ignore invalid elements */ }
                                 });
                                 return t;
                             }
                             
                             function toggleInstructions() {
                                 try {
                                     console.log('toggleInstructions (tour) called');
                                     const instructionsButton = document.getElementById('instructionsButton');
                                     const audioPlayer = document.getElementById('audioPlayer');
                                     // Cancel any Confusing playback
                                     isConfusingPlaying = false;
                                     confusingPlayId++;
                                     // Pause any ongoing playback
                                     if (audioPlayer && !audioPlayer.paused) {
                                         audioPlayer.pause();
                                     }
                                     isContinuousPlaying = false;
                                     // Build a fresh tour instance using data-intro elements
                                     tourInstance = buildTourInstance();
                                     if (!tourInstance) return;
                                     const resetUI = () => {
                                         isTourActive = false;
                                         if (instructionsButton) instructionsButton.textContent = 'Help';
                                         adjustTextboxHeight();
                                         updateTextboxVisibility();
                                     };
                                     tourInstance.onbeforeexit(() => { resetUI(); });
                                     tourInstance.onexit(() => { resetUI(); });
                                     tourInstance.oncomplete(() => { resetUI(); });
                                     if (instructionsButton) instructionsButton.textContent = 'Close Tour';
                                     isTourActive = true;
                                     tourInstance.start();
                                 } catch (error) {
                                     console.error('Error in toggleInstructions (tour):', error);
                                 }
                             }
            
             // Fetch audio URL
             async function fetchAudioUrl(chapter, verse, quarter = null, isFull = false) {
                try {
                    console.log(`fetchAudioUrl: chapter=${chapter}, verse=${verse}, quarter=${quarter}, isFull=${isFull}`);
                    const style = getSelectedStyle();
                    const key = `${chapter}.${verse}`;
                    let url;
                    if (isFull) {
                        const folder = style === 'sringeri' ? 'AudioFullSringeri' : 'AudioFullSGS';
                        url = `${baseUrl}/${folder}/${key}.mp3`;
                    } else if (quarter === 'pada1') {
                        url = `${baseUrl}/AQ4PaadasSGS/Chapter ${chapter}/${verse}.1.mp3`;
                    } else if (quarter === 'pada3') {
                        const folder = style === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
                        url = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.3.mp3`;
                    } else if (quarter === 'pada1_or_pada3') {
                        const folder = style === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
                        const pada = Math.random() < 0.5 ? '1' : '3';
                        url = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.${pada}.mp3`;
                    } else {
                        const folder = style === 'sringeri' ? 'AudioFullSringeri' : 'AudioFullSGS';
                        url = `${baseUrl}/${folder}/${key}.mp3`;
                    }
                    const response = await fetch(url, { method: 'HEAD' });
                    if (!response.ok) throw new Error(`Audio not found: ${url}`);
                    return url;
                } catch (error) {
                    console.error(`fetchAudioUrl: Error for ${chapter}.${verse}: ${error.message}`);
                    return { error: `Audio not found for ${chapter}.${verse}` };
                }
            }
            function getSelectedLanguages() {
            const langs = [];
            if (document.getElementById('telugu').checked) langs.push('Telugu');
            if (document.getElementById('devanagari').checked) langs.push('Devanagari');
            if (document.getElementById('english').checked) langs.push('English');
            if (document.getElementById('kannada').checked) langs.push('Kannada');
            if (document.getElementById('tamil').checked) langs.push('Tamil');
            return langs.length > 0 ? langs : ['Telugu'];
            }                   async function fetchCombinedShlokaText(chapter, verse, style) {
                                  try {
                                      console.log(`fetchCombinedShlokaText called: chapter=${chapter}, verse=${verse}, style=${style}`);
                                      const langs = getSelectedLanguages();
                                      const texts = await Promise.all(langs.map(async (lang) => {
                                          if (lang === 'English') {
                                              const englishSrc = style === 'sgs' ? englishSGSContent : englishSringeriContent;
                                              const lines = (englishSrc || '').replace(/\r\n/g, '\n').split('\n');
                                              const key1 = `${chapter}.${verse}`;
                                              const key2 = `${chapter}-${verse}`;
                                              for (let i = 0; i < lines.length; i++) {
                                                  const line = lines[i].trim();
                                                  if (line.match(new RegExp(`^${key1}\\s+|^${key2}\\s+|^${key1}\\t|^${key2}\\t|^${key1}$|^${key2}$`))) {
                                                      const shlokaStart = line.replace(/^\d+[.-]\d+\s*/, '').trim();
                                                      let shlokaLines = [shlokaStart];
                                                      let j = i + 1;
                                                      while (j < lines.length && !lines[j].match(/^\d+[.-]\d+/)) {
                                                          if (lines[j].trim()) {
                                                              shlokaLines.push(lines[j].trim());
                                                          }
                                                          j++;
                                                      }
                                                      const shlokaText = shlokaLines.join('\n').trim();
                                                      return `${chapter}.${verse} (${lang}):\n${shlokaText}`;
                                                  }
                                              }
                                              return `${chapter}.${verse} (${lang}): Shloka not found`;
                                          } else {
                                              const styleCapitalized = style === 'sgs' ? 'SGS' : 'Sringeri';
                                              const url = `https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_${lang}_${styleCapitalized}.txt`;
                                              const response = await fetch(url);
                                              if (!response.ok) {
                                                  throw new Error(`HTTP error: ${response.status}`);
                                              }
                                              const text = await response.text();
                                              const lines = text.split('\n');
                                              const key1 = `${chapter}.${verse}`;
                                              const key2 = `${chapter}-${verse}`;
                                              for (let i = 0; i < lines.length; i++) {
                                                  const line = lines[i].trim();
                                                  if (line.match(new RegExp(`^${key1}\\s+|^${key2}\\s+|^${key1}\\t|^${key2}\\t|^${key1}$|^${key2}$`))) {
                                                      const shlokaStart = line.replace(/^\d+[.-]\d+\s*/, '').trim();
                                                      let shlokaLines = [shlokaStart];
                                                      let j = i + 1;
                                                      while (j < lines.length && !lines[j].match(/^\d+[.-]\d+/)) {
                                                          if (lines[j].trim()) {
                                                              shlokaLines.push(lines[j].trim());
                                                          }
                                                          j++;
                                                      }
                                                      const shlokaText = shlokaLines.join('\n').trim();
                                                      if (!shlokaText) {
                                                          return `${chapter}.${verse} (${lang}): Shloka not found or empty`;
                                                      }
                                                      return `${chapter}.${verse} (${lang}):\n${shlokaText}`;
                                                  }
                                              }
                                              return `${chapter}.${verse} (${lang}): Shloka not found`;
                                          }
                                     }));
                                      return texts.join('\n\n---\n\n');
                                  } catch (error) {
                                      console.error(`Error loading shloka ${chapter}.${verse}: ${error.message}`);
                                      return `Error loading shloka ${chapter}.${verse}: ${error.message}`;
                                  }
                              }
                              
                              async function fetchShlokaMeaning(chapter, verse) {
                                  try {
                                      console.log(`fetchShlokaMeaning called: chapter=${chapter}, verse=${verse}`);
                                      const url = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/meanings.txt';
                                      const response = await fetch(url);
                                      if (!response.ok) {
                                          throw new Error(`HTTP error: ${response.status}`);
                                      }
                                      const data = await response.json();
                                      const key1 = `${chapter}.${verse}`;
                                      const key2 = `${chapter}-${verse}`;
                                      const entry = data[key1] || data[key2];
                                      if (entry) {
                                          let meaningText = `${chapter}.${verse} Meaning:\n\n‡∞™‡±ç‡∞∞‡∞§‡∞ø‡∞™‡∞¶‡∞æ‡∞∞‡±ç‡∞•‡∞Ç(Word-to-Word Meaning):\n`;
                                          const w2wKeys = ["‡∞™‡±ç‡∞∞‡∞§‡∞ø‡∞™‡∞¶‡∞æ‡∞∞‡±ç‡∞•‡∞Ç","‡∞™‡±ç‡∞∞‡∞§‡∞ø‡∞™‡∞¶‡∞æ‡∞∞‡±ç‡∞•‡∞Æ‡±Å","WordToWord","Word-to-Word","WordMeaning"];
                                          const overallKeys = ["‡∞Ö‡∞∞‡±ç‡∞•‡∞Ç","‡∞Ö‡∞∞‡±ç‡∞•‡∞Æ‡±Å","‡∞∏‡∞æ‡∞∞‡∞æ‡∞Ç‡∞∂‡∞Ç","‡∞∏‡∞æ‡∞∞‡∞æ‡∞Ç‡∞∂‡∞Æ‡±Å","Overall","OverallMeaning","Meaning"];
                                          let wordToWord = null;
                                          for (const k of w2wKeys) { if (entry[k]) { wordToWord = entry[k]; break; } }
                                          if (wordToWord) {
                                              if (typeof wordToWord === 'object') {
                                                  for (const [word, meaning] of Object.entries(wordToWord)) {
                                                      meaningText += `${word}: ${meaning}\n`;
                                                  }
                                              } else {
                                                  meaningText += `${wordToWord}\n`;
                                              }
                                          } else {
                                              meaningText += 'Word-to-word meaning not available\n';
                                          }
                                          let overall = null;
                                          for (const k of overallKeys) { if (entry[k]) { overall = entry[k]; break; } }
                                          meaningText += `\n‡∞Ö‡∞∞‡±ç‡∞•‡∞Ç (Overall Meaning):\n${overall || 'Overall meaning not available'}`;
                                          return meaningText;
                                      } else {
                                          return `Meaning for ${chapter}.${verse} not found`;
                                      }
                                  } catch (error) {
                                      console.error(`Error loading meaning for ${chapter}.${verse}: ${error.message}`);
                                      return `Error loading meaning for ${chapter}.${verse}: ${error.message}`;
                                  }
                              }
                              
                              async function handleContinuousPlay(selectElement) {
                                  try {
                                      console.log('handleContinuousPlay called');
                                      const chapter = parseInt(selectElement.value);
                                      if (!chapter) {
                                          console.log('No chapter selected');
                                          return;
                                      }
                              
                                      isInstructionsVisible = false;
                                      document.getElementById('instructionsButton').textContent = 'Help';
                                      const sgsText = document.getElementById('sgsText');
                                      const sringeriText = document.getElementById('sringeriText');
                                      const audioPlayer = document.getElementById('audioPlayer');
                                      isContinuousPlaying = true;
                              
                                      if (continuousPlayInterval) {
                                          clearInterval(continuousPlayInterval);
                                      }
                              
                                      let verse = 1;
                                      const playNextVerse = async () => {
                                          if (!isContinuousPlaying || verse > verseCounts[chapter]) {
                                              isContinuousPlaying = false;
                                              selectElement.selectedIndex = 0;
                                              audioPlayer.src = '';
                                              console.log('Continuous play stopped');
                                              return;
                                          }
                              
                                          currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                                          currentContext.push({
                                              name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                                              lifespanCount: 5,
                                              parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: getSelectedStyle(), showingMeaning: false }
                                          });
                                          localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                                          console.log(`handleContinuousPlay: Updated context for ${chapter}.${verse}`);
                              
                                          const sgsShloka = await fetchCombinedShlokaText(chapter, verse, 'sgs');
                                          const sringeriShloka = await fetchCombinedShlokaText(chapter, verse, 'sringeri');
                                          sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                                          sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                                          adjustTextboxHeight();
                                          updateTextboxVisibility();
                              
                                          const audioUrl = getSelectedStyle() === 'sringeri' 
                                              ? `${baseUrl}/AudioFullSringeri/${chapter}.${verse}.mp3`
                                              : `${baseUrl}/AudioFullSGS/${chapter}.${verse}.mp3`;
                                          audioPlayer.src = audioUrl;
                                          try {
                                              audioPlayer.load();
                                              await audioPlayer.play();
                                          } catch (error) {
                                              const errorText = `${sgsText.innerText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                                              sgsText.innerText = errorText;
                                              sringeriText.innerText = errorText;
                                              adjustTextboxHeight();
                                              console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                                          }
                              
                                          audioPlayer.onended = () => {
                                              verse++;
                                              playNextVerse();
                                          };
                                      };
                              
                                      await playNextVerse();
                                      selectElement.selectedIndex = 0;
                                  } catch (error) {
                                      console.error('Error in handleContinuousPlay:', error);
                                      const sgsText = document.getElementById('sgsText');
                                      const sringeriText = document.getElementById('sringeriText');
                                      sgsText.innerText = `Error in continuous play: ${error.message}`;
                                      sringeriText.innerText = `Error in continuous play: ${error.message}`;
                                      adjustTextboxHeight();
                                  }
                              }
                              
                              function showVerseTable() {
                                  try {
                                      console.log('showVerseTable called');
                                      // Cancel Confusing playback
                                      isConfusingPlaying = false;
                                      confusingPlayId++;
                                      isInstructionsVisible = false;
                                      document.getElementById('instructionsButton').textContent = 'Help';
                                      const modal = document.getElementById('verseTableModal');
                                      const chapterSelect = document.getElementById('chapterTableSelect');
                                      chapterSelect.value = '';
                                      updateVerseGrid();
                                      modal.style.display = 'flex';
                                  } catch (error) {
                                      console.error('Error in showVerseTable:', error);
                                  }
                              }
                              
                              function updateVerseGrid() {
                                  try {
                                      console.log('updateVerseGrid called');
                                      const chapter = parseInt(document.getElementById('chapterTableSelect').value);
                                      const content = document.getElementById('verseTableContent');
                                      content.innerHTML = '';
                              
                                      if (chapter) {
                                          const verseGrid = document.createElement('div');
                                          verseGrid.className = 'verse-grid';
                                          for (let verse = 1; verse <= verseCounts[chapter]; verse++) {
                                              const verseButton = document.createElement('div');
                                              verseButton.className = 'verse-button';
                                              verseButton.textContent = `${chapter}.${verse}`;
                                              verseButton.onclick = () => selectVerse(chapter, verse);
                                              verseGrid.appendChild(verseButton);
                                          }
                                          content.appendChild(verseGrid);
                                      }
                                  } catch (error) {
                                      console.error('Error in updateVerseGrid:', error);
                                  }
                              }
                              
                              function closeVerseTable() {
                                  try {
                                      console.log('closeVerseTable called');
                                      document.getElementById('verseTableModal').style.display = 'none';
                                  } catch (error) {
                                      console.error('Error in closeVerseTable:', error);
                                  }
                              }
                              
                              async function selectVerse(chapter, verse) {
                                  try {
                                      console.log(`selectVerse called: chapter=${chapter}, verse=${verse}`);
                                      // Cancel Confusing playback
                                      isConfusingPlaying = false;
                                      confusingPlayId++;
                                      isContinuousPlaying = false;
                                      isInstructionsVisible = false;
                                      document.getElementById('instructionsButton').textContent = 'Help';
                                      const sgsText = document.getElementById('sgsText');
                                      const sringeriText = document.getElementById('sringeriText');
                                      currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                                      currentContext.push({
                                          name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                                          lifespanCount: 5,
                                          parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: getSelectedStyle(), showingMeaning: false }
                                      });
                                      localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                                      console.log('selectVerse: Updated context:', JSON.stringify(currentContext));
                                      
                                      const sgsShloka = await fetchCombinedShlokaText(chapter, verse, 'sgs');
                                      const sringeriShloka = await fetchCombinedShlokaText(chapter, verse, 'sringeri');
                                      sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                                      sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                                      adjustTextboxHeight();
                                      
                                      const audioUrl = await fetchAudioUrl(chapter, verse);
                                      const audioPlayer = document.getElementById('audioPlayer');
                                      audioPlayer.src = audioUrl;
                                      try {
                                          audioPlayer.load();
                                          await audioPlayer.play();
                                      } catch (error) {
                                          const errorText = `${sgsText.innerText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                                          sgsText.innerText = errorText;
                                          sringeriText.innerText = errorText;
                                          adjustTextboxHeight();
                                          console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                                      }
                                      
                                      updateTextboxVisibility();
                                      closeVerseTable();
                                  } catch (error) {
                                      console.error('Error in selectVerse:', error);
                                      const sgsText = document.getElementById('sgsText');
                                      const sringeriText = document.getElementById('sringeriText');
                                      sgsText.innerText = `Error selecting verse: ${error.message}`;
                                      sringeriText.innerText = `Error selecting verse: ${error.message}`;
                                      adjustTextboxHeight();
                                  }
                              }
                              
                              async function handlePreviousShloka() {
                                  try {
                                      console.log('handlePreviousShloka called');
                                      // Cancel Confusing playback
                                      isConfusingPlaying = false;
                                      confusingPlayId++;
                                      isContinuousPlaying = false;
                                      isInstructionsVisible = false;
                                      document.getElementById('instructionsButton').textContent = 'Help';
                                      const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                                      const sgsText = document.getElementById('sgsText');
                                      const sringeriText = document.getElementById('sringeriText');
                                      if (context && context.parameters && Number.isInteger(context.parameters.chapter) && Number.isInteger(context.parameters.verse)) {
                                          let chapter = Math.floor(context.parameters.chapter);
                                          let verse = Math.floor(context.parameters.verse) - 1;
                                          if (verse < 1) {
                                              chapter -= 1;
                                              if (chapter < 1) {
                                                  chapter = 1;
                                                  verse = 1;
                                              } else {
                                                  verse = verseCounts[chapter];
                                              }
                                          }
                                          currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                                          currentContext.push({
                                              name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                                              lifespanCount: 5,
                                              parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: getSelectedStyle(), showingMeaning: false }
                                          });
                                          localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                                          console.log('handlePreviousShloka: Updated context:', JSON.stringify(currentContext));
                                          
                                          const sgsShloka = await fetchCombinedShlokaText(chapter, verse, 'sgs');
                                          const sringeriShloka = await fetchCombinedShlokaText(chapter, verse, 'sringeri');
                                          sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                                          sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                                          adjustTextboxHeight();
                                          
                                          const audioUrl = getSelectedStyle() === 'sringeri' 
                                              ? `${baseUrl}/AudioFullSringeri/${chapter}.${verse}.mp3`
                                              : `${baseUrl}/AudioFullSGS/${chapter}.${verse}.mp3`;
                                          const audioPlayer = document.getElementById('audioPlayer');
                                          audioPlayer.src = audioUrl;
                                          audioPlayer.load(); // No autoplay
                                          
                                          updateTextboxVisibility();
                                      } else {
                                          sgsText.innerText = 'Please select a Shloka first';
                                          sringeriText.innerText = 'Please select a Shloka first';
                                          adjustTextboxHeight();
                                          updateTextboxVisibility();
                                      }
                                  } catch (error) {
                                      console.error('Error in handlePreviousShloka:', error);
                                      const sgsText = document.getElementById('sgsText');
                                      const sringeriText = document.getElementById('sringeriText');
                                      sgsText.innerText = `Error in previous shloka: ${error.message}`;
                                      sringeriText.innerText = `Error in previous shloka: ${error.message}`;
                                      adjustTextboxHeight();
                                  }
                              }
                              
                              async function handleMeanings() {
                                  try {
                                      console.log('handleMeanings called');
                                      // Cancel Confusing playback
                                      isConfusingPlaying = false;
                                      confusingPlayId++;
                                      isContinuousPlaying = false;
                                      isInstructionsVisible = false;
                                      const meaningsButton = document.getElementById('meaningsButton');
                                      const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                                      const sgsText = document.getElementById('sgsText');
                                      const sringeriText = document.getElementById('sringeriText');
                                      if (context && context.parameters && Number.isInteger(context.parameters.chapter) && Number.isInteger(context.parameters.verse)) {
                                          const chapter = Math.floor(context.parameters.chapter);
                                          const verse = Math.floor(context.parameters.verse);
                                          
                                          if (!isShowingMeanings) {
                                              previousText = sgsText.innerText;
                                              const meaningText = await fetchShlokaMeaning(chapter, verse);
                                              sgsText.innerText = meaningText || `Meaning for ${chapter}.${verse} not found`;
                                              sringeriText.innerText = meaningText || `Meaning for ${chapter}.${verse} not found`;
                                              meaningsButton.textContent = 'Close Meanings';
                                              isShowingMeanings = true;
                                          } else {
                                              sgsText.innerText = previousText || 'Your Shloka will appear here.';
                                              sringeriText.innerText = previousText || 'Your Shloka will appear here.';
                                              meaningsButton.textContent = 'Meanings';
                                              isShowingMeanings = false;
                                          }
                                          adjustTextboxHeight();
                                          updateTextboxVisibility();
                                      } else {
                                          sgsText.innerText = 'Please select a Shloka first';
                                          sringeriText.innerText = 'Please select a Shloka first';
                                          adjustTextboxHeight();
                                          updateTextboxVisibility();
                                      }
                                  } catch (error) {
                                      console.error('Error in handleMeanings:', error);
                                      const sgsText = document.getElementById('sgsText');
                                      const sringeriText = document.getElementById('sringeriText');
                                      sgsText.innerText = `Error fetching meanings: ${error.message}`;
                                      sringeriText.innerText = `Error fetching meanings: ${error.message}`;
                                      adjustTextboxHeight();
                                  }
                              }
            // Show confusing shlokas
            async function showConfusing() {
                console.log('showConfusing: Called');
                isContinuousPlaying = false;
                isInstructionsVisible = false;
                isShowingMeanings = false;
                currentAllShlokas = [];
                // Start a new Confusing playback session
                isConfusingPlaying = true;
                const playId = ++confusingPlayId;
                const instructionsButton = document.getElementById('instructionsButton');
                const meaningsButton = document.getElementById('meaningsButton');
                if (instructionsButton) instructionsButton.textContent = 'Help';
               if (meaningsButton) meaningsButton.textContent = 'Meanings';
               const sgsText = document.getElementById('sgsText');
               const sringeriText = document.getElementById('sringeriText');
                const audioPlayer = document.getElementById('audioPlayer');
            
                const randomGroupIndex = Math.floor(Math.random() * confusingShlokaGroups.length);
                const selectedGroup = confusingShlokaGroups[randomGroupIndex];
                currentAllShlokas = selectedGroup.slice();
                const relatedShlokas = new Set(selectedGroup);
                confusingShlokaGroups.forEach((group, index) => {
                    if (index !== randomGroupIndex && group.some(shloka => selectedGroup.includes(shloka))) {
                        group.forEach(s => relatedShlokas.add(s));
                    }
                });
                const allShlokas = Array.from(relatedShlokas).sort((a, b) => {
                    const [aChapter, aVerse] = a.split('.').map(Number);
                    const [bChapter, bVerse] = b.split('.').map(Number);
                    return aChapter === bChapter ? aVerse - bVerse : aChapter - bChapter;
                });
                // Keep full list for toggles
                currentAllShlokas = allShlokas.slice();
            
                const sgsTexts = await Promise.all(allShlokas.map(async shloka => {
                    const [chapter, verse] = shloka.split('.').map(Number);
                    return await fetchCombinedShlokaText(chapter, verse, 'sgs');
                }));
                const sringeriTexts = await Promise.all(allShlokas.map(async shloka => {
                    const [chapter, verse] = shloka.split('.').map(Number);
                    return await fetchCombinedShlokaText(chapter, verse, 'sringeri');
                }));
                const sgsOutput = sgsTexts.map(text => `<div>${text}</div>`).join('');
                const sringeriOutput = sringeriTexts.map(text => `<div>${text}</div>`).join('');
                sgsText.innerHTML = highlightText(sgsOutput, '');
                sringeriText.innerHTML = highlightText(sringeriOutput, '');
                adjustTextboxHeight();
                updateTextboxVisibility();
            
                // Play audio for all related shlokas (including overlaps), not just the initially selected group
                console.log('showConfusing: Audio play order =', allShlokas.join(', '));
                for (const shloka of allShlokas) {
                    if (confusingPlayId !== playId) break;
                    const [chapter, verse] = shloka.split('.').map(Number);
            
                    // Update context to the currently playing shloka
                    currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                    currentContext.push({
                        name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                        lifespanCount: 5,
                        parameters: { chapter, verse, style: getSelectedStyle(), showingMeaning: false }
                    });
                    localStorage.setItem('gitaContext', JSON.stringify(currentContext));
            
                    const audioUrl = await fetchAudioUrl(chapter, verse, null, true);
                    if (!audioUrl.error) {
                        audioPlayer.src = audioUrl;
                        await new Promise(resolve => {
                            if (confusingPlayId !== playId) { resolve(); return; }
                            const cancelCheck = setInterval(() => {
                                if (confusingPlayId !== playId) { clearInterval(cancelCheck); resolve(); }
                            }, 100);
                            audioPlayer.onended = () => { clearInterval(cancelCheck); resolve(); };
                            audioPlayer.play().catch(error => {
                                console.error(`showConfusing: Error playing audio for ${shloka}: ${error.message}`);
                                sgsText.innerHTML += `<br>Error playing audio for ${shloka}: ${error.message}`;
                                sringeriText.innerHTML += `<br>Error playing audio for ${shloka}: ${error.message}`;
                                adjustTextboxHeight();
                                clearInterval(cancelCheck);
                                resolve();
                            });
                        });
                    } else {
                        sgsText.innerHTML += `<br>${audioUrl.error}`;
                        sringeriText.innerHTML += `<br>${audioUrl.error}`;
                        adjustTextboxHeight();
                    }
                }
            
                // Mark the confusing playback session as completed
                isConfusingPlaying = false;
            }
            
            
            
                // Show uvacha shlokas
                    async function showUvacha() {
                        console.log('showUvacha: Called');
                        // Cancel Confusing playback
                        isConfusingPlaying = false;
                        confusingPlayId++;
                        isContinuousPlaying = false;
                        isInstructionsVisible = false;
                        isShowingMeanings = false;
                        // Ensure we're not in a Confusing list context
                        currentAllShlokas = [];
                        const instructionsButton = document.getElementById('instructionsButton');
                        const meaningsButton = document.getElementById('meaningsButton');
                        if (instructionsButton) instructionsButton.textContent = 'Help';
                       if (meaningsButton) meaningsButton.textContent = 'Meanings';
                       const audioPlayer = document.getElementById('audioPlayer');
                       const sgsText = document.getElementById('sgsText');
                       const sringeriText = document.getElementById('sringeriText');
            
                        if (!audioPlayer || !sgsText || !sringeriText) {
                            console.error('showUvacha: Missing audioPlayer or textboxes');
                            return;
                        }
            
                        const randomIndex = Math.floor(Math.random() * uvachaShlokas.length);
                        const shloka = uvachaShlokas[randomIndex];
                        const [chapter, verse] = shloka.split('.').map(Number);
            
                        // Set context immediately so language toggles reflect the same Uvacha shloka
                        currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                        currentContext.push({
                            name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                            lifespanCount: 5,
                            parameters: { chapter, verse, style: getSelectedStyle(), showingMeaning: false }
                        });
                        localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                        const sgsShloka = await fetchCombinedShlokaText(chapter, verse, 'sgs');
                        const sringeriShloka = await fetchCombinedShlokaText(chapter, verse, 'sringeri');
                        sgsText.innerText = sgsShloka || `Shloka ${shloka} not found`;
                        sringeriText.innerText = sringeriShloka || `Shloka ${shloka} not found`;
                        adjustTextboxHeight();
                        updateTextboxVisibility();
            
                        const audioUrl = await fetchAudioUrl(chapter, verse, null, true);
                        if (audioUrl.error) {
                            sgsText.innerText += `\n${audioUrl.error}`;
                            sringeriText.innerText += `\n${audioUrl.error}`;
                            adjustTextboxHeight();
                            return;
                        }
                        try {
                            audioPlayer.pause();
                            audioPlayer.onended = null;
                            audioPlayer.src = '';
                            audioPlayer.currentTime = 0;
                            audioPlayer.load();
                            audioPlayer.src = audioUrl;
                            audioPlayer.load();
                            await audioPlayer.play();
                        } catch (error) {
                            sgsText.innerText += `\nError playing audio for ${shloka}: ${error.message}`;
                            sringeriText.innerText += `\nError playing audio for ${shloka}: ${error.message}`;
                            adjustTextboxHeight();
                        }
            
                        // Context already set above before UI/audio
                    }
            
            
            
            
            
            
            // Fetch audio URL
             async function fetchAudioUrl(chapter, verse, quarter = null, isFull = false) {
                try {
                    console.log(`fetchAudioUrl: chapter=${chapter}, verse=${verse}, quarter=${quarter}, isFull=${isFull}`);
                    const style = getSelectedStyle();
                    const key = `${chapter}.${verse}`;
                    let url;
                    if (isFull) {
                        const folder = style === 'sringeri' ? 'AudioFullSringeri' : 'AudioFullSGS';
                        url = `${baseUrl}/${folder}/${key}.mp3`;
                    } else if (quarter === 'pada1') {
                        url = `${baseUrl}/AQ4PaadasSGS/Chapter ${chapter}/${verse}.1.mp3`;
                    } else if (quarter === 'pada3') {
                        const folder = style === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
                        url = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.3.mp3`;
                    } else if (quarter === 'pada1_or_pada3') {
                        const folder = style === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
                        const pada = Math.random() < 0.5 ? '1' : '3';
                        url = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.${pada}.mp3`;
                    } else {
                        const folder = style === 'sringeri' ? 'AudioFullSringeri' : 'AudioFullSGS';
                        url = `${baseUrl}/${folder}/${key}.mp3`;
                    }
                    const response = await fetch(url, { method: 'HEAD' });
                    if (!response.ok) throw new Error(`Audio not found: ${url}`);
                    return url;
                } catch (error) {
                    console.error(`fetchAudioUrl: Error for ${chapter}.${verse}: ${error.message}`);
                    return { error: `Audio not found for ${chapter}.${verse}` };
                }
            }
            function getSelectedLanguages() {
            const langs = [];
            if (document.getElementById('telugu').checked) langs.push('Telugu');
            if (document.getElementById('devanagari').checked) langs.push('Devanagari');
            if (document.getElementById('english').checked) langs.push('English');
            if (document.getElementById('kannada').checked) langs.push('Kannada');
            if (document.getElementById('tamil').checked) langs.push('Tamil');
            return langs.length > 0 ? langs : ['Telugu'];
            }                   async function fetchCombinedShlokaText(chapter, verse, style) {
                                  try {
                                      console.log(`fetchCombinedShlokaText called: chapter=${chapter}, verse=${verse}, style=${style}`);
                                      const langs = getSelectedLanguages();
                                      const texts = await Promise.all(langs.map(async (lang) => {
                                          if (lang === 'English') {
                                              const englishSrc = style === 'sgs' ? englishSGSContent : englishSringeriContent;
                                              const lines = (englishSrc || '').replace(/\r\n/g, '\n').split('\n');
                                              const key1 = `${chapter}.${verse}`;
                                              const key2 = `${chapter}-${verse}`;
                                              for (let i = 0; i < lines.length; i++) {
                                                  const line = lines[i].trim();
                                                  if (line.match(new RegExp(`^${key1}\\s+|^${key2}\\s+|^${key1}\\t|^${key2}\\t|^${key1}$|^${key2}$`))) {
                                                      const shlokaStart = line.replace(/^\d+[.-]\d+\s*/, '').trim();
                                                      let shlokaLines = [shlokaStart];
                                                      let j = i + 1;
                                                      while (j < lines.length && !lines[j].match(/^\d+[.-]\d+/)) {
                                                          if (lines[j].trim()) {
                                                              shlokaLines.push(lines[j].trim());
                                                          }
                                                          j++;
                                                      }
                                                      const shlokaText = shlokaLines.join('\n').trim();
                                                      return `${chapter}.${verse} (${lang}):\n${shlokaText}`;
                                                  }
                                              }
                                              return `${chapter}.${verse} (${lang}): Shloka not found`;
                                          } else {
                                              const styleCapitalized = style === 'sgs' ? 'SGS' : 'Sringeri';
                                              const url = `https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_${lang}_${styleCapitalized}.txt`;
                                              const response = await fetch(url);
                                              if (!response.ok) {
                                                  throw new Error(`HTTP error: ${response.status}`);
                                              }
                                              const text = await response.text();
                                              const lines = text.split('\n');
                                              const key1 = `${chapter}.${verse}`;
                                              const key2 = `${chapter}-${verse}`;
                                              for (let i = 0; i < lines.length; i++) {
                                                  const line = lines[i].trim();
                                                  if (line.match(new RegExp(`^${key1}\\s+|^${key2}\\s+|^${key1}\\t|^${key2}\\t|^${key1}$|^${key2}$`))) {
                                                      const shlokaStart = line.replace(/^\d+[.-]\d+\s*/, '').trim();
                                                      let shlokaLines = [shlokaStart];
                                                      let j = i + 1;
                                                      while (j < lines.length && !lines[j].match(/^\d+[.-]\d+/)) {
                                                          if (lines[j].trim()) {
                                                              shlokaLines.push(lines[j].trim());
                                                          }
                                                          j++;
                                                      }
                                                      const shlokaText = shlokaLines.join('\n').trim();
                                                      if (!shlokaText) {
                                                          return `${chapter}.${verse} (${lang}): Shloka not found or empty`;
                                                      }
                                                      return `${chapter}.${verse} (${lang}):\n${shlokaText}`;
                                                  }
                                              }
                                              return `${chapter}.${verse} (${lang}): Shloka not found`;
                                          }
                                     }));
                                      return texts.join('\n\n---\n\n');
                                  } catch (error) {
                                      console.error(`Error loading shloka ${chapter}.${verse}: ${error.message}`);
                                      return `Error loading shloka ${chapter}.${verse}: ${error.message}`;
                                  }
                              }
                              
                              async function handleChapterSelect(selectElement) {
                                  try {
                                      console.log('handleChapterSelect called');
                                      isContinuousPlaying = false;
                                      isInstructionsVisible = false;
                                      document.getElementById('instructionsButton').textContent = 'Help';
                                      const chapter = parseInt(selectElement.value);
                                      if (!chapter) {
                                          console.log('No chapter selected');
                                          return;
                                      }
                              
                                      const verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                                      const sgsText = document.getElementById('sgsText');
                                      const sringeriText = document.getElementById('sringeriText');
                                      currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                                      currentContext.push({
                                          name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                                          lifespanCount: 5,
                                          parameters: { chapter: chapter, verse: verse, style: getSelectedStyle(), showingMeaning: false }
                                      });
                                      localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                                      console.log('handleChapterSelect: Updated context:', JSON.stringify(currentContext));
                              
                                      const sgsShloka = await fetchCombinedShlokaText(chapter, verse, 'sgs');
                                      const sringeriShloka = await fetchCombinedShlokaText(chapter, verse, 'sringeri');
                                      sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                                      sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                                      adjustTextboxHeight();
                              
                                      const folder = getSelectedStyle() === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
                                      const randomPada = Math.random() < 0.5 ? '1' : '3';
                                      const audioUrl = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.${randomPada}.mp3`;
                                      const audioPlayer = document.getElementById('audioPlayer');
                                      audioPlayer.src = audioUrl;
                                      try {
                                          audioPlayer.load();
                                          await audioPlayer.play();
                                      } catch (error) {
                                          const errorText = `${sgsText.innerText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                                          sgsText.innerText = errorText;
                                          sringeriText.innerText = errorText;
                                          adjustTextboxHeight();
                                          console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                                      }
                              
                                      updateTextboxVisibility();
                                      selectElement.selectedIndex = 0;
                                  } catch (error) {
                                      console.error('Error in handleChapterSelect:', error);
                                      const sgsText = document.getElementById('sgsText');
                                      const sringeriText = document.getElementById('sringeriText');
                                      sgsText.innerText = `Error selecting random shloka: ${error.message}`;
                                      sringeriText.innerText = `Error selecting random shloka: ${error.message}`;
                                      adjustTextboxHeight();
                                      updateTextboxVisibility();
                                  }
                              }
                              
                              function getSelectedStyle() {
                                  try {
                                      const style = document.querySelector('input[name="style"]:checked').value;
                                      console.log(`getSelectedStyle: ${style}`);
                                      return style;
                                  } catch (error) {
                                      console.error('Error in getSelectedStyle:', error);
                                      return 'sringeri'; // Default to Sringeri style if error occurs
                                  }
                              }
                              
                              function getSelectedLanguages() {
                                  const langs = [];
                                  if (document.getElementById('telugu').checked) langs.push('Telugu');
                                  if (document.getElementById('devanagari').checked) langs.push('Devanagari');
                                  if (document.getElementById('english').checked) langs.push('English');
                                  if (document.getElementById('kannada').checked) langs.push('Kannada');
                                  if (document.getElementById('tamil').checked) langs.push('Tamil');
                                  return langs.length > 0 ? langs : ['Telugu']; // Default to Telugu if none selected
                              }
                              
                              function setSelectedStyle(style) {
                                  try {
                                      if (style === 'sgs') {
                                          document.getElementById('sgs').checked = true;
                                      } else {
                                          document.getElementById('sringeri').checked = true;
                                      }
                                      updateTextboxVisibility();
                                      console.log(`setSelectedStyle: Set style to ${style}`);
                                  } catch (error) {
                                      console.error('Error in setSelectedStyle:', error);
                                  }
                              }
                              
            function updateTextboxVisibility() {
              const sgsText = document.getElementById('sgsText');
              const sringeriText = document.getElementById('sringeriText');
              const sgsLabel = document.getElementById('sgsLabel');
              const sringeriLabel = document.getElementById('sringeriLabel');
              const sgsRadio = document.getElementById('sgs');
              const sringeriRadio = document.getElementById('sringeri');
            
              // Make sure texts are synchronized
              if (sgsRadio.checked) {
                
            
                sgsText.classList.add('visible');
                sgsText.classList.remove('hidden');
            
                sringeriText.classList.add('hidden');
                sringeriText.classList.remove('visible');
            
                sgsLabel.classList.add('active');
                sringeriLabel.classList.remove('active');
              } else {
                
            
                sringeriText.classList.add('visible');
                sringeriText.classList.remove('hidden');
            
                sgsText.classList.add('hidden');
                sgsText.classList.remove('visible');
            
                sringeriLabel.classList.add('active');
                sgsLabel.classList.remove('active');
              }
            
              adjustTextboxHeight();  // fix heights after toggle
            
              // Persist chosen style in context
              const ctx = currentContext.find(c => c && c.name && c.name.includes('shloka-context'));
              if (ctx && ctx.parameters) {
                ctx.parameters.style = sgsRadio.checked ? 'sgs' : 'sringeri';
                localStorage.setItem('gitaContext', JSON.stringify(currentContext));
              }
            }
                   
            
                              
                              async function sendCommand(intent) {
                                  try {
                                      console.log(`sendCommand called: intent=${intent}`);
                                      isContinuousPlaying = false;
                                      isInstructionsVisible = false;
                                      isShowingMeanings = false;
                                      // Cancel Confusing playback
                                      isConfusingPlaying = false;
                                      confusingPlayId++;
                                      document.getElementById('instructionsButton').textContent = 'Help';
                                      document.getElementById('meaningsButton').textContent = 'Meanings';
                                      const sgsText = document.getElementById('sgsText');
                                      const sringeriText = document.getElementById('sringeriText');
                                      const audioPlayer = document.getElementById('audioPlayer');
                                      let chapter, verse, quarter, isFullForQuarter = false, autoplay = true;
                              
                                      if (intent === 'SGSFirstPaada') {
                                          setSelectedStyle('sgs');
                                          quarter = 'pada1';
                                          chapter = Math.floor(Math.random() * 18) + 1;
                                          verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                                          autoplay = true;
                                      } else if (intent === 'SringeriPaada') {
                                          quarter = 'pada1_or_pada3';
                                          chapter = Math.floor(Math.random() * 18) + 1;
                                          verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                                          autoplay = true;
                   } else if (intent === 'ThirdPaada') {
                       quarter = 'pada3';
                       chapter = Math.floor(Math.random() * 18) + 1;
                       verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                       autoplay = true;
                                      } else if (intent === 'NextFullShloka') {
                                          const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                                          chapter = context ? Math.floor(context.parameters.chapter) : 1;
                                          verse = context ? Math.floor(context.parameters.verse) + 1 : 1;
                                          if (verse > verseCounts[chapter]) {
                                              chapter++;
                                              verse = 1;
                                              if (chapter > 18) {
                                                  chapter = 1;
                                              }
                                          }
                                          autoplay = false;
                                      } else if (intent === 'PreviousShloka') {
                                          const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                                          chapter = context ? Math.floor(context.parameters.chapter) : 1;
                                          verse = context ? Math.floor(context.parameters.verse) - 1 : 1;
                                          if (verse < 1) {
                                              chapter--;
                                              if (chapter < 1) {
                                                  chapter = 18;
                                              }
                                              verse = verseCounts[chapter];
                                          }
                                          autoplay = false;
                                      } else if (intent === 'FullShloka') {
                                          const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                                          if (!context || !context.parameters || !Number.isInteger(context.parameters.chapter) || !Number.isInteger(context.parameters.verse)) {
                                              chapter = 1;
                                              verse = 1;
                                          } else {
                                              chapter = Math.floor(context.parameters.chapter);
                                              verse = Math.floor(context.parameters.verse);
                                          }
                                          isFullForQuarter = true;
                                          autoplay = true;
                                      }
                              
                                      currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                                      currentContext.push({
                                          name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                                          lifespanCount: 5,
                                          parameters: { chapter: chapter, verse: verse, style: getSelectedStyle(), showingMeaning: false }
                                      });
                                      localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                                      console.log('sendCommand: Updated context:', JSON.stringify(currentContext));
                              
                                      const sgsShloka = await fetchCombinedShlokaText(chapter, verse, 'sgs');
                                      const sringeriShloka = await fetchCombinedShlokaText(chapter, verse, 'sringeri');
                                      sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                                      sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                                      adjustTextboxHeight();
                              
                                      const audioUrl = await fetchAudioUrl(chapter, verse, quarter, isFullForQuarter);
                                      if (audioUrl && audioUrl.error) {
                                          sgsText.innerText = `${sgsText.innerText}\n${audioUrl.error}`;
                                          sringeriText.innerText = `${sringeriText.innerText}\n${audioUrl.error}`;
                                          adjustTextboxHeight();
                                          return;
                                      }
                                      audioPlayer.src = audioUrl;
                                      audioPlayer.load();
                                      if (autoplay) {
                                          await audioPlayer.play().catch(error => {
                                              console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                                              sgsText.innerText = `${sgsText.innerText}\nError playing audio: ${error.message}`;
                                              sringeriText.innerText = `${sringeriText.innerText}\nError playing audio: ${error.message}`;
                                              adjustTextboxHeight();
                                          });
                                      }
                                      updateTextboxVisibility();
                                  } catch (error) {
                                      console.error('Error in sendCommand:', error);
                                      const sgsText = document.getElementById('sgsText');
                                      const sringeriText = document.getElementById('sringeriText');
                                      sgsText.innerText = `Error: ${error.message}`;
                                      sringeriText.innerText = `Error: ${error.message}`;
                                      adjustTextboxHeight();
                                  }
                              }
                              document.querySelectorAll('.top-buttons button').forEach(button => {
                              button.addEventListener('click', () => {
                              button.classList.toggle('clicked');
                              });
                              });
                              
                     document.addEventListener("DOMContentLoaded", function () {
                        const audio = document.getElementById("audioPlayer");
                        const sgsBtn = document.querySelector(".top-buttons .sgs-button");
                        const sringeriBtn = document.querySelector(".top-buttons .sringeri-button");
                     
                        let activeBtn = null; // Track which button was clicked
                     
                        function resetButtons() {
                           [sgsBtn, sringeriBtn].forEach(btn => {
                              if (btn) {
                                 btn.classList.remove("sgs-playing", "sringeri-playing");
                              }
                           });
                        }
                     
                        if (sgsBtn) {
                           sgsBtn.addEventListener("click", function () {
                              activeBtn = sgsBtn;
                           });
                        }
                     
                        if (sringeriBtn) {
                           sringeriBtn.addEventListener("click", function () {
                              activeBtn = sringeriBtn;
                           });
                        }
                     
                        if (audio) {
                           // When audio starts
                           audio.addEventListener("play", function () {
                              resetButtons(); // Clear old states first
                              if (activeBtn === sgsBtn) {
                                 sgsBtn.classList.remove("reset");
                                 sgsBtn.classList.add("sgs-playing");
                              } else if (activeBtn === sringeriBtn) {
                                 sringeriBtn.classList.remove("reset");
                                 sringeriBtn.classList.add("sringeri-playing");
                              }
                           });
                     
                           // When audio ends
                           audio.addEventListener("ended", function () {
                              resetButtons();
                              activeBtn = null; // clear after playback ends
                           });
                        }
                     });
                         
            			 initialize();
              document.addEventListener('DOMContentLoaded', () => {
                loadFiles().then(() => {
                  updateTextboxVisibility();
                  adjustTextboxHeight();
                  // Comment out initial search on load to test responsiveness
                  // performSearch();
                });
              
                document.getElementById('groupButton').onclick = () => {
                window.open('https://pubsaroja.github.io/gita-voice-bot-web/GroupedShlokas.html', '_blank');
               };
               
               // Add event listeners for language checkboxes to refresh current shloka
               document.querySelectorAll('.language-group input[type="checkbox"]').forEach(checkbox => {
                   checkbox.addEventListener('change', async () => {
                       const sgsEl = document.getElementById('sgsText');
                       const sringeriEl = document.getElementById('sringeriText');
                       if (Array.isArray(currentAllShlokas) && currentAllShlokas.length > 0) {
                           // Rebuild the Confusing Shlokas list for current language selection
                           const sgsTexts = await Promise.all(currentAllShlokas.map(num => {
                               const [ch, v] = num.split('.').map(Number);
                               return fetchCombinedShlokaText(ch, v, 'sgs');
                           }));
                           const sringeriTexts = await Promise.all(currentAllShlokas.map(num => {
                               const [ch, v] = num.split('.').map(Number);
                               return fetchCombinedShlokaText(ch, v, 'sringeri');
                           }));
                           sgsEl.innerHTML = sgsTexts.map(t => `<div>${t}</div>`).join('');
                           sringeriEl.innerHTML = sringeriTexts.map(t => `<div>${t}</div>`).join('');
                           adjustTextboxHeight();
                           updateTextboxVisibility();
                       } else {
                           const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                           if (context && context.parameters && context.parameters.chapter && context.parameters.verse) {
                               const chapter = context.parameters.chapter;
                               const verse = context.parameters.verse;
                               const sgsShloka = await fetchCombinedShlokaText(chapter, verse, 'sgs');
                               const sringeriShloka = await fetchCombinedShlokaText(chapter, verse, 'sringeri');
                               sgsEl.innerText = sgsShloka;
                               sringeriEl.innerText = sringeriShloka;
                               adjustTextboxHeight();
                               updateTextboxVisibility();
                           }
                       }
                   });
               });
            });
                   // Theme toggle functionality
            const themeButtons = document.querySelectorAll('.theme-toggle button');
            const setTheme = (theme) => {
               document.documentElement.setAttribute('data-theme', theme);
               themeButtons.forEach(btn => {
                   btn.classList.toggle('active', btn.dataset.theme === theme);
               });
               localStorage.setItem('theme', theme);
            
               // Handle system theme
               if (theme === 'system') {
                   const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                   document.documentElement.setAttribute('data-theme', systemTheme);
               }
            };
            
            
            // Initialize theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            
            // Theme button event listeners
            themeButtons.forEach(button => {
               button.addEventListener('click', () => {
                   setTheme(button.dataset.theme);
               });
            });
            
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
               if (document.documentElement.getAttribute('data-theme') === 'system') {
                   setTheme('system');
               }
            });     
// ‚Äî‚Äî‚Äî FINAL PERFECT VERSION (Width Fixed + Stop Button Smart + Exact Gaps) ‚Äî‚Äî‚Äî
let lastRandomIntent = null;
let continuousPlayEnabled = false;
let continuousDelay = 60000;
let waitingForNext = false;

const audioPlayer = document.getElementById('audioPlayer');
const stopBtn = document.getElementById('stopContinuousBtn');

// Single reliable handler
function scheduleNextRandom() {
   if (!continuousPlayEnabled || waitingForNext) return;
   waitingForNext = true;

   setTimeout(() => {
      if (continuousPlayEnabled && lastRandomIntent) {
         sendCommand(lastRandomIntent);
      }
      waitingForNext = false;
   }, continuousDelay);
}

// Override sendCommand only once
if (!window.cpFinal) {
   const original = window.sendCommand;
   window.sendCommand = function(intent) {
      original(intent);

      // Only activate continuous mode when a GAP IS SELECTED
      const gapSelected = document.querySelector('input[name="continuousGap"]:checked');
      if (['SGSFirstPaada','SringeriPaada','ThirdPaada'].includes(intent) && gapSelected) {
         lastRandomIntent = intent;
         continuousPlayEnabled = true;
         continuousDelay = gapSelected.value == '30' ? 30000 : 60000;
         stopBtn.style.display = 'inline-block';
         audioPlayer.onended = scheduleNextRandom;
      }
      // If no gap selected ‚Üí do nothing (Stop button stays hidden)
   };
   window.cpFinal = true;
}

// Radio buttons ‚Äì control everything
document.querySelectorAll('input[name="continuousGap"]').forEach(radio => {
   radio.addEventListener('change', () => {
      const checked = document.querySelector('input[name="continuousGap"]:checked');
      if (checked) {
         continuousDelay = checked.value == '30' ? 30000 : 60000;
         stopBtn.style.display = 'inline-block';
         if (lastRandomIntent) {
            continuousPlayEnabled = true;
            audioPlayer.onended = scheduleNextRandom;
         }
      } else {
         // No gap selected
         continuousPlayEnabled = false;
         stopBtn.style.display = 'none';
         audioPlayer.onended = null;
         lastRandomIntent = null;
         waitingForNext = false;
      }
   });
});

// Stop button
stopBtn.onclick = () => {
   document.querySelectorAll('input[name="continuousGap"]').forEach(r => r.checked = false);
   continuousPlayEnabled = false;
   stopBtn.style.display = 'none';
   audioPlayer.onended = null;
   lastRandomIntent = null;
   waitingForNext = false;
};
         </script>
      </div>
   </body>
</html>
