<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Bhagavad Gita Bot</title>
      <meta name="description" content="Explore Bhagavad Gita shlokas in Telugu with SGS and Sringeri styles, featuring audio recitations and meanings.">
      <meta name="keywords" content="Bhagavad Gita, SGS, Sringeri, Telugu shlokas, audio recitation, spiritual app">
      <meta name="author" content="Dr. P. Udayabhaskar">
      <meta name="robots" content="index, follow">
      <link rel="canonical" href="https://pubsaroja.github.io/bhagavad-gita-bot/">
      <link href="https://fonts.googleapis.com/css2?family=Ramabhadra&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Kannada&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil&display=swap" rel="stylesheet">
      <!-- Intro.js for elegant guided tours -->
      <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
      <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
      <style>
         /* … (all your original CSS – unchanged) … */
         /* (truncated for brevity – the full CSS you posted is kept) */
      </style>
   </head>
   <body>
      <div class="theme-toggle" data-intro="Change the theme Light or Dark" data-title="Theme">
         <button id="themeLight" title="Light Theme" data-theme="light" class="active">Light</button>
         <button id="themeDark" title="Dark Theme" data-theme="dark">Dark</button>
      </div>
      <div class="page-frame">
         <h1>Srimad Bhagavad Gita</h1>
         <p>Listen, understand and memorize Bhagavad Gita shlokas</p>
         <div class="top-buttons" data-intro="Choose how you want to hear the shloka" data-title="Playback Options">
            <button class="sgs-button" onclick="sendCommand('SGSFirstPaada')" data-intro="Play only 1st Paada in SGS style" data-title="1st Paada (SGS)">1st Paada<br>Only</button>
            <button class="sringeri-button" onclick="sendCommand('SringeriPaada')" data-intro="Play 1st or 3rd Paada in Sringeri style" data-title="1st or 3rd Paada (Sringeri)">1st or 3rd Paada</button>
            <button class="third-paada-button" onclick="sendCommand('ThirdPaada')" data-intro="Play only 3rd Paada" data-title="3rd Paada Only">3rd Paada<br>Only</button>
         </div>
         <audio id="audioPlayer" controls data-intro="Use these controls to play, pause, or scrub through the audio." data-title="Audio Player"></audio>
         <div class="radio-group" data-intro="Pick the chanting style for display and playback" data-title="Chanting Style">
            <label>Style:</label>
            <input type="radio" name="style" value="sgs" id="sgs" onchange="updateTextboxVisibility()">
            <label for="sgs">SGS</label>
            <input type="radio" name="style" value="sringeri" id="sringeri" checked onchange="updateTextboxVisibility()">
            <label for="sringeri">Sringeri</label>
         </div>
         <div class="player-container">
            <button onclick="sendCommand('PreviousShloka')" data-intro="Go to previous shloka" data-title="Previous">Previous</button>
            <button onclick="sendCommand('FullShloka')" data-intro="Play the full shloka" data-title="Full Shloka">Full</button>
            <button onclick="sendCommand('NextFullShloka')" data-intro="Go to next shloka" data-title="Next">Next</button>
         </div>

         <!-- ==== LANGUAGE CHECKBOXES (your original markup) ==== -->
         <div class="radio-group language-group" data-intro="Select languages for shloka display" data-title="Languages">
            <label>Languages:</label>
            <input type="checkbox" name="language" id="telugu" value="te" checked> Telugu
            <input type="checkbox" name="language" id="devanagari" value="sa"> Devanagari
            <input type="checkbox" name="language" id="kannada" value="kn"> Kannada
            <input type="checkbox" name="language" id="tamil" value="ta"> Tamil
            <input type="checkbox" name="language" id="english" value="en"> English
         </div>

         <div class="textbox-container">
            <div>
               <div id="sgsLabel" class="textbox-label">SGS Style Shloka</div>
               <div id="sgsText" class="shloka-text hidden">Your Shloka will appear here.</div>
            </div>
            <div>
               <div id="sringeriLabel" class="textbox-label active">Sringeri Style Shloka</div>
               <div id="sringeriText" class="shloka-text visible">Your Shloka will appear here.</div>
            </div>
         </div>

         <!-- … (rest of your original HTML – unchanged) … -->
      </div>

      <!-- ==== ALL YOUR ORIGINAL <script> BLOCKS ==== -->
      <script>
         /* --------------------------------------------------------------
            ALL GLOBAL VARIABLES, loadFiles(), performSearch(), etc.
            (exactly the same code you posted – no changes)
         -------------------------------------------------------------- */

         // -----------------------------------------------------------------
         // *** ONLY NEW FUNCTION ADDED HERE ***
         // -----------------------------------------------------------------
         function getSelectedLanguages() {
             const checkboxes = document.querySelectorAll('input[name="language"]:checked');
             const selected = Array.from(checkboxes).map(cb => cb.value);
             // Default to Telugu if nothing is checked
             return selected.length > 0 ? selected : ['te'];
         }
         // -----------------------------------------------------------------

         // -----------------------------------------------------------------
         // (the rest of your original script – unchanged)
         // -----------------------------------------------------------------
         async function fetchCombinedShlokaText(chapter, verse, style) {
             try {
                 console.log(`fetchCombinedShlokaText called: chapter=${chapter}, verse=${verse}, style=${style}`);
                 const langs = getSelectedLanguages();               // <-- now defined
                 const texts = await Promise.all(langs.map(async (lang) => {
                     const styleCapitalized = style === 'sgs' ? 'SGS' : 'Sringeri';
                     const url = `https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_${lang}_${styleCapitalized}.txt`;
                     const response = await fetch(url);
                     if (!response.ok) {
                         throw new Error(`HTTP error: ${response.status}`);
                     }
                     const text = await response.text();

                     const lines = text.split('\n');
                     const key1 = `${chapter}.${verse}`;
                     const key2 = `${chapter}-${verse}`;

                     for (let i = 0; i < lines.length; i++) {
                         const line = lines[i].trim();
                         if (line.match(new RegExp(`^${key1}\\s+|^${key2}\\s+|^${key1}\\t|^${key2}\\t|^${key1}$|^${key2}$`))) {
                             let shlokaLines = [line.substring(line.indexOf(' ') + 1 || line.indexOf('\t') + 1 || line.length).trim()];
                             let j = i + 1;
                             while (j < lines.length && !lines[j].match(/^\d+[.-]\d+/)) {
                                 if (lines[j].trim()) {
                                     shlokaLines.push(lines[j].trim());
                                 }
                                 j++;
                             }
                             let shlokaText = shlokaLines.join('\n').trim();
                             if (!shlokaText) {
                                 console.warn(`Empty shloka text for ${chapter}.${verse}, lang=${lang}, style=${style}`);
                                 return `${chapter}.${verse} (${lang}): Shloka not found or empty`;
                             }
                             return `${chapter}.${verse} (${lang}):\n${shlokaText}`;
                         }
                     }

                     console.warn(`Shloka ${chapter}.${verse} not found in ${url}`);
                     return `${chapter}.${verse} (${lang}): Shloka not found`;
                 }));
                 return texts.join('\n\n---\n\n');
             } catch (error) {
                 console.error(`Error loading shloka ${chapter}.${verse}: ${error.message}`);
                 return `Error loading shloka ${chapter}.${verse}: ${error.message}`;
             }
         }

         /* … (all the rest of your original functions – unchanged) … */
         async function sendCommand(intent) { /* unchanged */ }
         function updateTextboxVisibility() { /* unchanged */ }
         /* … etc. … */

         // -----------------------------------------------------------------
         // Your existing DOMContentLoaded listeners (unchanged)
         // -----------------------------------------------------------------
         document.addEventListener('DOMContentLoaded', () => {
             loadFiles().then(() => {
                 updateTextboxVisibility();
                 adjustTextboxHeight();
             });

             document.getElementById('groupButton').onclick = () => {
                 window.open('https://pubsaroja.github.io/gita-voice-bot-web/GroupedShlokas.html', '_blank');
             };

             // Refresh shloka when language checkboxes change
             document.querySelectorAll('.language-group input[type="checkbox"]').forEach(checkbox => {
                 checkbox.addEventListener('change', async () => {
                     const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                     if (context && context.parameters && context.parameters.chapter && context.parameters.verse) {
                         const chapter = context.parameters.chapter;
                         const verse = context.parameters.verse;
                         const sgsShloka = await fetchCombinedShlokaText(chapter, verse, 'sgs');
                         const sringeriShloka = await fetchCombinedShlokaText(chapter, verse, 'sringeri');
                         document.getElementById('sgsText').innerText = sgsShloka;
                         document.getElementById('sringeriText').innerText = sringeriShloka;
                         adjustTextboxHeight();
                         updateTextboxVisibility();
                     }
                 });
             });
         });

         // Theme toggle (unchanged)
         const themeButtons = document.querySelectorAll('.theme-toggle button');
         const setTheme = (theme) => {
             document.documentElement.setAttribute('data-theme', theme);
             themeButtons.forEach(btn => {
                 btn.classList.toggle('active', btn.dataset.theme === theme);
             });
             localStorage.setItem('theme', theme);
             if (theme === 'system') {
                 const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                 document.documentElement.setAttribute('data-theme', systemTheme);
             }
         };
         const savedTheme = localStorage.getItem('theme') || 'light';
         setTheme(savedTheme);
         themeButtons.forEach(button => {
             button.addEventListener('click', () => setTheme(button.dataset.theme));
         });
         window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
             if (document.documentElement.getAttribute('data-theme') === 'system') setTheme('system');
         });

      </script>
   </body>
</html>
