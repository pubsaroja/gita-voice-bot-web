<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bhagavad Gita Voice Bot</title>
  <style>
    body { font-family: Georgia, serif; background: #fdfd96; color: #5a3d00; padding: 20px; }
    h1 { color: #b8860b; text-align: center; }
    .container { max-width: 900px; margin: auto; background: #fffef0; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin: 30px 0; }
    button { padding: 18px; font-size: 18px; background: #ffeb3b; border: 2px solid #f57f17; border-radius: 12px; cursor: pointer; transition: all 0.3s; }
    button:hover { background: #ffb300; transform: scale(1.05); }
    #output { margin: 25px 0; padding: 20px; background: white; border-left: 6px solid #ff9800; font-size: 20px; line-height: 1.8; min-height: 120px; border-radius: 8px; }
    #audioPlayer { width: 100%; margin: 20px 0; }
    .controls { margin: 20px 0; text-align: center; }
    select { padding: 10px; font-size: 16px; border-radius: 8px; }
    .checkbox-label { font-size: 18px; font-weight: bold; color: #d84315; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ॐ नमो भगवते वासुदेवाय</h1>
    <h2 style="text-align:center; color:#d84315;">Bhagavad Gita Voice Bot</h2>

    <div class="controls">
      <label class="checkbox-label">
        <input type="checkbox" id="continuousRandomPlay" style="transform:scale(1.5); margin-right:10px;">
        Continuous Random Play (60 sec gap)
      </label>
      <br><br>
      <label>Chanting Style: 
        <select id="styleSelect">
          <option value="sgs">SGS (Standard)</option>
          <option value="sringeri">Sringeri Sharada Peetham</option>
        </select>
      </label>
    </div>

    <div class="buttons">
      <button onclick="sendCommand('SGSFirstPaada')">First Pāda Only (SGS)</button>
      <button onclick="sendCommand('SringeriPaada')">1st or 3rd Pāda (Sringeri)</button>
      <button onclick="sendCommand('ThirdPaada')">Third Pāda Only</button>
      <button onclick="sendCommand('FullShloka')">Full Shloka (Auto Style)</button>
    </div>

    <div id="output">Tap any button above to receive a divine shloka...</div>
    <audio id="audioPlayer" controls preload="none"></audio>
  </div>

  <script>
    const baseUrl = "https://pubsaroja.github.io/gita-voice-bot-web";
    const audioPlayer = document.getElementById('audioPlayer');
    const outputDiv = document.getElementById('output');
    let lastRandomIntent = null;

    function getSelectedStyle() {
      return document.getElementById('styleSelect').value;
    }

    async function fetchCombinedShlokaText(chapter, verse) {
      const langs = ['Telugu', 'English', 'Sanskrit'];
      let result = `<strong>अध्याय ${chapter}, श्लोक ${verse}</strong><br/><br/>`;
      
      for (const lang of langs) {
        try {
          const response = await fetch(`${baseUrl}/texts/${lang}/Chapter ${chapter}/${verse}.txt?t=${Date.now()}`);
          if (response.ok) {
            const text = await response.text();
            result += `<strong>${lang}:</strong><br/>${text.trim().replace(/\n/g, '<br/>')}<br/><br/>`;
          }
        } catch (e) {
          console.warn(`Failed to load ${lang} text`, e);
        }
      }
      return result || `श्लोक ${chapter}.${verse} (text loading...)`;
    }

    async function fetchAudioUrl(chapter, verse, quarter = null, isFull = false) {
      try {
        const style = getSelectedStyle();
        let url = '';

        if (isFull) {
          const folder = style === 'sringeri' ? 'AudioFullSringeri' : 'AudioFullSGS';
          url = `${baseUrl}/${folder}/${chapter}.${verse}.mp3`;
        } else if (quarter === 'pada1') {
          url = `${baseUrl}/AQ4PaadasSGS/Chapter ${chapter}/${verse}.1.mp3`;
        } else if (quarter === 'pada3') {
          const folder = style === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
          url = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.3.mp3`;
        } else if (quarter === 'pada1_or_pada3') {
          const folder = style === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
          const pada = Math.random() < 0.5 ? '1' : '3';
          url = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.${pada}.mp3`;
        }

        const response = await fetch(url, { method: 'GET' });
        if (!response.ok) throw new Error(`Status ${response.status}`);
        const length = response.headers.get('content-length');
        if (length && parseInt(length) === 0) throw new Error('Empty file');

        return url;
      } catch (err) {
        console.error('Audio fetch failed:', err);
        return { error: 'Audio not available for this shloka' };
      }
    }

    async function sendCommand(intent) {
      outputDiv.innerHTML = 'ॐ Receiving divine message...';
      audioPlayer.src = '';
      audioPlayer.pause();

      const chapter = Math.floor(Math.random() * 18) + 1;
      const maxVerses = [0,47,72,43,42,29,47,30,28,34,42,55,20,35,27,20,24,28,78];
      const verse = Math.floor(Math.random() * maxVerses[chapter]) + 1;

      let quarter = null;
      let isFull = false;

      if (intent === 'SGSFirstPaada') quarter = 'pada1';
      else if (intent === 'SringeriPaada') quarter = 'pada1_or_pada3';
      else if (intent === 'ThirdPaada') quarter = 'pada3';
      else if (intent === 'FullShloka') isFull = true;

      const audioUrl = await fetchAudioUrl(chapter, verse, quarter, isFull);
      const text = await fetchCombinedShlokaText(chapter, verse);
      outputDiv.innerHTML = text;

      if (audioUrl && !audioUrl.error) {
        audioPlayer.src = audioUrl;
        audioPlayer.play().catch(e => console.error('Play failed:', e));
      } else {
        outputDiv.innerHTML += `<br/><span style="color:red;">Audio temporarily unavailable</span>`;
      }

      // === Continuous Random Play Logic ===
      audioPlayer.onended = null;
      if (['SGSFirstPaada','SringeriPaada','ThirdPaada','FullShloka'].includes(intent)) {
        const cb = document.getElementById('continuousRandomPlay');
        if (cb?.checked && audioUrl && !audioUrl.error) {
          lastRandomIntent = intent;
          audioPlayer.onended = async () => {
            await new Promise(r => setTimeout(r, 60000)); // 60 sec gap
            if (document.getElementById('continuousRandomPlay').checked && lastRandomIntent) {
              sendCommand(lastRandomIntent);
            }
          };
        } else {
          lastRandomIntent = null;
        }
      }
    }

    // Stop continuous play when unchecked
    document.getElementById('continuousRandomPlay').addEventListener('change', function() {
      if (!this.checked) {
        audioPlayer.onended = null;
        lastRandomIntent = null;
      }
    });
  </script>
</body>
</html>
