<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bhagavad Gita Bot</title>

  <link href="https://fonts.googleapis.com/css2?family=Ramabhadra&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Outfit', sans-serif;
      text-align: center;
      margin: 20px;
      background-color: #FFFFFF;
    }

    h1 {
      color: #2c3e50;
      font-size: 1.5em;
    }

    h2 {
      color: #34495e;
      font-size: 1em;
      margin-top: 10px;
    }

    /* Top buttons (SGS & Sringeri) */
    .top-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px auto;
    }

    .top-buttons button {
      width: 120px;
      height: 120px;
      border-radius: 25%;
      border: none;
      background-color: #357EC7;
      color: white;
      font-size: 20px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .top-buttons button:hover {
      background-color: #1e40af;
    }

    /* Player container with arrows + audio */
    .player-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 20px auto;
      max-width: 600px;
    }

    #audioPlayer {
      flex: 1;
      min-width: 120px;
      max-width: 300px;
      height: 35px;
    }

    /* Navigation arrows */
    .icon-btn {
      background: #357EC7;
      border: none;
      border-radius: 50%;
      padding: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 45px;
      height: 45px;
      flex-shrink: 0;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    .icon-btn svg {
      width: 24px;
      height: 24px;
    }

    .icon-btn:hover {
      background: #1e40af;
      transform: scale(1.1);
    }

    /* Text-only rectangular buttons */
    .rect-btn {
      background-color: #357EC7;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.3s ease;
      min-width: 150px;
      max-width: 150px;
    }

    .rect-btn:hover {
      background-color: #1e40af;
    }

    /* Responsive tweaks */
    @media (max-width: 600px) {
      .top-buttons {
        gap: 5px;
      }

      .icon-btn {
        width: 40px;
        height: 40px;
        padding: 6px;
      }

      .icon-btn svg {
        width: 20px;
        height: 20px;
      }

      #audioPlayer {
        width: 100%;
        min-width: 100px;
        height: 30px;
      }

      .rect-btn {
        min-width: 120px;
        max-width: 120px;
        font-size: 0.9em;
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <h1>Bhagavad Gita Bot</h1>
  <p>Listen, understand and memorize Bhagavad Gita shlokas</p>

  <!-- Top buttons -->
  <div class="top-buttons">
    <button onclick="sendCommand('SGSFirstPaada')">SGS<br>(1st Paada)</button>
    <button onclick="sendCommand('SringeriPaada')">Sringeri<br>(1st or 3rd Paada)</button>
  </div>

  <!-- Audio + Nav arrows -->
  <div class="player-container">
    <button class="icon-btn" onclick="sendCommand('PreviousShloka')" aria-label="Previous">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
        <path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
      </svg>
    </button>

    <audio id="audioPlayer" controls></audio>

    <button class="icon-btn" onclick="sendCommand('NextShloka')" aria-label="Next">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
        <path d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"/>
      </svg>
    </button>
  </div>

  <!-- Rectangular text buttons -->
  <div class="player-container">
    <button class="rect-btn" onclick="sendCommand('FullShloka')">Full Shloka</button>
    <button class="rect-btn" id="meaningsButton" onclick="handleMeanings()">Meanings</button>
    <button class="rect-btn" onclick="showVerseTable()">Select Shloka</button>
    <button class="rect-btn" id="instructionsButton" onclick="toggleInstructions()">Instructions</button>
  </div>

  <!-- Rest of your dropdowns, radios, verse modal, credits etc. remain as in your code -->
</body>
</html>


      <script>
         console.log('Script loaded at', new Date('2025-08-17T12:18:00+05:30').toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }));
         
         const baseUrl = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main';
         const verseCounts = {
             1: 47, 2: 72, 3: 43, 4: 42, 5: 29, 6: 47, 7: 30, 8: 28,
             9: 34, 10: 42, 11: 55, 12: 20, 13: 34, 14: 27, 15: 20,
             16: 24, 17: 28, 18: 78
         };
         
         let isContinuousPlaying = false;
         let continuousPlayInterval = null;
         let isInstructionsVisible = false;
         let previousText = '';
         let isShowingMeanings = false;
         let sessionId = 'session-' + Math.random().toString(36).substr(2, 9);
         let currentContext = [];
         
         function initialize() {
             try {
                 console.log('Initializing Bhagavad Gita Bot');
                 localStorage.removeItem('gitaSessionId');
                 localStorage.removeItem('gitaContext');
                 console.log('Cleared localStorage (gitaSessionId, gitaContext)');
                 localStorage.setItem('gitaSessionId', sessionId);
                 adjustTextboxHeight();
                 updateTextboxVisibility();
             } catch (error) {
                 console.error('Initialization error:', error);
             }
         }
         
         function toggleInstructions() {
             try {
                 console.log('toggleInstructions called');
                 isContinuousPlaying = false;
                 const instructionsButton = document.getElementById('instructionsButton');
                 const style = getSelectedStyle();
                 const activeTextbox = style === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                 
                 if (!isInstructionsVisible) {
                     previousText = activeTextbox.innerText;
                     fetch('https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/instructions.txt')
                         .then(response => {
                             if (!response.ok) throw new Error('Failed to fetch instructions');
                             return response.text();
                         })
                         .then(text => {
                             activeTextbox.innerHTML = text.replace(/\n/g, '<br>');
                             instructionsButton.textContent = 'Close Instructions';
                             isInstructionsVisible = true;
                             adjustTextboxHeight();
                             updateTextboxVisibility();
                         })
                         .catch(error => {
                             console.error('Error fetching instructions:', error);
                             activeTextbox.innerText = `Error loading instructions: ${error.message}`;
                             adjustTextboxHeight();
                             updateTextboxVisibility();
                         });
                 } else {
                     activeTextbox.innerText = previousText || 'Your Shloka will appear here.';
                     instructionsButton.textContent = 'Instructions';
                     isInstructionsVisible = false;
                     adjustTextboxHeight();
                     updateTextboxVisibility();
                 }
             } catch (error) {
                 console.error('Error in toggleInstructions:', error);
                 const activeTextbox = getSelectedStyle() === 'sgs' ? document.getElementById('sgsText') : document.getElementById('sringeriText');
                 activeTextbox.innerText = `Error in instructions: ${error.message}`;
                 adjustTextboxHeight();
             }
         }
         
         function adjustTextboxHeight() {
             try {
                 console.log('adjustTextboxHeight called');
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 [sgsText, sringeriText].forEach(textbox => {
                     textbox.style.height = 'auto';
                     const scrollHeight = textbox.scrollHeight;
                     textbox.style.height = `${scrollHeight}px`;
                     if (textbox.innerText.includes('\n') || textbox.innerHTML.includes('<br>')) {
                         textbox.classList.add('multiline');
                     } else {
                         textbox.classList.remove('multiline');
                     }
                     console.log(`adjustTextboxHeight: ${textbox.id}, scrollHeight: ${scrollHeight}px, multiline: ${textbox.classList.contains('multiline')}`);
                 });
             } catch (error) {
                 console.error('Error in adjustTextboxHeight:', error);
             }
         }
         
         async function fetchAudioUrl(chapter, verse, quarter = null, isFullForQuarter = false) {
             try {
                 console.log(`fetchAudioUrl called: chapter=${chapter}, verse=${verse}, quarter=${quarter}, isFullForQuarter=${isFullForQuarter}`);
                 const style = getSelectedStyle();
                 const key = `${chapter}.${verse}`;
                 let audioUrl;
                 let errorMessage = '';
         
                 const tryUrl = async (url, type) => {
                     try {
                         console.log(`fetchAudioUrl: Attempting ${type}: ${url}`);
                         const response = await fetch(url, { method: 'HEAD', mode: 'cors' });
                         if (!response.ok) {
                             throw new Error(`${type} inaccessible: HTTP ${response.status}`);
                         }
                         console.log(`fetchAudioUrl: Successfully fetched ${type}: ${url}`);
                         return url;
                     } catch (error) {
                         console.log(`fetchAudioUrl: Error for ${type}: ${error.message}`);
                         return null;
                     }
                 };
         
                 if (isFullForQuarter) {
                     audioUrl = style === 'sringeri' 
                         ? await tryUrl(`${baseUrl}/AudioFullSringeri/${key}.mp3`, `AudioFullSringeri/${key}.mp3`)
                         : await tryUrl(`${baseUrl}/AudioFullSGS/${key}.mp3`, `AudioFullSGS/${key}.mp3`);
                     if (!audioUrl) {
                         errorMessage = `Full audio not found in ${style === 'sringeri' ? 'AudioFullSringeri' : 'AudioFullSGS'} for ${key}`;
                     }
                 } else if (quarter === 'pada1') {
                     audioUrl = await tryUrl(`${baseUrl}/AQ4PaadasSGS/Chapter ${chapter}/${verse}.1.mp3`, `AQ4PaadasSGS/Chapter ${chapter}/${verse}.1.mp3`);
                     if (!audioUrl) {
                         errorMessage = `Audio (Pada1) not found at AQ4PaadasSGS/Chapter ${chapter}/${verse}.1.mp3`;
                     }
                 } else if (quarter === 'pada1_or_pada3') {
                     const folder = style === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
                     const randomPada = Math.random() < 0.5 ? '1' : '3';
                     audioUrl = await tryUrl(`${baseUrl}/${folder}/Chapter ${chapter}/${verse}.${randomPada}.mp3`, `${folder}/Chapter ${chapter}/${verse}.${randomPada}.mp3`);
                     if (!audioUrl) {
                         audioUrl = await tryUrl(`${baseUrl}/${folder}/Chapter ${chapter}/${verse}.${randomPada === '1' ? '3' : '1'}.mp3`, `${folder}/Chapter ${chapter}/${verse}.${randomPada === '1' ? '3' : '1'}.mp3`);
                     }
                     if (!audioUrl) {
                         errorMessage = `Quarter audio (Pada1 or Pada3) not found in ${folder}/Chapter ${chapter} for ${key}`;
                     }
                 } else {
                     audioUrl = style === 'sringeri' 
                         ? await tryUrl(`${baseUrl}/AudioFullSringeri/${key}.mp3`, `AudioFullSringeri/${key}.mp3`)
                         : await tryUrl(`${baseUrl}/AudioFullSGS/${key}.mp3`, `AudioFullSGS/${key}.mp3`);
                     if (!audioUrl) {
                         errorMessage = `Full audio not found in ${style === 'sringeri' ? 'AudioFullSringeri' : 'AudioFullSGS'} for ${key}`;
                     }
                 }
         
                 if (!audioUrl) {
                     throw new Error(errorMessage || `No audio available for ${key}`);
                 }
         
                 console.log(`fetchAudioUrl: Using audio for ${key}: ${audioUrl}`);
                 return audioUrl;
             } catch (error) {
                 console.error(`fetchAudioUrl: Error for ${chapter}.${verse}: ${error.message}`);
                 return { error: `No audio available for ${chapter}.${verse}: ${error.message}` };
             }
         }
         
         async function fetchShlokaText(chapter, verse, style) {
             try {
                 console.log(`fetchShlokaText called: chapter=${chapter}, verse=${verse}, style=${style}`);
                 const url = style === 'sgs'
                     ? 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG Telugu with Uvacha2.txt'
                     : 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/BG_Sringeri.txt';
                 const response = await fetch(url);
                 if (!response.ok) {
                     throw new Error(`HTTP error: ${response.status}`);
                 }
                 const text = await response.text();
                 
                 const lines = text.split('\n');
                 const key1 = `${chapter}.${verse}`;
                 const key2 = `${chapter}-${verse}`;
                 
                 for (let i = 0; i < lines.length; i++) {
                     const line = lines[i].trim();
                     if (line.match(new RegExp(`^${key1}\\s+|^${key2}\\s+|^${key1}\\t|^${key2}\\t|^${key1}$|^${key2}$`))) {
                         let shlokaLines = [line.substring(line.indexOf(' ') + 1 || line.indexOf('\t') + 1 || line.length).trim()];
                         let j = i + 1;
                         while (j < lines.length && !lines[j].match(/^\d+[.-]\d+/)) {
                             if (lines[j].trim()) {
                                 shlokaLines.push(lines[j].trim());
                             }
                             j++;
                         }
                         let shlokaText = shlokaLines.join('\n').trim();
                         if (!shlokaText) {
                             console.warn(`Empty shloka text for ${chapter}.${verse}, style=${style}`);
                             return `Shloka ${chapter}.${verse} not found or empty`;
                         }
                         return `${chapter}.${verse} ${shlokaText}`;
                     }
                 }
         
                 console.warn(`Shloka ${chapter}.${verse} not found in ${url}`);
                 return `Shloka ${chapter}.${verse} not found`;
             } catch (error) {
                 console.error(`Error loading shloka ${chapter}.${verse}: ${error.message}`);
                 return `Error loading shloka ${chapter}.${verse}: ${error.message}`;
             }
         }
         
         async function fetchShlokaMeaning(chapter, verse) {
             try {
                 console.log(`fetchShlokaMeaning called: chapter=${chapter}, verse=${verse}`);
                 const url = 'https://raw.githubusercontent.com/pubsaroja/bhagavad-gita-bot/refs/heads/main/meanings.txt';
                 const response = await fetch(url);
                 if (!response.ok) {
                     throw new Error(`HTTP error: ${response.status}`);
                 }
                 const data = await response.json();
                 const key = `${chapter}.${verse}`;
                 if (data[key] && data[key].అర్థము) {
                     return `${chapter}.${verse} Meaning:\n${data[key].అర్థము}`;
                 } else {
                     return `Meaning for ${chapter}.${verse} not found`;
                 }
             } catch (error) {
                 console.error(`Error loading meaning for ${chapter}.${verse}: ${error.message}`);
                 return `Error loading meaning for ${chapter}.${verse}: ${error.message}`;
             }
         }
         
         async function handleContinuousPlay(selectElement) {
             try {
                 console.log('handleContinuousPlay called');
                 const chapter = parseInt(selectElement.value);
                 if (!chapter) {
                     console.log('No chapter selected');
                     return;
                 }
         
                 isInstructionsVisible = false;
                 document.getElementById('instructionsButton').textContent = 'Instructions';
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 const audioPlayer = document.getElementById('audioPlayer');
                 isContinuousPlaying = true;
         
                 if (continuousPlayInterval) {
                     clearInterval(continuousPlayInterval);
                 }
         
                 let verse = 1;
                 const playNextVerse = async () => {
                     if (!isContinuousPlaying || verse > verseCounts[chapter]) {
                         isContinuousPlaying = false;
                         selectElement.selectedIndex = 0;
                         audioPlayer.src = '';
                         console.log('Continuous play stopped');
                         return;
                     }
         
                     currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                     currentContext.push({
                         name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                         lifespanCount: 5,
                         parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: getSelectedStyle(), showingMeaning: false }
                     });
                     localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                     console.log(`handleContinuousPlay: Updated context for ${chapter}.${verse}`);
         
                     const [sgsShloka, sringeriShloka] = await Promise.all([
                         fetchShlokaText(chapter, verse, 'sgs'),
                         fetchShlokaText(chapter, verse, 'sringeri')
                     ]);
                     sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                     sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                     adjustTextboxHeight();
                     updateTextboxVisibility();
         
                     const audioUrl = getSelectedStyle() === 'sringeri' 
                         ? `${baseUrl}/AudioFullSringeri/${chapter}.${verse}.mp3`
                         : `${baseUrl}/AudioFullSGS/${chapter}.${verse}.mp3`;
                     audioPlayer.src = audioUrl;
                     try {
                         audioPlayer.load();
                         await audioPlayer.play();
                     } catch (error) {
                         const errorText = `${sgsText.innerText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                         sgsText.innerText = errorText;
                         sringeriText.innerText = errorText;
                         adjustTextboxHeight();
                         console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                     }
         
                     audioPlayer.onended = () => {
                         verse++;
                         playNextVerse();
                     };
                 };
         
                 await playNextVerse();
                 selectElement.selectedIndex = 0;
             } catch (error) {
                 console.error('Error in handleContinuousPlay:', error);
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 sgsText.innerText = `Error in continuous play: ${error.message}`;
                 sringeriText.innerText = `Error in continuous play: ${error.message}`;
                 adjustTextboxHeight();
             }
         }
         
         function showVerseTable() {
             try {
                 console.log('showVerseTable called');
                 isInstructionsVisible = false;
                 document.getElementById('instructionsButton').textContent = 'Instructions';
                 const modal = document.getElementById('verseTableModal');
                 const chapterSelect = document.getElementById('chapterTableSelect');
                 chapterSelect.value = '';
                 updateVerseGrid();
                 modal.style.display = 'flex';
             } catch (error) {
                 console.error('Error in showVerseTable:', error);
             }
         }
         
         function updateVerseGrid() {
             try {
                 console.log('updateVerseGrid called');
                 const chapter = parseInt(document.getElementById('chapterTableSelect').value);
                 const content = document.getElementById('verseTableContent');
                 content.innerHTML = '';
         
                 if (chapter) {
                     const verseGrid = document.createElement('div');
                     verseGrid.className = 'verse-grid';
                     for (let verse = 1; verse <= verseCounts[chapter]; verse++) {
                         const verseButton = document.createElement('div');
                         verseButton.className = 'verse-button';
                         verseButton.textContent = `${chapter}.${verse}`;
                         verseButton.onclick = () => selectVerse(chapter, verse);
                         verseGrid.appendChild(verseButton);
                     }
                     content.appendChild(verseGrid);
                 }
             } catch (error) {
                 console.error('Error in updateVerseGrid:', error);
             }
         }
         
         function closeVerseTable() {
             try {
                 console.log('closeVerseTable called');
                 document.getElementById('verseTableModal').style.display = 'none';
             } catch (error) {
                 console.error('Error in closeVerseTable:', error);
             }
         }
         
         async function selectVerse(chapter, verse) {
             try {
                 console.log(`selectVerse called: chapter=${chapter}, verse=${verse}`);
                 isContinuousPlaying = false;
                 isInstructionsVisible = false;
                 document.getElementById('instructionsButton').textContent = 'Instructions';
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                 currentContext.push({
                     name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                     lifespanCount: 5,
                     parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: getSelectedStyle(), showingMeaning: false }
                 });
                 localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                 console.log('selectVerse: Updated context:', JSON.stringify(currentContext));
                 
                 const [sgsShloka, sringeriShloka] = await Promise.all([
                     fetchShlokaText(chapter, verse, 'sgs'),
                     fetchShlokaText(chapter, verse, 'sringeri')
                 ]);
                 sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                 sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                 adjustTextboxHeight();
                 
                 const audioUrl = await fetchAudioUrl(chapter, verse);
                 const audioPlayer = document.getElementById('audioPlayer');
                 audioPlayer.src = audioUrl;
                 try {
                     audioPlayer.load();
                     await audioPlayer.play();
                 } catch (error) {
                     const errorText = `${sgsText.innerText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                     sgsText.innerText = errorText;
                     sringeriText.innerText = errorText;
                     adjustTextboxHeight();
                     console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                 }
                 
                 updateTextboxVisibility();
                 closeVerseTable();
             } catch (error) {
                 console.error('Error in selectVerse:', error);
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 sgsText.innerText = `Error selecting verse: ${error.message}`;
                 sringeriText.innerText = `Error selecting verse: ${error.message}`;
                 adjustTextboxHeight();
             }
         }
         
         async function handlePreviousShloka() {
             try {
                 console.log('handlePreviousShloka called');
                 isContinuousPlaying = false;
                 isInstructionsVisible = false;
                 document.getElementById('instructionsButton').textContent = 'Instructions';
                 const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 if (context && context.parameters && Number.isInteger(context.parameters.chapter) && Number.isInteger(context.parameters.verse)) {
                     let chapter = Math.floor(context.parameters.chapter);
                     let verse = Math.floor(context.parameters.verse) - 1;
                     if (verse < 1) {
                         chapter -= 1;
                         if (chapter < 1) {
                             chapter = 1;
                             verse = 1;
                         } else {
                             verse = verseCounts[chapter];
                         }
                     }
                     currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                     currentContext.push({
                         name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                         lifespanCount: 5,
                         parameters: { chapter: parseInt(chapter), verse: parseInt(verse), style: getSelectedStyle(), showingMeaning: false }
                     });
                     localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                     console.log('handlePreviousShloka: Updated context:', JSON.stringify(currentContext));
                     
                     const [sgsShloka, sringeriShloka] = await Promise.all([
                         fetchShlokaText(chapter, verse, 'sgs'),
                         fetchShlokaText(chapter, verse, 'sringeri')
                     ]);
                     sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                     sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                     adjustTextboxHeight();
                     
                     const audioUrl = getSelectedStyle() === 'sringeri' 
                         ? `${baseUrl}/AudioFullSringeri/${chapter}.${verse}.mp3`
                         : `${baseUrl}/AudioFullSGS/${chapter}.${verse}.mp3`;
                     const audioPlayer = document.getElementById('audioPlayer');
                     audioPlayer.src = audioUrl;
                     audioPlayer.load(); // No autoplay
                     
                     updateTextboxVisibility();
                 } else {
                     sgsText.innerText = 'Please select a Shloka first';
                     sringeriText.innerText = 'Please select a Shloka first';
                     adjustTextboxHeight();
                     updateTextboxVisibility();
                 }
             } catch (error) {
                 console.error('Error in handlePreviousShloka:', error);
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 sgsText.innerText = `Error in previous shloka: ${error.message}`;
                 sringeriText.innerText = `Error in previous shloka: ${error.message}`;
                 adjustTextboxHeight();
             }
         }
         
         async function handleMeanings() {
             try {
                 console.log('handleMeanings called');
                 isContinuousPlaying = false;
                 isInstructionsVisible = false;
                 const meaningsButton = document.getElementById('meaningsButton');
                 const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 if (context && context.parameters && Number.isInteger(context.parameters.chapter) && Number.isInteger(context.parameters.verse)) {
                     const chapter = Math.floor(context.parameters.chapter);
                     const verse = Math.floor(context.parameters.verse);
                     
                     if (!isShowingMeanings) {
                         previousText = sgsText.innerText;
                         const meaningText = await fetchShlokaMeaning(chapter, verse);
                         sgsText.innerText = meaningText || `Meaning for ${chapter}.${verse} not found`;
                         sringeriText.innerText = meaningText || `Meaning for ${chapter}.${verse} not found`;
                         meaningsButton.textContent = 'Close Meanings';
                         isShowingMeanings = true;
                     } else {
                         sgsText.innerText = previousText || 'Your Shloka will appear here.';
                         sringeriText.innerText = previousText || 'Your Shloka will appear here.';
                         meaningsButton.textContent = 'Meanings';
                         isShowingMeanings = false;
                     }
                     adjustTextboxHeight();
                     updateTextboxVisibility();
                 } else {
                     sgsText.innerText = 'Please select a Shloka first';
                     sringeriText.innerText = 'Please select a Shloka first';
                     adjustTextboxHeight();
                     updateTextboxVisibility();
                 }
             } catch (error) {
                 console.error('Error in handleMeanings:', error);
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 sgsText.innerText = `Error fetching meanings: ${error.message}`;
                 sringeriText.innerText = `Error fetching meanings: ${error.message}`;
                 adjustTextboxHeight();
             }
         }
         
         async function handleChapterSelect(selectElement) {
             try {
                 console.log('handleChapterSelect called');
                 isContinuousPlaying = false;
                 isInstructionsVisible = false;
                 document.getElementById('instructionsButton').textContent = 'Instructions';
                 const chapter = parseInt(selectElement.value);
                 if (!chapter) {
                     console.log('No chapter selected');
                     return;
                 }
         
                 const verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                 currentContext.push({
                     name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                     lifespanCount: 5,
                     parameters: { chapter: chapter, verse: verse, style: getSelectedStyle(), showingMeaning: false }
                 });
                 localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                 console.log('handleChapterSelect: Updated context:', JSON.stringify(currentContext));
         
                 const [sgsShloka, sringeriShloka] = await Promise.all([
                     fetchShlokaText(chapter, verse, 'sgs'),
                     fetchShlokaText(chapter, verse, 'sringeri')
                 ]);
                 sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                 sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                 adjustTextboxHeight();
         
                 const folder = getSelectedStyle() === 'sringeri' ? 'AQ4PaadasSringeri' : 'AQ4PaadasSGS';
                 const randomPada = Math.random() < 0.5 ? '1' : '3';
                 const audioUrl = `${baseUrl}/${folder}/Chapter ${chapter}/${verse}.${randomPada}.mp3`;
                 const audioPlayer = document.getElementById('audioPlayer');
                 audioPlayer.src = audioUrl;
                 try {
                     audioPlayer.load();
                     await audioPlayer.play();
                 } catch (error) {
                     const errorText = `${sgsText.innerText}\nError playing audio for ${chapter}.${verse}: ${error.message}`;
                     sgsText.innerText = errorText;
                     sringeriText.innerText = errorText;
                     adjustTextboxHeight();
                     console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                 }
         
                 updateTextboxVisibility();
                 selectElement.selectedIndex = 0;
             } catch (error) {
                 console.error('Error in handleChapterSelect:', error);
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 sgsText.innerText = `Error selecting random shloka: ${error.message}`;
                 sringeriText.innerText = `Error selecting random shloka: ${error.message}`;
                 adjustTextboxHeight();
                 updateTextboxVisibility();
             }
         }
         
         function getSelectedStyle() {
             try {
                 const style = document.querySelector('input[name="style"]:checked').value;
                 console.log(`getSelectedStyle: ${style}`);
                 return style;
             } catch (error) {
                 console.error('Error in getSelectedStyle:', error);
                 return 'sringeri'; // Default to Sringeri style if error occurs
             }
         }
         
         function setSelectedStyle(style) {
             try {
                 if (style === 'sgs') {
                     document.getElementById('sgs').checked = true;
                 } else {
                     document.getElementById('sringeri').checked = true;
                 }
                 updateTextboxVisibility();
                 console.log(`setSelectedStyle: Set style to ${style}`);
             } catch (error) {
                 console.error('Error in setSelectedStyle:', error);
             }
         }
         
         async function updateTextboxVisibility() {
             try {
                 console.log('updateTextboxVisibility called');
                 const style = getSelectedStyle();
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 const sgsLabel = document.getElementById('sgsLabel');
                 const sringeriLabel = document.getElementById('sringeriLabel');
         
                 if (style === 'sgs') {
                     sgsText.classList.add('active');
                     sgsLabel.classList.add('active');
                     sringeriText.classList.remove('active');
                     sringeriLabel.classList.remove('active');
                 } else {
                     sgsText.classList.remove('active');
                     sgsLabel.classList.remove('active');
                     sringeriText.classList.add('active');
                     sringeriLabel.classList.add('active');
                 }
                 adjustTextboxHeight();
             } catch (error) {
                 console.error('Error in updateTextboxVisibility:', error);
             }
         }
         
         async function sendCommand(intent) {
             try {
                 console.log(`sendCommand called: intent=${intent}`);
                 isContinuousPlaying = false;
                 isInstructionsVisible = false;
                 isShowingMeanings = false;
                 document.getElementById('instructionsButton').textContent = 'Instructions';
                 document.getElementById('meaningsButton').textContent = 'Meanings';
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 const audioPlayer = document.getElementById('audioPlayer');
                 let chapter, verse, quarter, isFullForQuarter = false, autoplay = true;
         
                 if (intent === 'SGSFirstPaada') {
                     setSelectedStyle('sgs');
                     quarter = 'pada1';
                     chapter = Math.floor(Math.random() * 18) + 1;
                     verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                     autoplay = true;
                 } else if (intent === 'SringeriPaada') {
                     quarter = 'pada1_or_pada3';
                     chapter = Math.floor(Math.random() * 18) + 1;
                     verse = Math.floor(Math.random() * verseCounts[chapter]) + 1;
                     autoplay = true;
                 } else if (intent === 'NextFullShloka') {
                     const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                     chapter = context ? Math.floor(context.parameters.chapter) : 1;
                     verse = context ? Math.floor(context.parameters.verse) + 1 : 1;
                     if (verse > verseCounts[chapter]) {
                         chapter++;
                         verse = 1;
                         if (chapter > 18) {
                             chapter = 1;
                         }
                     }
                     autoplay = false;
                 } else if (intent === 'PreviousShloka') {
                     const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                     chapter = context ? Math.floor(context.parameters.chapter) : 1;
                     verse = context ? Math.floor(context.parameters.verse) - 1 : 1;
                     if (verse < 1) {
                         chapter--;
                         if (chapter < 1) {
                             chapter = 18;
                         }
                         verse = verseCounts[chapter];
                     }
                     autoplay = false;
                 } else if (intent === 'FullShloka') {
                     const context = currentContext.find(ctx => ctx.name.includes('shloka-context'));
                     if (!context || !context.parameters || !Number.isInteger(context.parameters.chapter) || !Number.isInteger(context.parameters.verse)) {
                         chapter = 1;
                         verse = 1;
                     } else {
                         chapter = Math.floor(context.parameters.chapter);
                         verse = Math.floor(context.parameters.verse);
                     }
                     isFullForQuarter = true;
                     autoplay = true;
                 }
         
                 currentContext = currentContext.filter(ctx => !ctx.name.includes('shloka-context'));
                 currentContext.push({
                     name: `projects/gita-voice-bot/agent/sessions/${sessionId}/contexts/shloka-context`,
                     lifespanCount: 5,
                     parameters: { chapter: chapter, verse: verse, style: getSelectedStyle(), showingMeaning: false }
                 });
                 localStorage.setItem('gitaContext', JSON.stringify(currentContext));
                 console.log('sendCommand: Updated context:', JSON.stringify(currentContext));
         
                 const [sgsShloka, sringeriShloka] = await Promise.all([
                     fetchShlokaText(chapter, verse, 'sgs'),
                     fetchShlokaText(chapter, verse, 'sringeri')
                 ]);
                 sgsText.innerText = sgsShloka || `Shloka ${chapter}.${verse} not found`;
                 sringeriText.innerText = sringeriShloka || `Shloka ${chapter}.${verse} not found`;
                 adjustTextboxHeight();
         
                 const audioUrl = await fetchAudioUrl(chapter, verse, quarter, isFullForQuarter);
                 if (audioUrl && audioUrl.error) {
                     sgsText.innerText = `${sgsText.innerText}\n${audioUrl.error}`;
                     sringeriText.innerText = `${sringeriText.innerText}\n${audioUrl.error}`;
                     adjustTextboxHeight();
                     return;
                 }
                 audioPlayer.src = audioUrl;
                 audioPlayer.load();
                 if (autoplay) {
                     await audioPlayer.play().catch(error => {
                         console.error(`Error playing audio for ${chapter}.${verse}: ${error.message}`);
                         sgsText.innerText = `${sgsText.innerText}\nError playing audio: ${error.message}`;
                         sringeriText.innerText = `${sringeriText.innerText}\nError playing audio: ${error.message}`;
                         adjustTextboxHeight();
                     });
                 }
                 updateTextboxVisibility();
             } catch (error) {
                 console.error('Error in sendCommand:', error);
                 const sgsText = document.getElementById('sgsText');
                 const sringeriText = document.getElementById('sringeriText');
                 sgsText.innerText = `Error: ${error.message}`;
                 sringeriText.innerText = `Error: ${error.message}`;
                 adjustTextboxHeight();
             }
         }
         
         initialize();
      </script>
   </body>
</html>

